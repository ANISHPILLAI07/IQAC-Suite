{% extends "base.html" %}
{% load static %}

{% block title %}Sidebar Permissions Management - CHRIST University{% endblock %}

{% block head_extra %}
  {# Reuse the master-data visual language #}
  <link rel="stylesheet" href="{% static 'core/css/admin_master_data.css' %}?v=3.0">
  <style>
    /* ----- Page shell (reuses admin_master_data.css primitives) ----- */
    .permissions-page .topbar h1{margin:0;font-size:28px;font-weight:800;color:var(--ink)}
    .permissions-page .controls-container{position:sticky;top:0;z-index:40}

    /* Wrap the two lists + action column */
    .permissions-page .panel-grid{
      display:grid;grid-template-columns:1fr auto 1fr;gap:16px;margin:8px 0
    }
    @media (max-width: 980px){ .permissions-page .panel-grid{grid-template-columns:1fr} }

    /* Panels look/feel like cards in master page */
    .permissions-page .panel{
      background:var(--surf);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);
      display:flex;flex-direction:column;min-height:320px
    }
    .permissions-page .panel .panel-head{
      background:linear-gradient(90deg,var(--primary),var(--primary-dark));color:#fff;
      padding:10px 12px;border-top-left-radius:16px;border-top-right-radius:16px;
      display:flex;justify-content:space-between;align-items:center;font-weight:800;text-transform:uppercase;font-size:12px;letter-spacing:.5px
    }
    .permissions-page .panel .panel-head .count{background:rgba(255,255,255,.25);padding:2px 8px;border-radius:999px;font-weight:800}

    /* Lists: only these scroll, nothing else */
    .permissions-page .list{
      overflow:auto; padding:6px 8px;
      max-height:calc(100vh - 300px);   /* fills viewport; keeps header/toolbar visible */
    }
    @media (max-width: 980px){ .permissions-page .list{max-height:calc(100vh - 360px)} }

    .permissions-page .item{
      display:flex;gap:10px;align-items:flex-start;padding:10px;border:1px solid var(--border);
      border-radius:12px;background:#fff;margin:6px 0;cursor:pointer;transition:.15s
    }
    .permissions-page .item:hover{box-shadow:var(--shadow)}
    .permissions-page .item.selected{background:#eef4fd;border-color:var(--primary)}
    .permissions-page .item .chk{width:16px;height:16px;margin-top:2px;accent-color:var(--primary)}
    .permissions-page .item .name{font-weight:800;color:var(--ink);font-size:14px}
    .permissions-page .item .desc{font-size:12px;color:var(--muted);margin-top:2px}

    /* Middle column actions styled like master buttons */
    .permissions-page .actions-col{
      display:flex;flex-direction:column;gap:8px;align-items:stretch;justify-content:center
    }
    .permissions-page .actions-col .btn{border-radius:10px}
    .permissions-page .actions-col .btn-secondary{background:var(--muted);border-color:var(--muted);color:#fff}

    /* Stats strip compact */
    .permissions-page .stats{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px;margin:8px 0
    }
    .permissions-page .stat{
      background:var(--surf);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);
      padding:10px;text-align:center
    }
    .permissions-page .stat .num{font-weight:900;color:var(--primary);font-size:18px}
    .permissions-page .stat .lbl{color:var(--muted);font-size:12px}

    /* Save bar */
    .permissions-page .savebar{
      display:flex;justify-content:space-between;align-items:center;margin-top:8px;padding-top:10px;border-top:1px solid var(--border)
    }
    .permissions-page .savebar .save-btn{border-radius:10px}

    /* Tiny helpers */
    .permissions-page .search-bar input{min-width:220px}
    .permissions-page .empty{padding:24px;color:var(--muted);text-align:center}
  </style>
{% endblock %}

{% block content %}
<div class="ems-dashboard mdm-page permissions-page">
  <!-- Heading (black, compact) -->
  <header class="topbar">
    <div><h1>Sidebar Permissions Management</h1></div>
  </header>

  <!-- Sticky controls bar (uses master-data filters & btns) -->
  <div class="controls-container">
    <div class="filters-left">
      <label class="filter">
        <span>Organization Type</span>
        <select id="orgTypeSelect" aria-label="Organization Type">
          <option value="">All Types</option>
          {% for t in organization_types %}
            <option value="{{ t.id }}" {% if selected_org_type == t.id|stringformat:'s' %}selected{% endif %}>{{ t.name }}</option>
          {% endfor %}
        </select>
      </label>

      <label class="filter">
        <span>Organization Role</span>
        <select id="orgRoleSelect" aria-label="Organization Role">
          <option value="">All Roles</option>
          {% for r in org_roles %}
            <option value="{{ r.id }}" {% if selected_org_role == r.id|stringformat:'s' %}selected{% endif %}>{{ r.name }}</option>
          {% endfor %}
        </select>
      </label>

      <label class="filter">
        <span>User(s)</span>
        <select id="userSelect" name="users" aria-label="Users">
          <option value="all">Select All Users</option>
          {% for u in users %}
            <option value="{{ u.id }}" {% if selected_user == u.id|stringformat:'s' %}selected{% endif %}>{{ u.name }}</option>
          {% endfor %}
        </select>
      </label>

  {# Removed generic Role selector; Organization Role above is the only role control #}

      <div class="search-bar">
        <i class="fas fa-search"></i>
        <input id="globalSearch" type="text" placeholder="Search modulesâ€¦" autocomplete="off" aria-label="Search modules">
        <button class="search-clear" type="button" id="clearSearchBtn" title="Clear">Ã—</button>
      </div>
    </div>

    <div class="main-actions">
      <button type="submit" form="permissionsForm" id="saveBtn" class="btn btn-primary save-btn">
        <i class="fas fa-save"></i><span id="saveText">Save Changes</span>
        <i id="saveSpinner" class="fas fa-spinner fa-spin" style="display:none"></i>
      </button>
    </div>
  </div>

  <!-- Stats -->
  <div class="stats">
    <div class="stat"><div class="num" id="availableCount">0</div><div class="lbl">Available</div></div>
    <div class="stat"><div class="num" id="assignedCount">0</div><div class="lbl">Assigned</div></div>
    <div class="stat"><div class="num" id="selectedCount">0</div><div class="lbl">Selected</div></div>
  </div>

  <!-- Form & Panels -->
  <form id="permissionsForm" method="post" action="{% url 'admin_sidebar_permissions' %}">
    {% csrf_token %}
    <input type="hidden" name="assigned_order" id="assigned_order" value="[]">
  <input type="hidden" name="role" id="hidden_role" value="{{ selected_org_role|default:selected_role|default:'' }}">

    <div class="panel-grid">
      <!-- Available -->
      <section class="panel">
        <div class="panel-head">
          <span>Available Permissions</span>
          <span class="count" id="availableBadge">0</span>
        </div>
        <div class="list" id="availableList">
          <div class="empty" id="availableEmpty">No permissions available</div>
        </div>
      </section>

      <!-- Middle actions -->
      <div class="actions-col">
        <button type="button" id="addBtn" class="btn btn-primary"><i class="fas fa-arrow-right"></i> Add</button>
        <button type="button" id="removeBtn" class="btn btn-primary"><i class="fas fa-arrow-left"></i> Remove</button>
        <button type="button" id="moveUpBtn" class="btn btn-secondary"><i class="fas fa-arrow-up"></i> Move Up</button>
        <button type="button" id="moveDownBtn" class="btn btn-secondary"><i class="fas fa-arrow-down"></i> Move Down</button>
        <button type="button" id="selectAllBtn" class="btn btn-secondary"><i class="fas fa-check-double"></i> Select All</button>
        <button type="button" id="clearBtn" class="btn btn-secondary"><i class="fas fa-times"></i> Clear</button>
      </div>

      <!-- Assigned -->
      <section class="panel">
        <div class="panel-head">
          <span>Assigned Permissions</span>
          <span class="count" id="assignedBadge">0</span>
        </div>
        <div class="list" id="assignedList">
          <div class="empty" id="assignedEmpty">No permissions assigned</div>
        </div>
      </section>
    </div>

    <!-- Save bar -->
    <div class="savebar">
      <div class="change-indicator" id="changeIndicator">No changes made</div>
      <button type="submit" id="saveBtnDup" class="btn btn-primary save-btn">
        <i class="fas fa-save"></i> Save Changes
      </button>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    function showToast(message, type='success'){
      const t=document.createElement('div');t.className=`toast ${type}`;t.textContent=message;
      Object.assign(t.style,{position:'fixed',right:'14px',bottom:'14px',background:'#164c8d',color:'#fff',padding:'10px 12px',borderRadius:'10px',boxShadow:'0 12px 40px rgba(2,6,23,.2)',opacity:'0',transform:'translateY(10px)',transition:'.25s',zIndex:1000,fontWeight:800});
      document.body.appendChild(t); setTimeout(()=>{t.style.opacity='1';t.style.transform='none'},50);
      setTimeout(()=>{t.style.opacity='0';t.style.transform='translateY(10px)';setTimeout(()=>t.remove(),250)},2500);
    }

    const availableData = JSON.parse('{{ available_permissions|safe|escapejs }}'.replace(/&quot;/g,'"') || '[]');
const assignedData  = JSON.parse('{{ assigned_permissions|safe|escapejs }}'.replace(/&quot;/g,'"') || '[]');

// ðŸ”¹ Helper: remove assigned items from available list
function removeAssignedFromAvailable(avail, assigned) {
  const assignedIds = new Set(assigned.map(p => p.id));
  return avail.filter(item => {
    if (assignedIds.has(item.id)) {
      return false; // hide if already assigned
    }
    if (item.children) {
      item.children = removeAssignedFromAvailable(item.children, assigned);
      if (item.children.length === 0) {
        return false;
      }
    }
    return true;
  });
}

let available = removeAssignedFromAvailable(availableData, assignedData);
let assigned  = assignedData;

let selectedAvailable = new Set(); 
let selectedAssigned  = new Set();


    const availableList = $('#availableList');
    const assignedList  = $('#assignedList');
    const availableCount=$('#availableCount');
    const assignedCount =$('#assignedCount');
    const selectedCount =$('#selectedCount');
    const availableEmpty=$('#availableEmpty');
    const assignedEmpty =$('#assignedEmpty');
    const globalSearch  =$('#globalSearch');
  const userSelect=$('#userSelect');
    const orgTypeSelect=$('#orgTypeSelect'); 
    const orgRoleSelect=$('#orgRoleSelect');
    const changeIndicator=$('#changeIndicator');

    const addBtn=$('#addBtn'), removeBtn=$('#removeBtn'),
          moveUpBtn=$('#moveUpBtn'), moveDownBtn=$('#moveDownBtn'),
          selectAllBtn=$('#selectAllBtn'), clearBtn=$('#clearBtn');

    function reloadWithFilters(extraParams={}) {
      const params=new URLSearchParams(window.location.search);
      const setOrDelete=(k,v)=>{ if(v){params.set(k,v)} else {params.delete(k)} };
  setOrDelete('org_type', orgTypeSelect?orgTypeSelect.value:'');
  const selUser=userSelect.value;
  setOrDelete('user', selUser && selUser!=='all'?selUser:'');
  setOrDelete('role', orgRoleSelect?orgRoleSelect.value:'');
      for(const [k,v] of Object.entries(extraParams)) setOrDelete(k,v);
      const qs=params.toString(); window.location.search = qs?('?'+qs):'';
    }

    function getPermissionIcon(p){
      const map={dashboard:'fas fa-tachometer-alt',event:'fas fa-calendar',user:'fas fa-users',
        report:'fas fa-chart-bar',setting:'fas fa-cog',management:'fas fa-tools',cdl:'fas fa-paint-brush',
        po:'fas fa-graduation-cap',transcript:'fas fa-file-alt'};
      const key=Object.keys(map).find(k=>p.label.toLowerCase().includes(k)||p.id.toLowerCase().includes(k));
      return map[key]||'fas fa-cube';
    }

    // ðŸ”¹ Render an item (parent or child)
   // ðŸ”¹ Render item (parent = folder, leaf = checkbox)
function renderPermissionItem(p, isAssigned) {
  const div = document.createElement('div'); 
  div.className = 'item'; 
  div.dataset.id = p.id;

  if (p.children && p.children.length > 0) {
    // ----- Parent (folder only, no checkbox) -----
    div.innerHTML = `
      <i class="fas fa-folder" style="color:var(--primary);margin-right:6px"></i>
      <span class="name">${p.label}</span>
      <div class="children" style="display:none;margin-left:20px"></div>
    `;

    const childrenContainer = div.querySelector('.children');
    p.children.forEach(child => {
      const childDiv = renderPermissionItem(child, isAssigned);
      childrenContainer.appendChild(childDiv);
    });

    // expand/collapse toggle
    div.addEventListener('click', e => {
      if (e.target.closest('.children')) return;
      childrenContainer.style.display = 
        childrenContainer.style.display === 'none' ? 'block' : 'none';
    });

  } else {
    // ----- Leaf (selectable with checkbox) -----
    const isSel = isAssigned ? selectedAssigned.has(p.id) : selectedAvailable.has(p.id);
    if (isSel) div.classList.add('selected');

    div.innerHTML = `
      <input type="checkbox" class="chk" ${isSel ? 'checked' : ''}>
      <i class="${getPermissionIcon(p)}" style="color:var(--primary);min-width:18px"></i>
      <div style="flex:1">
        <div class="name">${p.label}</div>
      </div>
    `;

    div.querySelector('.chk').addEventListener('change', e => {
      (isAssigned ? selectedAssigned : selectedAvailable)[e.target.checked ? 'add' : 'delete'](p.id);
      updateUI();
    });
  }

  return div;
}

// ðŸ”¹ Collect only leaf IDs (ignores parents)
function collectLeafIds(list) {
  let result = [];
  for (const item of list) {
    if (item.children) {
      result = result.concat(collectLeafIds(item.children));
    } else {
      result.push(item.id);
    }
  }
  return result;
}

// ðŸ”¹ On Save â†’ dump only leaf IDs into hidden field
document.getElementById('permissionsForm').addEventListener('submit', e => {
  const selectedUser = userSelect.value;
  if (!selectedUser && !(orgRoleSelect && orgRoleSelect.value)) {
    e.preventDefault();
    showToast('Please select a User or an Organization Role before saving.','error');
    return;
  }
  if (selectedUser === 'all') {
    const allFlag=document.createElement('input');
    allFlag.type='hidden';
    allFlag.name='all';
    allFlag.value='true';
    e.target.appendChild(allFlag);
  }

  const leafIds = collectLeafIds(assigned);
  document.getElementById('assigned_order').value = JSON.stringify(leafIds);

  // ensure hidden role (org role id) is submitted
  const hiddenRole = document.getElementById('hidden_role');
  if (hiddenRole && orgRoleSelect) hiddenRole.value = orgRoleSelect.value || '';

  document.getElementById('saveText').textContent = 'Savingâ€¦';
  const sp = document.getElementById('saveSpinner');
  if (sp) sp.style.display = 'inline-block';
});
    function applyFilters(list){
      const q=globalSearch.value.trim().toLowerCase();
      return list.filter(p=>!q||p.label.toLowerCase().includes(q));
    }

    function render(){
      const av=applyFilters(available); 
      const as=assigned;
      availableList.innerHTML=''; 
      assignedList.innerHTML='';
      if(av.length===0){ availableList.appendChild(availableEmpty.cloneNode(true)); }
      else av.forEach(p=>availableList.appendChild(renderPermissionItem(p,false)));
      if(as.length===0){ assignedList.appendChild(assignedEmpty.cloneNode(true)); }
      else as.forEach(p=>assignedList.appendChild(renderPermissionItem(p,true)));
      updateUI();
    }

    function updateUI(){
      availableCount.textContent=available.length;
      assignedCount.textContent=assigned.length;
      selectedCount.textContent=selectedAvailable.size+selectedAssigned.size;
      addBtn.disabled=selectedAvailable.size===0;
      removeBtn.disabled=selectedAssigned.size===0;
      moveUpBtn.disabled=selectedAssigned.size===0;
      moveDownBtn.disabled=selectedAssigned.size===0;

      const original=assignedData.map(p=>p.id).join(',');
      const current =assigned.map(p=>p.id).join(',');
      const changed =original!==current;
      changeIndicator.textContent = changed?'Changes pendingâ€¦':'No changes made';
      changeIndicator.style.color = changed?'#b45309':'var(--muted)';

      const ab=$('#availableBadge'), bb=$('#assignedBadge');
      if(ab) ab.textContent=available.length; 
      if(bb) bb.textContent=assigned.length;
    }

    // ðŸ”¹ Assign / Remove
    addBtn.addEventListener('click',()=>{
      selectedAvailable.forEach(id=>{
        const p=findAndRemove(available,id); 
        if(p){assigned.push(p);}
      });
      selectedAvailable.clear(); render();
    });

    removeBtn.addEventListener('click',()=>{
      selectedAssigned.forEach(id=>{
        const p=findAndRemove(assigned,id); 
        if(p){available.push(p);}
      });
      selectedAssigned.clear(); render();
    });

    function findAndRemove(list,id){
      let idx=list.findIndex(x=>x.id===id);
      if(idx>-1){return list.splice(idx,1)[0];}
      for(const item of list){
        if(item.children){
          const c=findAndRemove(item.children,id);
          if(c) return c;
        }
      }
      return null;
    }

    selectAllBtn.addEventListener('click',()=>{ flatten(available).forEach(p=>selectedAvailable.add(p.id)); render(); });
    clearBtn.addEventListener('click',()=>{ selectedAvailable.clear(); selectedAssigned.clear(); render(); });

    globalSearch.addEventListener('input',()=> setTimeout(render,120));
    $('#clearSearchBtn')?.addEventListener('click',()=>{ globalSearch.value=''; render(); });

  userSelect.addEventListener('change',()=>{
    reloadWithFilters();
  });
    if(orgTypeSelect) orgTypeSelect.addEventListener('change',()=>{ if(!orgTypeSelect.value){ orgRoleSelect && (orgRoleSelect.value=''); } reloadWithFilters(); });
    if(orgRoleSelect) orgRoleSelect.addEventListener('change',()=> reloadWithFilters());

    $('#saveBtnDup')?.addEventListener('click',()=> document.getElementById('permissionsForm').requestSubmit());


    function move(sel,dir){
      const ids=Array.from(sel); 
      const idxs=ids.map(id=>assigned.findIndex(p=>p.id===id)).sort((a,b)=>dir>0?b-a:a-b);
      idxs.forEach(i=>{
        const j=i+dir; 
        if(j>=0 && j<assigned.length){ [assigned[i],assigned[j]]=[assigned[j],assigned[i]]; }
      });
      render();
    }
    document.getElementById('moveUpBtn').addEventListener('click',()=>move(selectedAssigned,-1));
    document.getElementById('moveDownBtn').addEventListener('click',()=>move(selectedAssigned, 1));

    function flatten(list){
      let result=[];
      for(const item of list){
        if(item.children) result=result.concat(flatten(item.children));
        else result.push(item);
      }
      return result;
    }

    render();
  });
</script>
{% endblock %}
