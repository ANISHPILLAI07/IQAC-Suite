{% extends 'base.html' %}
{% load static %}

{% block title %}Settings - PO/PSO Management{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'core/css/admin_master_data.css' %}">
<link rel="stylesheet" href="{% static 'core/css/admin_pso_po_management.css' %}">
<style>
/* Custom inline PO/PSO layout styles */
.org-header-simple {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 2rem;
  padding-bottom: 1rem;
  border-bottom: 2px solid #e5e7eb;
}

.org-basic-info .page-title {
  font-size: 2rem;
  font-weight: 700;
  color: #1f2937;
  margin: 0 0 0.5rem 0;
}

.org-meta {
  display: flex;
  gap: 0.75rem;
}

.org-type-badge, .access-badge {
  padding: 0.25rem 0.75rem;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
}

.org-type-badge {
  background: #1e60b1;
  color: white;
}

.access-badge {
  background: #1e60b1;
  color: white;
}

.assignment-date {
  font-size: 0.9rem;
  color: #6b7280;
  font-weight: 500;
}

.program-outcomes-container {
  margin-bottom: 3rem;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  overflow: hidden;
  background: white;
}

.outcomes-summary-row {
  display: flex;
  background: #f8fafc;
  border-bottom: 1px solid #e5e7eb;
}

.summary-left, .summary-right {
  flex: 1;
  padding: 1.5rem;
  display: flex;
  justify-content: center;
}

.summary-left {
  border-right: 1px solid #e5e7eb;
}

.count-box {
  text-align: center;
  padding: 1rem;
  border-radius: 8px;
  min-width: 120px;
}

.po-box {
  background: #eef4fc;
  border: 2px solid #1e60b1;
}

.pso-box {
  background: #eef4fc;
  border: 2px solid #1e60b1;
}

.count-number {
  font-size: 2.5rem;
  font-weight: 700;
  color: #1f2937;
  margin-bottom: 0.25rem;
}

.count-label {
  font-size: 0.875rem;
  font-weight: 600;
  color: #6b7280;
}

.outcomes-panels {
  display: flex;
  min-height: 400px;
}

.outcomes-panel {
  flex: 1;
  padding: 1.5rem;
  border-right: 1px solid #e5e7eb;
}

.pso-panel {
  border-right: none;
}

.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid #e5e7eb;
}

.panel-header h3 {
  font-size: 1.25rem;
  font-weight: 600;
  color: #1f2937;
  margin: 0;
}

.add-btn {
  background: #1e60b1;
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 4px;
  font-size: 0.875rem;
  cursor: pointer;
  transition: background 0.2s ease;
}

.add-btn:hover {
  background: #184e8f;
}

.outcomes-list {
  max-height: 300px;
  overflow-y: auto;
}

.outcome-item {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  padding: 0.75rem;
  margin-bottom: 0.5rem;
  border: 1px solid #e5e7eb;
  border-radius: 4px;
  background: #f9fafb;
}

.outcome-item:hover {
  background: #f3f4f6;
}

.outcome-text {
  flex: 1;
  font-size: 0.875rem;
  line-height: 1.5;
  color: #374151;
  margin-right: 0.75rem;
}

.edit-btn-inline {
  background: #1e60b1;
  color: white;
  border: none;
  padding: 0.25rem 0.75rem;
  border-radius: 4px;
  font-size: 0.75rem;
  cursor: pointer;
  flex-shrink: 0;
}

.edit-btn-inline:hover {
  background: #184e8f;
}

.empty-state {
  text-align: center;
  padding: 2rem 1rem;
  color: #6b7280;
}

.empty-state p {
  margin: 0;
  font-style: italic;
}

.no-programs-message {
  text-align: center;
  padding: 3rem;
  color: #6b7280;
}

.no-programs-message i {
  font-size: 3rem;
  margin-bottom: 1rem;
  color: #9ca3af;
}

/* Delete buttons are styled via .btn-inline-delete in admin_pso_po_management.css to keep blue/white theme */
/* Add-row adjustments */
.outcome-item.add-row { gap: 0.5rem; }
.outcome-item.add-row .inline-editor { flex: 1; }
.outcome-actions { display: flex; gap: 0.5rem; }
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
  <div class="admin-header">
    <h1 class="admin-title">POs & PSOs Management</h1>
    <p class="admin-subtitle">
      {% if assigned_organizations|length == 1 %}
        Manage Program Outcomes and Program Specific Outcomes for {{ assigned_organizations.0.organization.name }}
      {% else %}
        Manage Program Outcomes and Program Specific Outcomes for your assigned organizations
      {% endif %}
    </p>
  </div>

  <div class="admin-content">
    {% for org_data in assigned_organizations %}
    <div class="organization-section">
      <!-- Organization Header -->
      <div class="org-header-simple">
        <div class="org-basic-info">
          <h1 class="page-title">{{ org_data.organization.name }}</h1>
          <div class="org-meta">
            <span class="org-type-badge">{{ org_data.organization.org_type.name|upper }}</span>
            {% if org_data.has_department_access %}
            <span class="access-badge">DEPARTMENT FACULTY ACCESS</span>
            {% else %}
            <span class="access-badge">GENERAL ACCESS</span>
            {% endif %}
          </div>
        </div>
        <div class="assignment-info">
          <span class="assignment-date">Assigned on: {{ org_data.assignment.created_at|date:"M d, Y" }}</span>
        </div>
      </div>

      {% if org_data.programs %}
        {% for program in org_data.programs %}
        <!-- Inline PO/PSO Layout for each program -->
        <div class="program-outcomes-container" data-program-id="{{ program.id }}">
          
          <!-- Summary Row with Counts -->
          <div class="outcomes-summary-row">
            <div class="summary-left">
              <div class="count-box po-box">
                <div class="count-number">{{ program.pos.count }}</div>
                <div class="count-label">POs count</div>
              </div>
            </div>
            <div class="summary-right">
              <div class="count-box pso-box">
                <div class="count-number">{{ program.psos.count }}</div>
                <div class="count-label">PSOs count</div>
              </div>
            </div>
          </div>

          <!-- Inline Outcomes Panels -->
          <div class="outcomes-panels">
            <!-- POs Panel -->
            <div class="outcomes-panel po-panel">
              <div class="panel-header">
                <h3>POs</h3>
                <button class="add-btn" data-action="add-outcome" data-type="PO" data-program-id="{{ program.id }}">add</button>
              </div>
              <div class="outcomes-list" id="pos-list-{{ program.id }}">
                {% if program.pos.count > 0 %}
                  {% for po in program.pos.all %}
                  <div class="outcome-item" data-outcome-id="{{ po.id }}">
                    <div class="outcome-text">{{ po.description }}</div>
                    <button class="edit-btn-inline" data-action="edit-outcome" data-outcome-id="{{ po.id }}" data-outcome-type="PO">edit</button>
                  </div>
                  {% endfor %}
                {% else %}
                  <div class="empty-state">
                    <p>No Programme Outcomes added yet. Click "add" to create your first PO.</p>
                  </div>
                {% endif %}
              </div>
            </div>

            <!-- PSOs Panel -->
            <div class="outcomes-panel pso-panel">
              <div class="panel-header">
                <h3>PSOs</h3>
                <button class="add-btn" data-action="add-outcome" data-type="PSO" data-program-id="{{ program.id }}">add</button>
              </div>
              <div class="outcomes-list" id="psos-list-{{ program.id }}">
                {% if program.psos.count > 0 %}
                  {% for pso in program.psos.all %}
                  <div class="outcome-item" data-outcome-id="{{ pso.id }}">
                    <div class="outcome-text">{{ pso.description }}</div>
                    <button class="edit-btn-inline" data-action="edit-outcome" data-outcome-id="{{ pso.id }}" data-outcome-type="PSO">edit</button>
                  </div>
                  {% endfor %}
                {% else %}
                  <div class="empty-state">
                    <p>No Programme Specific Outcomes added yet. Click "add" to create your first PSO.</p>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div class="no-programs-message">
          <i class="fas fa-info-circle"></i>
          <h3>No programs found for this organization</h3>
          <p>You can create a program for {{ org_data.organization.name }} to start adding POs and PSOs.</p>
          <div style="margin-top: 1rem;">
            <input type="text" id="program-name-{{ org_data.organization.id }}" placeholder="Program name (optional)" style="padding: 0.5rem 0.75rem; border: 1px solid #e5e7eb; border-radius: 6px; width: 280px;">
            <button class="add-btn" style="margin-left: 0.5rem;" data-action="create-program" data-org-id="{{ org_data.organization.id }}">Create Program</button>
          </div>
          <small style="display:block; color:#9ca3af; margin-top:0.5rem;">If left blank, a default program name will be used.</small>
        </div>
      {% endif %}
    </div>
    {% empty %}
    <div class="no-assignments">
      <i class="fas fa-exclamation-triangle"></i>
      <h2>No Assignments Found</h2>
      <p>You are not currently assigned to manage any PO/PSO outcomes.</p>
      <p>Please contact your administrator for assistance.</p>
    </div>
    {% endfor %}
  </div>
</div>

<!-- No modals: fully inline UX -->
{% endblock %}

{% block scripts_extra %}
<script>
// Global variables
let currentlyEditing = null;

window.IS_SETTINGS_PSO_PAGE = true;

// Delegated events for add/edit/create actions to avoid inline onclick
document.addEventListener('click', (e) => {
  const btn = e.target.closest('button');
  if (!btn) return;
  const action = btn.dataset.action;
  if (!action) return;

  if (action === 'add-outcome') {
    const type = btn.dataset.type; // 'PO' | 'PSO'
    const programId = Number(btn.dataset.programId);
    toggleInlineAdd(type, programId);
  }

  if (action === 'edit-outcome') {
    const outcomeId = Number(btn.dataset.outcomeId);
    const outcomeType = btn.dataset.outcomeType;
    const item = btn.closest('.outcome-item');
    const desc = item?.querySelector('.outcome-text')?.textContent || '';
    editOutcomeInline(outcomeId, outcomeType, desc);
  }

  if (action === 'create-program') {
    const orgId = Number(btn.dataset.orgId);
    createProgramForOrg(orgId);
  }
});

// Inline Add: toggles an add row with textarea + Save/Cancel
function toggleInlineAdd(outcomeType, programId) {
  const listId = outcomeType === 'PO' ? `pos-list-${programId}` : `psos-list-${programId}`;
  const list = document.getElementById(listId);
  if (!list) return;

  // Remove existing add row if present (toggle behavior)
  const existing = list.querySelector('.outcome-item.add-row');
  if (existing) { existing.remove(); return; }

  // Remove empty state if visible
  const empty = list.querySelector('.empty-state');
  if (empty) empty.remove();

  const row = document.createElement('div');
  row.className = 'outcome-item add-row';

  const ta = document.createElement('textarea');
  ta.className = 'inline-editor';
  ta.placeholder = `Enter ${outcomeType} description...`;
  ta.rows = 3;

  const actions = document.createElement('div');
  actions.className = 'outcome-actions';
  const save = document.createElement('button'); save.className = 'btn-inline-save'; save.textContent = 'Save';
  const cancel = document.createElement('button'); cancel.className = 'btn-inline-cancel'; cancel.textContent = 'Cancel';
  actions.appendChild(save); actions.appendChild(cancel);

  const error = document.createElement('div');
  error.className = 'inline-error';
  error.style.display = 'none';

  row.appendChild(ta);
  row.appendChild(actions);
  row.appendChild(error);
  list.prepend(row);
  ta.focus();

  cancel.addEventListener('click', () => row.remove());
  ta.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ e.preventDefault(); row.remove(); }});

  save.addEventListener('click', () => {
    const description = (ta.value || '').trim();
    if (!description) { error.textContent = "Description can't be empty"; error.style.display='block'; return; }
    fetch("{% url 'manage_program_outcomes' %}", {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken'), 'X-Requested-With': 'XMLHttpRequest' },
      body: JSON.stringify({ program_id: Number(programId), type: outcomeType, description })
    }).then(r=>r.json()).then(data=>{
      if (data.success) {
        // Build a standard outcome item
        const item = document.createElement('div');
        item.className = 'outcome-item';
        item.dataset.outcomeId = data.outcome.id;
        const text = document.createElement('div'); text.className = 'outcome-text'; text.textContent = data.outcome.description;
  const edit = document.createElement('button');
  edit.className = 'edit-btn-inline';
  edit.textContent = 'edit';
  edit.dataset.action = 'edit-outcome';
  edit.dataset.outcomeId = data.outcome.id;
  edit.dataset.outcomeType = outcomeType;
        item.appendChild(text); item.appendChild(edit);
        row.replaceWith(item);

        // Update count
        const programContainer = list.closest('.program-outcomes-container');
        const summary = programContainer?.querySelector(outcomeType === 'PO' ? '.po-box .count-number' : '.pso-box .count-number');
        if (summary) { summary.textContent = (parseInt(summary.textContent,10)||0) + 1; }
        showToast(`${outcomeType} added`, 'success');
      } else {
        error.textContent = data.error || 'Add failed';
        error.style.display = 'block';
      }
    }).catch(()=>{ error.textContent='Network error'; error.style.display='block'; });
  });
}

function editOutcomeInline(outcomeId, outcomeType, description) {
  const item = document.querySelector(`.outcome-item[data-outcome-id="${outcomeId}"]`);
  if (!item || item.classList.contains('editing')) return;
  item.classList.add('editing');

  const textEl = item.querySelector('.outcome-text');
  const original = textEl ? textEl.textContent : description || '';

  const ta = document.createElement('textarea');
  ta.className = 'inline-editor';
  ta.value = original;
  ta.rows = Math.min(6, Math.max(2, Math.ceil(original.length/80)));
  textEl.replaceWith(ta);
  ta.focus();

  const actions = document.createElement('div');
  actions.className = 'outcome-actions';
  const save = document.createElement('button'); save.className = 'btn-inline-save'; save.textContent = 'Save';
  const cancel = document.createElement('button'); cancel.className = 'btn-inline-cancel'; cancel.textContent = 'Cancel';
  const del = document.createElement('button'); del.className = 'btn-inline-delete'; del.textContent = 'Delete';

  // Replace existing action (the small edit button) with full actions
  const oldActionsBtn = item.querySelector('.edit-btn-inline');
  if (oldActionsBtn) oldActionsBtn.replaceWith(actions);
  actions.appendChild(save); actions.appendChild(cancel); actions.appendChild(del);

  const error = document.createElement('div');
  error.className = 'inline-error';
  error.style.display = 'none';
  item.appendChild(error);

  const programContainer = item.closest('.program-outcomes-container');
  const programId = Number(programContainer?.dataset.programId);

  const exit = () => {
    const restored = document.createElement('div');
    restored.className = 'outcome-text';
    restored.textContent = original;
    ta.replaceWith(restored);
  const editBtn = document.createElement('button');
  editBtn.className = 'edit-btn-inline';
  editBtn.textContent = 'edit';
  editBtn.dataset.action = 'edit-outcome';
  editBtn.dataset.outcomeId = outcomeId;
  editBtn.dataset.outcomeType = outcomeType;
    actions.replaceWith(editBtn);
    error.remove();
    item.classList.remove('editing');
  };

  cancel.addEventListener('click', exit);
  ta.addEventListener('keydown', (e) => { if (e.key === 'Escape') { e.preventDefault(); exit(); }});

  save.addEventListener('click', () => {
    const val = (ta.value || '').trim();
    if (!val) { error.textContent = "Description can't be empty"; error.style.display = 'block'; return; }
    fetch("{% url 'manage_program_outcomes' %}", {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken'), 'X-Requested-With': 'XMLHttpRequest' },
      body: JSON.stringify({ outcome_id: Number(outcomeId), type: outcomeType, description: val })
    }).then(r=>r.json()).then(data=>{
      if (data.success) {
        const restored = document.createElement('div');
        restored.className = 'outcome-text';
        restored.textContent = data.outcome?.description || val;
        ta.replaceWith(restored);
  const editBtn = document.createElement('button');
  editBtn.className = 'edit-btn-inline';
  editBtn.textContent = 'edit';
  editBtn.dataset.action = 'edit-outcome';
  editBtn.dataset.outcomeId = outcomeId;
  editBtn.dataset.outcomeType = outcomeType;
        actions.replaceWith(editBtn);
        error.remove();
        item.classList.remove('editing');
        showToast('Outcome updated', 'success');
      } else {
        error.textContent = data.error || 'Update failed';
        error.style.display = 'block';
      }
    }).catch(()=>{ error.textContent='Network error'; error.style.display='block'; });
  });

  let confirming = false;
  del.addEventListener('click', () => {
    if (!confirming) { confirming = true; del.textContent = 'Confirm Delete'; del.classList.add('confirm'); return; }
    fetch("{% url 'manage_program_outcomes' %}", {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken'), 'X-Requested-With': 'XMLHttpRequest' },
      body: JSON.stringify({ outcome_id: Number(outcomeId), type: outcomeType })
    }).then(r=>r.json()).then(data=>{
      if (data.success) {
        // Update counts locally
        const summary = programContainer.querySelector(outcomeType === 'PO' ? '.po-box .count-number' : '.pso-box .count-number');
        if (summary) { const n = Math.max(0, (parseInt(summary.textContent,10)||1)-1); summary.textContent = n; }
        const parentList = item.parentElement;
        item.remove();
        // If list is empty, show empty state
        if (parentList && !parentList.querySelector('.outcome-item')) {
          const empty = document.createElement('div');
          empty.className = 'empty-state';
          empty.innerHTML = `<p>No ${outcomeType === 'PO' ? 'Programme Outcomes' : 'Programme Specific Outcomes'} added yet. Click "add" to create your first ${outcomeType}.</p>`;
          parentList.appendChild(empty);
        }
        showToast('Outcome deleted', 'success');
      } else {
        showToast(data.error || 'Delete failed', 'error');
      }
    }).catch(()=> showToast('Network error', 'error'));
  });
}

// Inline edit/delete logic remains as implemented

// Create Program for Organization (when no programs exist)
function createProgramForOrg(orgId) {
  const input = document.getElementById(`program-name-${orgId}`);
  const name = input ? input.value.trim() : '';
  fetch("{% url 'create_program_for_organization' %}", {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken'),
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: JSON.stringify({ organization_id: Number(orgId), program_name: name })
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      showToast('Program created', 'success');
      location.reload();
    } else {
      showToast(data.error || 'Failed to create program', 'error');
    }
  })
  .catch(err => {
    console.error('Create program failed:', err);
    showToast('Failed to create program', 'error');
  });
}

// CSRF token helper function
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// No modal listeners needed

// Tiny toast helper using existing notification styles
function showToast(message, type='info'){
  const n = document.createElement('div');
  n.className = `notification ${type}`;
  n.innerHTML = `<div class="notification-content"><span class="notification-message">${message}</span><button class="notification-close" onclick="this.closest('.notification').remove()">×</button></div>`;
  document.body.appendChild(n);
  setTimeout(()=>{ n.remove(); }, 4000);
}
</script>
{% endblock %}