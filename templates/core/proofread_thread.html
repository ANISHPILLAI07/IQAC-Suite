{% extends "base.html" %}
{% load static %}

{% block title %}Proof-reading · {{ proposal.event_title }}{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'core/css/dashboard.css' %}">
<style>
  .pf-wrap { max-width: 1100px; margin: 0 auto; }
  .pf-header { display:flex; align-items:center; justify-content:space-between; margin: 12px 0 16px; }
  .pf-timeline { display:flex; flex-direction:column; gap:14px; padding:8px 0; }
  .msg { display:flex; }
  .msg.left { justify-content:flex-start; }
  .msg.right { justify-content:flex-end; }
  .bubble { max-width: 78%; background:#fff; border:1px solid #e6e8f0; border-radius:16px; padding:12px 14px; box-shadow:0 8px 30px rgba(2,6,23,.04); }
  .bubble .meta { font-size:12px; color:var(--muted); margin-bottom:6px; display:flex; gap:8px; align-items:center; }
  .bubble .items { display:grid; gap:8px; }
  .chip { display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px; background:#eef2ff; color:#3730a3; }
  .chip.ok { background:#dcfce7; color:#166534; }
  .chip.warn { background:#fff7ed; color:#9a3412; }
  .itm { background:#f8fafc; border:1px dashed #dbe0ea; border-radius:10px; padding:10px; }
  .pf-controls { background:#fff; border:1px solid #e6e8f0; border-radius:12px; padding:12px; margin-top:16px; }
  .link-muted { color:#164c8d; text-decoration:none; }
  .link-muted:hover { text-decoration:underline; }
  @media (max-width: 720px){ .bubble{ max-width:100%; } }
  .pf-log { background:#fff; border:1px solid #e6e8f0; border-radius:12px; margin-top:16px; overflow:hidden; box-shadow:0 8px 28px rgba(2,6,23,.05); }
  .pf-log-header { position:sticky; top:0; background:#f1f5f9; padding:8px 10px; font-size:11px; text-transform:uppercase; letter-spacing:.5px; color:#475569; border-bottom:1px solid #e2e8f0 }
  .pf-log table { width:100%; border-collapse:collapse; font-size:13px }
  .pf-log th, .pf-log td { padding:10px 12px; border-bottom:1px solid #e2e8f0; text-align:left; vertical-align:top }
  .pf-log tbody tr:hover { background:#f8fafc; }
  .pf-log tbody tr:nth-child(even) { background:#fbfdff; }
  .pf-from { font-weight:600; color:#1e3a8a; font-size:12px; white-space:nowrap }
  .pf-time { font-size:10px; font-weight:400; color:#64748b; margin-top:2px }
  .pf-msg { white-space:pre-wrap; word-break:break-word }
  .pf-att a { font-size:11px; text-decoration:none; display:inline-flex; gap:6px; align-items:center }
  .pf-empty { padding:18px; text-align:center; color:#64748b }
  .pf-date-pill { display:inline-block; background:#e2e8f0; color:#334155; font-size:11px; padding:3px 8px; border-radius:999px; }
  .status { font-size:11px; padding:2px 8px; border-radius:999px; margin-left:6px; vertical-align:middle }
  .status.approved { background:#dcfce7; color:#166534 }
  .status.changes-needed { background:#fff7ed; color:#9a3412 }
  .status.pending { background:#e5e7eb; color:#374151 }
  /* Blue accent for chips and primary buttons */
  .chip-btn { background:#e8eefc; color:#173a8a; border:1px solid #cdd8fb; }
  .chip-btn:hover { background:#dbe6fb; border-color:#bfcdfb; }
  .chip-btn:active { background:#cfddfb; }
  .btn-primary { background:#1e3a8a; border-color:#1e3a8a }
  .btn-primary:hover { filter:brightness(1.03) }
  .btn-primary:active { filter:brightness(0.98) }
  /* Quick chips kept text-only for consistency */
</style>
{% endblock %}

{% block content %}
<div class="pf-wrap">
  <div class="pf-header">
    <div>
      <h1 style="margin:0 0 4px">Proof-reading</h1>
      <div class="pf-meta">Event · {{ proposal.event_title }}</div>
    </div>
    <div>
      <a class="chip-btn" href="{% url 'cdl_support_detail_page' %}?eventId={{ proposal.id }}"><i class="fa-solid fa-arrow-left"></i> Back</a>
    </div>
  </div>

  <div class="pf-controls">
    <form id="pfForm" enctype="multipart/form-data">
      <input type="hidden" name="proposal_id" value="{{ proposal.id }}">
      <label class="label">Reviewer</label>
      <select name="reviewer_id" id="pfReviewer" class="select"></select>
      <div style="display:grid;grid-template-columns:1fr;gap:8px;margin-top:10px">
        <div>
          <label class="label">Link URL</label>
          <input name="content_text" id="pfUrl" class="input" placeholder="Paste a link to review…" />
          <div id="pfQuick" class="pf-quick" style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap"></div>
        </div>
      </div>
      <label class="label" style="margin-top:8px">Label (optional)</label>
      <input name="label" class="input" placeholder="e.g., Poster caption, Invite" />
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;align-items:center;flex-wrap:wrap">
        <button type="button" class="chip-btn" id="pfReset">Clear</button>
        <button type="submit" class="btn-primary"><i class="fa-regular fa-paper-plane"></i> Send</button>
      </div>
    </form>
  </div>

  <div id="pfListTable" class="pf-log">
    <div style="max-height:520px; overflow:auto">
      <table>
        <thead class="pf-log-header">
          <tr>
            <th style="width:140px">Date</th>
            <th style="width:180px">From</th>
            <th>Message</th>
            <th style="width:160px">Attachments</th>
          </tr>
        </thead>
        <tbody id="pfLogBody"></tbody>
      </table>
      <div id="pfLogEmpty" class="pf-empty" style="display:none">No submissions yet</div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
(async function(){
  const listTable = document.getElementById('pfListTable');
  const logBody = document.getElementById('pfLogBody');
  const logEmpty = document.getElementById('pfLogEmpty');
  const form = document.getElementById('pfForm');
  const reviewerSel = document.getElementById('pfReviewer');
  const urlInput = document.getElementById('pfUrl');
  const quick = document.getElementById('pfQuick');
  

  async function loadReviewers(){
    const r=await fetch('/api/cdl/proofread/reviewers/');
    const d=await r.json();
    if(!r.ok||!d.success) throw new Error(d.error||('HTTP '+r.status));
    reviewerSel.innerHTML = (d.reviewers||[]).map(x=>`<option value="${x.id}">${x.name}</option>`).join('');
  }
  async function loadList(){
    const r=await fetch(`/api/cdl/proofread/list/?proposal_id={{ proposal.id }}`);
    const d=await r.json();
    if(!r.ok||!d.success) throw new Error(d.error||('HTTP '+r.status));
    const subs=(d.submissions||[]).sort((a,b)=> new Date(a.created_at)-new Date(b.created_at));
    renderTable(subs);
  }

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(form);
    // Enforce links-only: remove file if any and validate URL
    fd.delete('file');
    const url = (urlInput.value||'').trim();
    if(!url){ alert('Please paste a link to send for review.'); return; }
    const ok = /^(https?:\/\/|ftp:\/\/|www\.)/i.test(url);
    if(!ok){ alert('Please enter a valid URL (starting with http/https).'); return; }
    fd.set('content_text', url);
    try{
      const r=await fetch('/api/cdl/proofread/submit/', { method:'POST', body: fd, headers:{'X-CSRFToken':(document.querySelector('meta[name="csrf-token"]')||{}).content}});
      const d=await r.json();
      if(!r.ok||!d.success) throw new Error(d.error||('HTTP '+r.status));
      form.reset();
      urlInput.value='';
      await loadList();
    }catch(err){ alert('Failed: '+(err.message||'Error')); }
  });
  document.getElementById('pfReset').addEventListener('click', ()=> form.reset());

  async function loadSupportLinks(){
    try{
      quick.innerHTML = '';
      const r1 = await fetch(`/api/cdl/support/{{ proposal.id }}/`);
      const d1 = await r1.json();
      if(r1.ok && d1.success){
        const data = d1.data||{};
        const poster = data.poster_design_link;
        const cert = data.certificate_design_link;
        if(poster){ addQuick('Use Poster link', poster, 'Poster design link'); }
        if(cert){ addQuick('Use Certificate link', cert, 'Certificate link'); }
        const speakers = Array.isArray(d1.speakers)? d1.speakers: [];
        for(const sp of speakers){ if(sp.linkedin_url){ addQuick(`Speaker: ${sp.full_name} LinkedIn`, sp.linkedin_url, 'Speaker LinkedIn'); } }
      }
      const r2 = await fetch(`/api/cdl/event/{{ proposal.id }}/documents/`);
      const d2 = await r2.json();
      if(r2.ok && d2.success){
        const docs = d2.documents||{};
        const poster2 = docs.poster && docs.poster.design_link;
        const cert2 = docs.certificates && docs.certificates.design_link;
        if(poster2){ addQuick('Poster (documents)', poster2, 'Poster design link'); }
        if(cert2){ addQuick('Certificate (documents)', cert2, 'Certificate link'); }
      }
    }catch{}
  }

  function addQuick(label, url, autoLabel){
    if(!url) return;
    const btn=document.createElement('button'); btn.type='button'; btn.className='chip-btn'; btn.textContent=label;
    btn.onclick=()=>{ urlInput.value=url; if(autoLabel){ form.label.value=autoLabel; } };
    quick.appendChild(btn);
  }

  function renderAttachmentCell(items){
    const links = (items||[]).map(it=>{
      if(it.kind==='text'){
        const url = (it.content_text||'').trim(); if(!url) return '';
        const label = it.label || 'Link';
        return `<a href='${url}' target='_blank' rel='noopener noreferrer'><i class="fa-regular fa-paperclip"></i> ${label}</a>`;
      }
      if(it.file_missing){ return `<span style='font-size:11px;color:#b91c1c;display:inline-flex;gap:4px;align-items:center'><i class="fa-regular fa-triangle-exclamation"></i> Missing file</span>`; }
      const label = it.label || 'File';
      return `<a href='${it.file_url}' target='_blank' rel='noopener noreferrer'><i class="fa-regular fa-paperclip"></i> ${label}</a>`;
    }).filter(Boolean);
    return links.join('<br>');
  }

  function renderSubmitterMessage(s){
    const parts = [];
    for(const it of (s.items||[])){
      if(it.kind==='text'){
        const label = it.label ? `<div style='font-size:12px;color:var(--muted);margin-bottom:4px'>${it.label}</div>`: '';
        const link = it.content_text ? `<a class='link-muted' href='${it.content_text}' target='_blank' rel='noopener noreferrer'>${it.content_text}</a>` : '';
        parts.push(`<div>${label}${link}</div>`);
      }else{
        const label = it.label || 'File attached';
        parts.push(`<div>${label}</div>`);
      }
    }
    return parts.join('') || '';
  }

  function dayKey(iso){ try{ const d=new Date(iso); return d.toISOString().slice(0,10);}catch{return String(iso).slice(0,10);} }
  function fmtDay(iso){ try{ const d=new Date(iso); return d.toLocaleDateString(undefined,{day:'2-digit',month:'short',year:'numeric'});}catch{return String(iso).slice(0,10);} }
  function fmtTime(iso){ try{ const d=new Date(iso); return d.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'});}catch{return '';} }

  function statusMeta(status){
    switch(status){
      case 'approved': return {cls:'approved', text:'Approved'};
      case 'changes_needed': return {cls:'changes-needed', text:'Changes needed'};
      case 'pending': default: return {cls:'pending', text:'Pending'};
    }
  }

  function renderTable(subs){
    logBody.innerHTML='';
    if(!subs.length){ logEmpty.style.display='block'; return; }
    logEmpty.style.display='none';
    const rows=[];
    for(const s of subs){
      const sm1 = statusMeta(s.status);
      rows.push({ day:dayKey(s.created_at), dayLabel:fmtDay(s.created_at), time:fmtTime(s.created_at), from:s.submitted_by, msg:renderSubmitterMessage(s), att:renderAttachmentCell(s.items), status:sm1 });
      const showFaculty = (s.status!=='pending') || (s.feedback && s.feedback.trim());
      if(showFaculty){ const t=s.updated_at||s.created_at; const sm=statusMeta(s.status); rows.push({ day:dayKey(t), dayLabel:fmtDay(t), time:fmtTime(t), from:`${s.reviewer}`, msg:`${s.feedback? `<div style='margin-top:2px'>${s.feedback}</div>`:''}`, att:'', status:sm }); }
    }
    const groups=new Map();
    for(const r of rows){ if(!groups.has(r.day)) groups.set(r.day,{label:r.dayLabel, rows:[]}); groups.get(r.day).rows.push(r); }
    const dayKeys=Array.from(groups.keys()).sort();
    for(const dk of dayKeys){
      const g=groups.get(dk);
      const span=g.rows.length;
      g.rows.forEach((r,i)=>{
        const statusBadge = r.status ? `<span class="status ${r.status.cls}">${r.status.text}</span>` : '';
        const tr=document.createElement('tr');
        tr.innerHTML = `${i===0?`<td rowspan='${span}' class='pf-date'><div class='pf-date-pill'>${g.label}</div></td>`:''}
          <td class='pf-from'>${r.from}${statusBadge}<div class='pf-time'>${r.time}</div></td>
          <td class='pf-msg'>${r.msg || ''}</td>
          <td class='pf-att'>${r.att || ''}</td>`;
        logBody.appendChild(tr);
      });
    }
  }

  try{ await loadReviewers(); await loadSupportLinks(); await loadList(); }catch(e){
    logBody.innerHTML = '';
    logEmpty.style.display='block';
  }
})();
</script>
{% endblock %}