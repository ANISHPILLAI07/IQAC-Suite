{% extends 'base.html' %}
{% load static %}

{% block title %}Admin Dashboard - CHRIST University{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="{% static 'core/css/admin_dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
  <!-- Dashboard Header -->
  <div class="dashboard-header">
    <div class="dashboard-icon">
      <i class="fas fa-tachometer-alt"></i>
    </div>
    <h1 class="dashboard-title">Admin Dashboard</h1>
  </div>

  <!-- Welcome Message -->
  <div class="dashboard-welcome">
    <p>Welcome, <strong>{{ request.user.get_full_name|default:request.user.username }}!</strong></p>
  </div>

  <!-- Statistics Row -->
  <div class="dashboard-stats">
    <div class="stat-card">
      <div class="stat-number">{{ stats.students }}</div>
      <div class="stat-label">Students</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">{{ stats.faculties }}</div>
      <div class="stat-label">Faculties</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">{{ stats.hods }}</div>
      <div class="stat-label">HODs</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">{{ stats.centers }}</div>
      <div class="stat-label">Centers</div>
    </div>
  </div>

  <!-- Analytics Section -->
  <div class="dashboard-analytics">
    <div class="analytics-row">
      <div class="analytics-card">
        <h3>Event Proposals</h3>
        <div class="analytics-content">
          <div class="metric">
            <span class="metric-label">Total:</span>
            <span class="metric-value">{{ stats.total_proposals }}</span>
          </div>
          <div class="metric">
            <span class="metric-label">Pending:</span>
            <span class="metric-value pending">{{ stats.pending_proposals }}</span>
          </div>
          <div class="metric">
            <span class="metric-label">Approved:</span>
            <span class="metric-value approved">{{ stats.approved_proposals }}</span>
          </div>
          <div class="metric">
            <span class="metric-label">Rejected:</span>
            <span class="metric-value rejected">{{ stats.rejected_proposals }}</span>
          </div>
        </div>
      </div>
      
      <div class="analytics-card">
        <h3>System Overview</h3>
        <div class="analytics-content">
          <div class="metric">
            <span class="metric-label">Total Users:</span>
            <span class="metric-value">{{ stats.total_users }}</span>
          </div>
          <div class="metric">
            <span class="metric-label">Active Users:</span>
            <span class="metric-value">{{ stats.active_users }}</span>
          </div>
          <div class="metric">
            <span class="metric-label">New This Week:</span>
            <span class="metric-value">{{ stats.new_users_this_week }}</span>
          </div>
          <div class="metric">
            <span class="metric-label">Reports:</span>
            <span class="metric-value">{{ stats.total_reports }}</span>
          </div>
        </div>
      </div>

      <div class="analytics-card">
        <h3>Organizations</h3>
        <div class="analytics-content">
          <div class="metric">
            <span class="metric-label">Departments:</span>
            <span class="metric-value">{{ stats.departments }}</span>
          </div>
          <div class="metric">
            <span class="metric-label">Clubs:</span>
            <span class="metric-value">{{ stats.clubs }}</span>
          </div>
          <div class="metric">
            <span class="metric-label">Total Orgs:</span>
            <span class="metric-value">{{ stats.centers }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Dynamic Organization Stats Row (optional, show if org_stats exists) -->
  {% if org_stats %}
  <div class="admin-dashboard-stats-row" style="margin-top:2rem;">
    {% for stat in org_stats %}
      <div class="admin-dashboard-stat">
        <div class="stat-icon stat-center"></div>
        <div class="stat-count">{{ stat.user_count }}</div>
        <div class="stat-label">{{ stat.organization_org_type_name }}</div>
      </div>
    {% empty %}
      <p>No organization data.</p>
    {% endfor %}
  </div>
  {% endif %}


  
  <!-- Recent Activity Feed -->
  {% if recent_activities %}
  <div class="recent-activities">
    <div class="section-header">
      <h3>Recent Activity</h3>
      <span class="activity-count">{{ recent_activities|length }} recent items</span>
    </div>
    <div class="activity-list">
      {% for activity in recent_activities %}
      <div class="activity-item">
        <div class="activity-icon">
          {% if activity.type == 'proposal' %}
            <i class="fas fa-clipboard-list"></i>
          {% elif activity.type == 'report' %}
            <i class="fas fa-file-alt"></i>
          {% elif activity.type == 'user' %}
            <i class="fas fa-user-plus"></i>
          {% else %}
            <i class="fas fa-bell"></i>
          {% endif %}
        </div>
        <div class="activity-content">
          <p class="activity-description">{{ activity.description }}</p>
          <div class="activity-meta">
            <span class="activity-user">by {{ activity.user }}</span>
            <span class="activity-time">{{ activity.timestamp|timesince }} ago</span>
            <span class="status-badge status-{{ activity.status }}">{{ activity.status|title }}</span>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    <div class="activity-footer">
      <a href="/core-admin/event-proposals/" class="view-all-link">View All Proposals â†’</a>
    </div>
  </div>
  {% endif %}

  <!-- System Status Bar -->
  <div class="system-status">
    <div class="status-item">
      <div class="status-indicator {% if stats.database_status == 'Operational' %}status-green{% else %}status-red{% endif %}"></div>
      <span>Database: {{ stats.database_status }}</span>
    </div>
    <div class="status-item">
      <div class="status-indicator {% if stats.email_status == 'Active' %}status-green{% else %}status-yellow{% endif %}"></div>
      <span>Email Service: {{ stats.email_status }}</span>
    </div>
    <div class="status-item">
      <div class="status-indicator {% if '7' in stats.storage_status or '8' in stats.storage_status %}status-yellow{% else %}status-green{% endif %}"></div>
      <span>Storage: {{ stats.storage_status }}</span>
    </div>
    <div class="status-item">
      <div class="status-indicator status-green"></div>
      <span>Last Backup: {{ stats.last_backup }}</span>
    </div>
  </div>
</div>

<!-- Fixed Download Button -->
<a href="{% url 'data_export_filter' %}" class="fixed-download-btn" title="Export Data">
  <i class="fas fa-download"></i>
</a>

<div class="admin-switch-section">
    {% if is_impersonating %}
        <!-- Currently impersonating -->
        <div class="impersonation-card">
            <div class="impersonation-info">
                <h4>ðŸŽ­ Currently Viewing As</h4>
                <p><strong>{{ user.get_full_name|default:user.username }}</strong></p>
                <p>{{ user.email }}</p>
            </div>
            <a href="{% url 'stop_impersonation' %}" class="btn-stop-impersonation">
                Stop Impersonation
            </a>
        </div>
    {% else %}
        <!-- Switch user button -->
        <div class="switch-user-card">
            <h4>ðŸ‘¤ Switch User View</h4>
            <p>View the website as any user</p>
            <button class="btn-switch-user" onclick="openSwitchModal()">
                Switch User
            </button>
        </div>
    {% endif %}
</div>

<!-- Simple Switch Modal -->
<div class="switch-modal" id="switchModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Switch User</h3>
            <button class="close-btn" onclick="closeSwitchModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="text" 
                   id="userSearch" 
                   placeholder="Search by name or email..." 
                   onkeyup="searchUsers()">
            
            <div class="users-list" id="usersList">
                <div class="loading">Type to search users...</div>
            </div>
        </div>
    </div>
</div>

<script>
function openSwitchModal() {
    document.getElementById('switchModal').style.display = 'flex';
    document.getElementById('userSearch').focus();
}

function closeSwitchModal() {
    document.getElementById('switchModal').style.display = 'none';
    document.getElementById('usersList').innerHTML = '<div class="loading">Type to search users...</div>';
    document.getElementById('userSearch').value = '';
}

let searchTimeout;

function searchUsers() {
    const searchTerm = document.getElementById('userSearch').value;
    const usersList = document.getElementById('usersList');
    
    clearTimeout(searchTimeout);
    
    if (searchTerm.length < 2) {
        usersList.innerHTML = '<div class="loading">Type to search users...</div>';
        return;
    }
    
    usersList.innerHTML = '<div class="loading">Searching...</div>';
    
    searchTimeout = setTimeout(() => {
        fetch('/api/search-users/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                search: searchTerm
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.users && data.users.length > 0) {
                usersList.innerHTML = data.users.map(user => `
                    <div class="user-item">
                        <div class="user-info">
                            <h5>${user.full_name || user.username}</h5>
                            <small>${user.email}</small>
                        </div>
                        <button class="btn-impersonate" onclick="impersonateUser(${user.id})">
                            Switch
                        </button>
                    </div>
                `).join('');
            } else {
                usersList.innerHTML = '<div class="loading">No users found</div>';
            }
        })
        .catch(error => {
            usersList.innerHTML = '<div class="loading">Error searching users</div>';
        });
    }, 300);
}

function impersonateUser(userId) {
    fetch('{% url "impersonate_user" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            user_id: userId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeSwitchModal();
            window.location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error switching user');
    });
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('switchModal');
    if (event.target === modal) {
        closeSwitchModal();
    }
});
</script>

{% endblock %}