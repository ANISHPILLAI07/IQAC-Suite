{% extends "base.html" %}
{% load static %}

{% block title %}Admin Dashboard – Event Management Suite{% endblock %}

{% block head_extra %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="{% static 'core/css/admin_dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="ems-dashboard admin-dash">

  <!-- Topbar -->
  <header class="topbar">
    <div>
      <h1>Welcome, {{ request.user.first_name|default:request.user.username }}</h1>
      <span class="topbar-date">{% now "F j, Y · l" %}</span>
    </div>
  </header>

  <!-- KPI Row -->
  <section class="kpi-row">
    <div class="kpi-card">
      <div class="kpi-icon bg-indigo"><i class="fa-solid fa-user-graduate"></i></div>
      <div class="kpi-content">
        <span class="kpi-title">Students</span>
        <span class="kpi-value">{{ stats.students|default:0 }}</span>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-icon bg-sky"><i class="fa-solid fa-chalkboard-user"></i></div>
      <div class="kpi-content">
        <span class="kpi-title">Faculties</span>
        <span class="kpi-value">{{ stats.faculties|default:0 }}</span>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-icon bg-orange"><i class="fa-solid fa-user-tie"></i></div>
      <div class="kpi-content">
        <span class="kpi-title">HODs</span>
        <span class="kpi-value">{{ stats.hods|default:0 }}</span>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-icon bg-emerald"><i class="fa-solid fa-building-columns"></i></div>
      <div class="kpi-content">
        <span class="kpi-title">Centers / Organizations</span>
        <span class="kpi-value">{{ stats.centers|default:0 }}</span>
      </div>
    </div>

    <!-- Profile KPI -->
    <div class="profile-kpi card">
      <div class="pkp-avatar">
        {% if request.user.profile and request.user.profile.photo %}
        <img src="{{ request.user.profile.photo.url }}"
          alt="{{ request.user.get_full_name|default:request.user.username }}">
        {% else %}
        <span class="pkp-initials">
          {% if request.user.first_name %}
          {{ request.user.first_name.0|upper }}
          {% if request.user.last_name %}{{ request.user.last_name.0|upper }}{% endif %}
          {% else %}
          {{ request.user.username.0|upper }}
          {% endif %}
        </span>
        {% endif %}
      </div>

      <div class="pkp-body">
        <h1 class="pkp-name">{{ request.user.get_full_name|default:request.user.username }}</h1>
        <h2 class="pkp-sub">{{ request.user.email }}</h2>

        <!-- Switch User Dropdown -->
        <div class="pkp-actions">
          <label class="switch-label" for="roleSwitch">Switch to:</label>
          <select id="roleSwitch" class="switch-select">
            <option value="" selected>Choose CDL view…</option>
            <option value="{% url 'cdl_head_dashboard' %}">CDL Head Dashboard</option>
            <option value="{% url 'cdl_work_dashboard' %}">CDL Team Dashboard</option>
          </select>
        </div>
      </div>
    </div>
  </section>

  <!-- Main Grid -->
  <main class="grid-3">

    <!-- Event Proposals -->
    <section class="card eq" data-card="proposals">
      <div class="card-header">
        <h3><i class="fa-solid fa-file-signature"></i> Event Proposals Overview</h3>
      </div>
      <div class="stats-rows">
        <div class="sr"><span>Total</span><strong>{{ stats.total_proposals|default:0 }}</strong></div>
        <div class="sr"><span>Pending</span><strong>{{ stats.pending_proposals|default:0 }}</strong></div>
        <div class="sr"><span>Approved</span><strong class="ok">{{ stats.approved_proposals|default:0 }}</strong></div>
        <div class="sr"><span>Rejected</span><strong class="bad">{{ stats.rejected_proposals|default:0 }}</strong></div>
        <a id="viewAllProposals" class="chip-btn" href="/core-admin/event-proposals/">View All</a>
      </div>
    </section>

    <!-- Event Reports Overview -->
    <section class="card eq">
      <div class="card-header">
        <h3><i class="fa-solid fa-clipboard-list"></i> Event Reports Overview</h3>
      </div>
      <div class="stats-rows">
        <div class="sr"><span>Total Reports</span><strong>{{ stats.total_event_reports|default:0 }}</strong></div>
        <div class="sr"><span>Pending</span><strong>{{ stats.pending_event_reports|default:0 }}</strong></div>
        <div class="sr"><span>Reviewed</span><strong class="ok">{{ stats.reviewed_event_reports|default:0 }}</strong>
        </div>
        <div class="sr"><span>Rejected</span><strong class="bad">{{ stats.rejected_event_reports|default:0 }}</strong>
        </div>
        <a class="chip-btn" href="/core-admin/event-reports/">View Reports</a>
      </div>
    </section>

    <!-- System Overview -->
    <section class="card eq">
      <div class="card-header">
        <h3><i class="fa-solid fa-gauge-high"></i> System Overview</h3>
      </div>
      <div class="stats-rows">
        <div class="sr"><span>Total Users</span><strong>{{ stats.total_users|default:0 }}</strong></div>
        <div class="sr"><span>Active Users</span><strong>{{ stats.active_users|default:0 }}</strong></div>
        <div class="sr"><span>New This Week</span><strong>{{ stats.new_users_this_week|default:0 }}</strong></div>
        <div class="sr"><span>Reports</span><strong>{{ stats.total_reports|default:0 }}</strong></div>
        <a class="chip-btn" href="/core-admin/users/">Manage Users</a>
      </div>
    </section>

    <!-- Organizations -->
    <section class="card eq">
      <div class="card-header">
        <h3><i class="fa-solid fa-sitemap"></i> Organizations</h3>
      </div>
      <div class="stats-rows">
        <div class="sr"><span>Departments</span><strong>{{ stats.departments|default:0 }}</strong></div>
        <div class="sr"><span>Clubs</span><strong>{{ stats.clubs|default:0 }}</strong></div>
        <div class="sr"><span>Total Organizations</span><strong>{{ stats.centers|default:0 }}</strong></div>
        <a class="chip-btn" href="/core-admin/master-data/">View Organizations</a>
      </div>
    </section>

    <!-- Notifications & Calendar side by side -->
    <div class="grid-2">
      <!-- Notifications -->
      <section class="card" id="cardNotifications">
        <div class="card-header">
          <h3><i class="fa-regular fa-bell"></i> Notifications</h3>
        </div>
        <div class="list list-scroll">
          {% if recent_activities %}
          {% for a in recent_activities %}
          <article class="list-item">
            <div class="bullet"><i class="fa-solid fa-circle-info"></i></div>
            <div class="list-body">
              <h4>{{ a.title }}</h4>
              <p class="muted">{{ a.description }}</p>
            </div>
            {% if a.status %}
            <span class="pill status-{{ a.status|lower }}">{{ a.status }}</span>
            {% endif %}
          </article>
          {% endfor %}
          {% else %}
          <div class="empty">No notifications.</div>
          {% endif %}
        </div>
      </section>

      <!-- Calendar -->
      <section class="card" id="cardCalendar">
        <div class="card-header">
          <h3><i class="fa-regular fa-calendar-days"></i> Calendar</h3>
        </div>
        <div id="calendar"></div>
      </section>
    </div>
  </main>

  <!-- System Status Bar -->
  <section class="sysbar">
    <div class="chip">
      DB:
      <strong class="{% if stats.database_status == 'OK' %}ok{% else %}bad{% endif %}">
        {{ stats.database_status|default:"—" }}
      </strong>
    </div>
    <div class="chip">
      Email:
      <strong class="{% if stats.email_status == 'OK' %}ok{% else %}bad{% endif %}">
        {{ stats.email_status|default:"—" }}
      </strong>
    </div>
    <div class="chip">
      Storage:
      <strong class="{% if stats.storage_status == 'OK' %}ok{% else %}bad{% endif %}">
        {{ stats.storage_status|default:"—" }}
      </strong>
    </div>
    <div class="chip">
      Last Backup:
      <strong>{{ stats.last_backup|default:"—" }}</strong>
    </div>

    <!-- Export Button -->
    <a id="btnExport" class="btn-solid right" href="{% url 'data_export_filter' %}">
      <i class="fa-solid fa-download"></i> Export
    </a>
  </section>

</div>
{% endblock %}

{% block scripts_extra %}
<!-- Example: using FullCalendar (you can swap to other libs if needed) -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
      const select = document.getElementById('roleSwitch');
      if (select) {
        select.addEventListener('change', function () {
          const target = this.value.trim();
          if (target) window.location.href = target;
        });
      }

      // Initialize Calendar with proper configuration
      const calendarEl = document.getElementById('calendar');
      if (calendarEl) {
        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          height: 400,
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: ''
          },
          dayMaxEvents: false,
          showNonCurrentDates: true,
          fixedWeekCount: false,
          // Ensure proper day name formatting
          dayHeaderFormat: { weekday: 'short' },
          // Force proper locale (this should fix day names)
          locale: 'en',
          // Ensure table layout is not broken
          aspectRatio: 1.2,
          events: [], // you can populate events dynamically here

          // Additional options to ensure proper rendering
          displayEventTime: false,
          eventDisplay: 'block',
          dayHeaderClassNames: 'custom-day-header'
        });

        // Render the calendar
        calendar.render();

        // Force a re-render after a short delay to fix any layout issues
        setTimeout(() => {
          calendar.updateSize();
        }, 100);
      }
    });
</script>
{% endblock %}