{% extends "base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'core/css/admin_user_edit.css' %}">

<div class="container user-edit-container">
  <h1>Edit User</h1>

  {% if messages %}
    <ul class="messages">
      {% for msg in messages %}
        <li class="message {{ msg.tags }}">{{ msg }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  <form id="user-edit-form" method="post" autocomplete="off">
    {% csrf_token %}

    <!-- ── Basic info ─────────────────────────────── -->
    <div class="form-group">
      <label>First Name</label>
      <input type="text" name="first_name" value="{{ user_obj.first_name }}" required>
    </div>
    <div class="form-group">
      <label>Last Name</label>
      <input type="text" name="last_name" value="{{ user_obj.last_name }}">
    </div>
    <div class="form-group">
      <label>Email</label>
      <input type="email" name="email" value="{{ user_obj.email }}" required>
    </div>

    <hr>

    <!-- ── Roles & assignments ────────────────────── -->
    <div class="roles-section">
      <h3>User Roles &amp; Assignments</h3>

      <div id="roles-list-container">
        {% for form in formset.forms %}
        <div class="role-card" data-form-index="{{ forloop.counter0 }}">
          {{ form.id }}{{ form.DELETE }}

          <div class="field-group">
            <select class="org-type-select">
              <option value="">Select Category</option>
              {% for ot in organization_types %}
              <option value="{{ ot.id }}" {% if form.instance.organization and form.instance.organization.org_type.id == ot.id %}selected{% endif %}>{{ ot.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="field-group">
            {{ form.organization }}
          </div>

          <div class="field-group">
            {{ form.role }}
          </div>

          <button type="button" class="remove-role-btn">×</button>
        </div>
        {% endfor %}
      </div>

      {{ formset.management_form }}

      <button type="button" id="add-role-btn" class="btn-add-role">+ Add Role</button>
    </div>

    <div class="form-btn-group">
      <button type="submit" class="btn-submit">Save</button>
      <a href="{% url 'admin_user_management' %}" class="btn-cancel">Cancel</a>
    </div>
  </form>
</div>

<!-- ── Empty-form prototype (hidden) ─────────────── -->
<template id="role-card-template">
  <div class="role-card" data-form-index="__prefix__">
    {{ formset.empty_form.id }}{{ formset.empty_form.DELETE }}

    <div class="field-group">
      <select class="org-type-select">
        <option value="">Select Category</option>
        {% for ot in organization_types %}
        <option value="{{ ot.id }}">{{ ot.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="field-group">
      {{ formset.empty_form.organization }}
    </div>

    <div class="field-group">
      {{ formset.empty_form.role }}
    </div>

    <button type="button" class="remove-role-btn">×</button>
  </div>
</template>
<script>
  const ORG_ROLES = {{ org_roles_json|safe }};
  const BASE_ROLES = {{ role_choices_json|safe }};
  const ORGS_BY_TYPE = {{ orgs_by_type_json|safe }};
  const ROLES_BY_TYPE = {{ roles_by_type_json|safe }};
</script>
<script src="{% static 'core/js/admin_user_edit.js' %}"></script>
{% endblock %}
