{% extends "base.html" %}
{% load static %}

{% block head_extra %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.colVis.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<link rel="stylesheet" href="{% static 'core/css/admin_history.css' %}">
{% endblock %}

{% block content %}
<div class="admin-history-container">
  <h1 class="history-title">Activity History</h1>
  <form method="get" class="history-filter-form">
    <input type="text" id="history-search-input" name="q" placeholder="Search..." value="{{ q }}" list="history-suggestions">
    <datalist id="history-suggestions">
      {% for item in suggestions %}
        <option value="{{ item }}">
      {% endfor %}
    </datalist>
    <input type="date" name="start" value="{{ start }}">
    <input type="date" name="end" value="{{ end }}">
    <button type="submit">Filter</button>
    {% if q or start or end %}
      <a href="{% url 'admin_history' %}" class="btn-reset">Reset</a>
    {% endif %}
  </form>
  <div class="table-responsive">
    <table class="history-table table table-striped table-bordered" id="historyTable">
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>User</th>
          <th>Action</th>
          <th>Description</th>
          <th>IP</th>
        </tr>
      </thead>
      <tbody>
        {% for log in logs %}
        <tr>
          <td>{{ log.timestamp|date:"Y-m-d H:i" }}</td>
          <td>{{ log.user.get_full_name|default:log.user.username|default:"System" }}</td>
          <td><a href="{% url 'admin_history_detail' log.pk %}">{{ log.action }}</a></td>
          <td>{{ log.description|default:"-" }}</td>
          <td>{{ log.ip_address|default:"-" }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5">No activity found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
<script>
$(document).ready(function() {
  $('#historyTable').DataTable({
    responsive: true,
    dom: '<"dt-toolbar d-flex justify-content-between align-items-center flex-wrap mb-3"lBf>rtip',
    buttons: [
      { extend: 'copy', className: 'btn btn-secondary' },
      { extend: 'excel', className: 'btn btn-success' },
      { extend: 'csv', className: 'btn btn-info' },
      { extend: 'print', className: 'btn btn-primary' },
      { extend: 'colvis', className: 'btn btn-secondary' }
    ]
  });
});
</script>
{% endblock %}
