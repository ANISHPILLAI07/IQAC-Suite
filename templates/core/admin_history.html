{% extends "base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'core/css/admin_history.css' %}">
<div class="admin-history-container">
  <h1 class="history-title">Activity History</h1>
  <form method="get" class="history-filter-form">
    <input type="text" id="history-search-input" name="q" placeholder="Search..." value="{{ q }}" list="history-suggestions">
    <datalist id="history-suggestions">
      {% for item in suggestions %}
        <option value="{{ item }}">
      {% endfor %}
    </datalist>
    <input type="date" name="start" value="{{ start }}">
    <input type="date" name="end" value="{{ end }}">
    <button type="submit">Filter</button>
    {% if q or start or end %}
      <a href="{% url 'admin_history' %}" class="btn-reset">Reset</a>
    {% endif %}
  </form>
  <button type="button" class="btn-select-all" id="select-all-btn">Select All</button>
  <div class="table-responsive">
    <table class="history-table">
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>User</th>
          <th>Action</th>
          <th>Description</th>
          <th>IP</th>
        </tr>
      </thead>
      <tbody>
        {% for log in logs %}
        <tr>
          <td>{{ log.timestamp|date:"Y-m-d H:i" }}</td>
          <td>{{ log.user.get_full_name|default:log.user.username|default:"System" }}</td>
          <td><a href="{% url 'admin_history_detail' log.pk %}">{{ log.action }}</a></td>
          <td>{{ log.description|default:"-" }}</td>
          <td>{{ log.ip_address|default:"-" }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5">No activity found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% if logs.has_other_pages %}
  <div class="pagination">
    {% if logs.has_previous %}
      <a href="?q={{ q }}&start={{ start }}&end={{ end }}&page={{ logs.previous_page_number }}" class="page-link">&laquo;</a>
    {% endif %}
    <span class="page-current">Page {{ logs.number }} of {{ logs.paginator.num_pages }}</span>
    {% if logs.has_next %}
      <a href="?q={{ q }}&start={{ start }}&end={{ end }}&page={{ logs.next_page_number }}" class="page-link">&raquo;</a>
    {% endif %}
  </div>
  {% endif %}
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('history-search-input');
  const rows = Array.from(document.querySelectorAll('.history-table tbody tr'));
  searchInput.addEventListener('input', function() {
    const term = this.value.toLowerCase();
    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(term) ? '' : 'none';
    });
  });
  const selectAllBtn = document.getElementById('select-all-btn');
  selectAllBtn.addEventListener('click', function() {
    const table = document.querySelector('.history-table');
    const range = document.createRange();
    range.selectNodeContents(table);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
  });
});
</script>
{% endblock %}
