{% extends "base.html" %}
{% load static %}

{% block head_extra %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.colVis.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<link rel="stylesheet" href="{% static 'core/css/admin_history.css' %}">
{% endblock %}

{% block content %}
<div class="admin-history-container">
  <h1 class="history-title">Activity History</h1>
  <form method="get" class="history-filter-form d-flex flex-wrap align-items-end gap-2 mb-3">
    <div class="form-group">
      <label for="history-search-input" class="form-label">Search</label>
      <input type="text" id="history-search-input" name="q" class="form-control form-control-sm" placeholder="Search..." value="{{ q }}" list="history-suggestions">
      <datalist id="history-suggestions">
        {% for item in suggestions %}
          <option value="{{ item }}">
        {% endfor %}
      </datalist>
    </div>
    <div class="form-group">
      <label for="start" class="form-label">Start date</label>
      <input type="date" id="start" name="start" class="form-control form-control-sm" value="{{ start }}">
    </div>
    <div class="form-group">
      <label for="end" class="form-label">End date</label>
      <input type="date" id="end" name="end" class="form-control form-control-sm" value="{{ end }}">
    </div>
    <div class="form-group">
      <button type="submit" class="btn btn-sm btn-primary">Filter</button>
    </div>
    {% if q or start or end %}
    <div class="form-group">
      <a href="{% url 'admin_history' %}" class="btn btn-sm btn-outline-secondary btn-reset">Reset</a>
    </div>
    {% endif %}
  </form>
  {% if q or start or end %}
  <div class="alert alert-info py-2 small">
    {% if q %}Search: <strong>{{ q }}</strong>{% endif %}
    {% if start or end %}
      {% if q %}<span class="mx-1">|</span>{% endif %}
      Date:
      {% if start %}from {{ start }}{% endif %}
      {% if start and end %} to {% endif %}
      {% if end %}{{ end }}{% endif %}
    {% endif %}
  </div>
  {% endif %}
  <div class="table-responsive">
    <table class="history-table table table-striped table-bordered" id="historyTable">
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>User</th>
          <th>Action</th>
          <th>Description</th>
          <th>IP</th>
        </tr>
      </thead>
      <tbody>
        {% for log in logs %}
        <tr>
          <td>{{ log.timestamp|date:"Y-m-d H:i" }}</td>
          <td>{{ log.user.get_full_name|default:log.user.username|default:"System" }}</td>
          <td><a href="{% url 'admin_history_detail' log.pk %}">{{ log.action }}</a></td>
          <td>{{ log.description|default:"-" }}</td>
          <td>{{ log.ip_address|default:"-" }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5">No activity found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
<script>
$(document).ready(function() {
  $('#historyTable').DataTable({
    responsive: true,
    dom: '<"dt-toolbar d-flex justify-content-between align-items-center flex-wrap mb-3"lB>rtip',
    buttons: [
      { extend: 'copy', className: 'btn btn-secondary' },
      { extend: 'excel', className: 'btn btn-success' },
      { extend: 'csv', className: 'btn btn-info' },
      { extend: 'print', className: 'btn btn-primary' },
      { extend: 'colvis', className: 'btn btn-secondary' }
    ],
    initComplete: function() {
      $(".history-filter-form").appendTo('.dt-toolbar').removeClass('mb-3').addClass('mb-0');
    }
  });
});
</script>
{% endblock %}
