{% extends "base.html" %}
{% load static %}

{% block title %}Master Data Management{% endblock %}

{% block head_extra %}
    <link rel="stylesheet" href="{% static 'core/css/admin_master_data.css' %}?v=1.5">
{% endblock %}

{% block content %}
<div class="main-container">
    
    <div class="page-header">
        <h1>Master Data Management</h1>
        <!-- Academic Year Dropdown -->
        <div class="academic-year-filter">
            <label for="academicYearSelect">Academic Year:</label>
            <select id="academicYearSelect" onchange="setAcademicYear(this.value)">
                {% for year in academic_years %}
                    <option value="{{ year.value }}" {% if year.value == selected_year.value %}selected{% endif %}>
                        {{ year.display }}
                    </option>
                {% endfor %}
            </select>
            <button class="btn btn-secondary btn-sm" onclick="showAddAcademicYearForm()" title="Add New Academic Year">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </div>

    <!-- Controls Section for Search and Add -->
    <div class="controls-container">
        <div class="search-bar">
            <i class="fas fa-search"></i>
            <input type="text" id="universalSearch" placeholder="Search for any entry...">
        </div>
        <div class="main-actions">
            <button class="btn btn-primary" id="addNewEntryBtn">
                <i class="fas fa-plus"></i> Add New Entry
            </button>
        </div>
    </div>

    <!-- Inline Add Form Container (hidden by default) -->
    <div id="add-form-container" class="add-form-container" style="display: none;">
        <div class="form-group">
            <label for="categorySelect">Category</label>
            <select id="categorySelect">
                <option value="Department">Department</option>
                <option value="Club">Club</option>
                <option value="Center">Center</option>
                <option value="Cell">Cell</option>
                <option value="Association">Association</option>
            </select>
        </div>
        <div class="form-group">
            <label for="newEntryName">Name</label>
            <input type="text" id="newEntryName" placeholder="Enter the name">
        </div>
        <!-- Department dropdown for Associations, hidden by default -->
        <div id="association-department-group" class="form-group" style="display: none;">
            <label for="associationDepartmentSelect">Assign to Department</label>
            <select id="associationDepartmentSelect">
                <option value="" disabled selected>Select a Department</option>
                {% for dept in active_departments %}
                    {% if dept.is_active %}
                        <option value="{{ dept.id }}">{{ dept.name }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>
        <div class="form-actions">
            <button class="btn btn-primary" id="addEntryConfirmBtn">
                <i class="fas fa-check"></i> Add
            </button>
            <button class="btn btn-secondary" id="addEntryCancelBtn">Cancel</button>
        </div>
    </div>

    <div class="widget-grid">
        <!-- Department Widget -->
        <div class="data-widget" data-widget-name="department">
            <div class="widget-header"><div class="widget-title">Departments</div></div>
            <div class="widget-content">
                <table class="data-table">
                    <thead><tr><th>Name</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody>
                        {% for entry in departments %}
                        <tr data-id="{{ entry.id }}" class="{% if not entry.is_active %}inactive-row-display{% endif %}">
                            <td data-label="Name">{{ entry.name }}</td>
                            <td data-label="Status">
                                <span class="status-badge status-{% if entry.is_active %}active{% else %}inactive{% endif %}">
                                    {% if entry.is_active %}Active{% else %}Inactive{% endif %}
                                </span>
                            </td>
                            <td data-label="Actions" class="actions">
                                <button class="btn btn-edit"><i class="fas fa-pen"></i></button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="3" class="text-center">No departments found.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Other Widgets (Clubs, Centers, etc.) -->
        {% include 'partials/master_data_widget.html' with category_name="Clubs" entries=clubs model_name="club" %}
        {% include 'partials/master_data_widget.html' with category_name="Centers" entries=centers model_name="center" %}
        {% include 'partials/master_data_widget.html' with category_name="Cells" entries=cells model_name="cell" %}
        {% include 'partials/master_data_widget.html' with category_name="Associations" entries=associations model_name="association" is_association=True %}
    </div>

    <!-- "Not Found" message for search -->
    <div id="search-not-found" class="search-not-found" style="display: none;">
        <p>No results found for "<strong></strong>".</p>
        <button class="btn btn-primary" id="addFromSearchBtn">
            <i class="fas fa-plus"></i> Add as New Entry
        </button>
    </div>

</div>

<!-- Toast Notification -->
<div id="toast-notification" class="toast"></div>

{% endblock %}

{% block scripts %}
<script src="{% static 'core/js/admin_settings.js' %}?v=1.5" defer></script>
<script>
    function setAcademicYear(year) {
        // Store the selected academic year in localStorage
        localStorage.setItem('selectedAcademicYear', year);
        
        // Send to server to store in session
        fetch('/core-admin/set-academic-year/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ academic_year: year })
        }).then(() => {
            // Redirect to the new year
            window.location.href = '?year=' + encodeURIComponent(year);
        }).catch(() => {
            // Fallback if AJAX fails
            window.location.href = '?year=' + encodeURIComponent(year);
        });
    }
    
    function showAddAcademicYearForm() {
        const year = prompt("Enter new academic year (format: YYYY-YYYY):\nExample: 2025-2026");
        if (year && year.match(/^\d{4}-\d{4}$/)) {
            addAcademicYear(year);
        } else if (year) {
            alert("Please enter academic year in correct format: YYYY-YYYY (e.g., 2025-2026)");
        }
    }
    
    function addAcademicYear(yearString) {
        fetch('/core-admin/add-academic-year/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ academic_year: yearString })
        }).then(response => response.json())
        .then(data => {
            if (data.success) {
                // Refresh the page to show the new academic year
                window.location.reload();
            } else {
                alert(data.error || 'Failed to add academic year');
            }
        }).catch(() => {
            alert('Error adding academic year');
        });
    }
    
    // Set initial academic year in localStorage
    document.addEventListener('DOMContentLoaded', function() {
        const currentYear = "{% if selected_year.value %}{{ selected_year.value }}{% else %}2025-2026{% endif %}";
        localStorage.setItem('selectedAcademicYear', currentYear);
    });
</script>
{% endblock %}
