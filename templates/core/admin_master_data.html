{% extends "base.html" %}
{% load static %}
{% load dict_filters %}

{% block title %}Master Data Management{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="{% static 'core/css/admin_master_data.css' %}?v=1.5">
{% endblock %}

{% block content %}
<div class="main-container">

  <div class="page-header">
    <h1>Master Data Management</h1>
    <div class="academic-year-filter">
      <label for="academicYearSelect">Academic Year:</label>
      <select id="academicYearSelect" onchange="setAcademicYear(this.value)">
        {% for year in academic_years %}
          <option value="{{ year.value }}" {% if year.value == selected_year.value %}selected{% endif %}>
            {{ year.display }}
          </option>
        {% endfor %}
      </select>
      <button class="btn btn-secondary btn-sm" onclick="showAddAcademicYearForm()" title="Add New Academic Year">
        <i class="fas fa-plus"></i>
      </button>
    </div>
  </div>

  <div class="controls-container">
    <div class="search-bar">
      <i class="fas fa-search"></i>
      <input type="text" id="universalSearch" placeholder="Search for any entry...">
    </div>
    <div class="main-actions">
      <button class="btn btn-primary" id="addNewEntryBtn">
        <i class="fas fa-plus"></i> Add New Entry
      </button>
      <button class="btn btn-secondary" id="addNewCategoryBtn" style="margin-left: 10px;">
        <i class="fas fa-layer-group"></i> Add New Category
      </button>
    </div>
  </div>

  <!-- Inline Add Entry Form Container -->
  <div id="add-form-container" class="add-form-container" style="display: none;">
    <div class="form-group">
      <label for="categorySelect">Category</label>
      <select id="categorySelect">
  {% for org_type in org_types %}
    <option 
      value="{{ org_type.name|lower }}"
      data-can-have-parent="{% if org_type.can_have_parent %}true{% else %}false{% endif %}"
      data-parent-type="{% if org_type.parent_type %}{{ org_type.parent_type.name|lower }}{% endif %}">
      {{ org_type.name }}
    </option>
  {% endfor %}
</select>

    </div>
    <div class="form-group">
      <label for="newEntryName">Name</label>
      <input type="text" id="newEntryName" placeholder="Enter the name">
    </div>
    <div id="parent-organization-group" class="form-group" style="display: none;">
      <label for="parentOrganizationSelect">Parent Organization</label>
      <select id="parentOrganizationSelect">
        <option value="" disabled selected>Select Parent</option>
        <!-- Dynamically filled by JS -->
      </select>
    </div>
    <div class="form-actions">
      <button class="btn btn-primary" id="addEntryConfirmBtn">
        <i class="fas fa-check"></i> Add
      </button>
      <button class="btn btn-secondary" id="addEntryCancelBtn">Cancel</button>
    </div>
  </div>

  <!-- Add New Category Form -->
  <div id="add-category-container" class="add-form-container" style="display: none; margin-top: 12px;">
    <div class="form-group">
      <label for="newCategoryName">Category Name</label>
      <input type="text" id="newCategoryName" placeholder="Enter new category (e.g., Committee)">
    </div>
    <div class="form-group">
      <label><input type="checkbox" id="hasParentCategory"> Has a parent category?</label>
    </div>
    <div class="form-group" id="parentCategoryGroup" style="display: none;">
      <label for="parentCategorySelect">Parent Category</label>
      <select id="parentCategorySelect">
        <option value="">-- Select Parent Category --</option>
        {% for org_type in org_types %}
          <option value="{{ org_type.id }}">{{ org_type.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="form-actions">
      <button class="btn btn-primary" id="addCategoryConfirmBtn">
        <i class="fas fa-check"></i> Add Category
      </button>
      <button class="btn btn-secondary" id="addCategoryCancelBtn">Cancel</button>
    </div>
  </div>

  <div class="widget-grid">
    {% for org_type in org_types %}
      <div class="data-widget" data-widget-name="{{ org_type.name|lower }}">
        <div class="widget-header">
          <div class="widget-title">
            {{ org_type.name }}{% if not org_type.name|lower == 'cell' %}s{% endif %}
          </div>
        </div>
        <div class="widget-content">
          <table class="data-table">
            <thead>
              <tr>
                <th>Name</th>
                {% if org_type.can_have_parent %}
                  <th>Parent</th>
                {% endif %}
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for entry in orgs_by_type|get_item:org_type.name %}
                <tr data-id="{{ entry.id }}" class="{% if not entry.is_active %}inactive-row-display{% endif %}">
                  <td data-label="Name">{{ entry.name }}</td>
                  {% if org_type.can_have_parent %}
                    <td data-label="Parent">
                      {% if entry.parent %}
                        {{ entry.parent.name }}
                      {% else %}
                        -
                      {% endif %}
                    </td>
                  {% endif %}
                  <td data-label="Status">
                    <span class="status-badge status-{% if entry.is_active %}active{% else %}inactive{% endif %}">
                      {% if entry.is_active %}Active{% else %}Inactive{% endif %}
                    </span>
                  </td>
                  <td data-label="Actions" class="actions">
                    <button class="btn btn-edit"><i class="fas fa-pen"></i></button>
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="{% if org_type.can_have_parent %}4{% else %}3{% endif %}" class="text-center">
                    No {{ org_type.name|lower }}s found.
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endfor %}
  </div>

  <div id="search-not-found" class="search-not-found" style="display: none;">
    <p>No results found for "<strong></strong>".</p>
    <button class="btn btn-primary" id="addFromSearchBtn">
      <i class="fas fa-plus"></i> Add as New Entry
    </button>
  </div>
</div>

<div id="toast-notification" class="toast"></div>
{% endblock %}

{% block scripts %}
<script>
  // Make sure your Django view passes this!
  const orgsByType = JSON.parse('{{ orgs_by_type_json|safe }}');

  function setAcademicYear(year) {
    localStorage.setItem('selectedAcademicYear', year);
    fetch('/core-admin/set-academic-year/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({ academic_year: year })
    }).then(() => {
      window.location.href = '?year=' + encodeURIComponent(year);
    }).catch(() => {
      window.location.href = '?year=' + encodeURIComponent(year);
    });
  }

  function showAddAcademicYearForm() {
    const year = prompt("Enter new academic year (format: YYYY-YYYY):\nExample: 2025-2026");
    if (year && year.match(/^\d{4}-\d{4}$/)) {
      addAcademicYear(year);
    } else if (year) {
      alert("Please enter academic year in correct format: YYYY-YYYY (e.g., 2025-2026)");
    }
  }

  function addAcademicYear(yearString) {
    fetch('/core-admin/add-academic-year/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({ academic_year: yearString })
    }).then(response => response.json())
    .then(data => {
      if (data.success) {
        window.location.reload();
      } else {
        alert(data.error || 'Failed to add academic year');
      }
    }).catch(() => {
      alert('Error adding academic year');
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    const currentYear = "{% if selected_year.value %}{{ selected_year.value }}{% else %}2025-2026{% endif %}";
    localStorage.setItem('selectedAcademicYear', currentYear);

    // --- Add New Entry (Organization) Form ---
    const categorySelect = document.getElementById("categorySelect");
    const parentOrgGroup = document.getElementById("parent-organization-group");
    const parentOrgSelect = document.getElementById("parentOrganizationSelect");

    function handleCategoryChange() {
      if (!categorySelect || !parentOrgGroup) return;
      const selectedOption = categorySelect.options[categorySelect.selectedIndex];
      const canHaveParent = selectedOption.getAttribute('data-can-have-parent') === 'true';
      const parentType = selectedOption.getAttribute('data-parent-type');
      parentOrgGroup.style.display = canHaveParent ? 'block' : 'none';

      if (canHaveParent && parentType && orgsByType[parentType]) {
        // Fill parentOrgSelect with orgs of parentType
        parentOrgSelect.innerHTML = `<option value="" disabled selected>Select Parent</option>`;
        orgsByType[parentType].forEach(org => {
          parentOrgSelect.innerHTML += `<option value="${org.id}">${org.name}</option>`;
        });
      } else {
        parentOrgSelect.innerHTML = `<option value="" disabled selected>Select Parent</option>`;
      }
    }

    if (categorySelect) {
      categorySelect.addEventListener('change', handleCategoryChange);
      handleCategoryChange(); // on page load
    }

    document.getElementById("addNewEntryBtn").onclick = function() {
      document.getElementById("add-form-container").style.display = "block";
      document.getElementById("add-category-container").style.display = "none";
      handleCategoryChange(); // Refresh parent select in case the default changed
    };
    document.getElementById("addEntryCancelBtn").onclick = function() {
      document.getElementById("add-form-container").style.display = "none";
      document.getElementById("newEntryName").value = "";
      if (parentOrgSelect) parentOrgSelect.value = "";
    };

    document.getElementById("addEntryConfirmBtn").onclick = function() {
      const name = document.getElementById("newEntryName").value.trim();
      const selectedOption = categorySelect.options[categorySelect.selectedIndex];
      const category = categorySelect.value;
      const canHaveParent = selectedOption.getAttribute('data-can-have-parent') === 'true';
      let parent = null;
      if (canHaveParent) {
        parent = parentOrgSelect.value;
        if (!parent) {
          alert("Please select the parent organization.");
          return;
        }
      }
      if (!name) {
        alert("Please enter a name.");
        return;
      }
      let postData = { name: name, org_type: category };
      if (parent) postData.parent = parent;

      fetch("/core-admin/settings/organization/add/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify(postData)
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          window.location.reload();
        } else {
          alert(data.error || "Failed to add entry.");
        }
      })
      .catch(() => alert("Failed to add entry!"));
    };

    // --- Add New Category (OrganizationType) Form ---
    document.getElementById("addNewCategoryBtn").onclick = function() {
      document.getElementById("add-category-container").style.display = "block";
      document.getElementById("add-form-container").style.display = "none";
    };
    document.getElementById("addCategoryCancelBtn").onclick = function() {
      document.getElementById("add-category-container").style.display = "none";
      document.getElementById("newCategoryName").value = "";
      document.getElementById("hasParentCategory").checked = false;
      document.getElementById("parentCategoryGroup").style.display = "none";
      document.getElementById("parentCategorySelect").value = "";
    };

    // Checkbox toggles parent category select
    document.getElementById("hasParentCategory").onchange = function() {
      document.getElementById("parentCategoryGroup").style.display = this.checked ? "block" : "none";
      if (!this.checked) {
        document.getElementById("parentCategorySelect").value = "";
      }
    };

    document.getElementById("addCategoryConfirmBtn").onclick = function() {
      const name = document.getElementById("newCategoryName").value.trim();
      const hasParent = document.getElementById("hasParentCategory").checked;
      let parent = null;
      if (hasParent) {
        parent = document.getElementById("parentCategorySelect").value;
        if (!parent) {
          alert("Please select a parent category.");
          return;
        }
      }
      if (!name) {
        alert("Enter a category name.");
        return;
      }
      let payload = { name: name };
      if (parent) payload.parent = parent;

      fetch("/core-admin/settings/organization_type/add/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          window.location.reload();
        } else {
          alert(data.error || "Failed to add category.");
        }
      })
      .catch(() => alert("Failed to add category!"));
    };
  });
</script>
{% endblock %}
