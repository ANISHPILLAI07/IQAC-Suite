{# templates/core/data_export_filter.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}Advanced Data Export & Filter - IQAC Suite{% endblock %}

{% block head_extra %}
<!-- DataTables CSS + Buttons (CDN) -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">

<style>
/* ---------- Layout & Theme ---------- */
* { margin:0; padding:0; box-sizing:border-box; }
html,body { height:100%; }
body {
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  color:#2d3748;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

/* Container */
.export-container {
  max-width:1400px;
  margin: 28px auto;
  padding: 20px;
}

/* Header */
.export-header {
  background: rgba(255,255,255,0.96);
  border-radius:16px;
  padding: 28px;
  position:relative;
  overflow:hidden;
  box-shadow: 0 18px 40px rgba(0,0,0,0.08);
  border: 1px solid rgba(255,255,255,0.12);
}
.export-header::before {
  content: "";
  position:absolute;
  left:0;right:0;top:0;height:6px;
  background: linear-gradient(90deg,#667eea,#764ba2,#f093fb,#f5576c);
  background-size:200% 100%;
  mix-blend-mode:screen;
  opacity:0.95;
}
.export-title {
  font-size: 1.95rem;
  font-weight: 800;
  display:flex;
  gap:12px;
  align-items:center;
  color: #1a202c;
  letter-spacing: -0.02em;
}
.export-title i { font-size: 1.25rem; color: #667eea; }
.export-subtitle { margin-top:8px; color:#485058; opacity:0.95; }

/* Filter card */
.filter-section {
  margin-top:18px;
  background: rgba(255,255,255,0.96);
  padding:16px;
  border-radius:12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.06);
  border: 1px solid rgba(255,255,255,0.06);
}
.section-title { font-size:1.15rem; font-weight:700; display:flex;gap:10px;align-items:center;color:#293241;margin-bottom:12px; }

/* Quick filters */
.quick-filters { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; }
.quick-filter-btn {
  padding:8px 12px;
  border-radius:999px;
  border:1px solid rgba(102,126,234,0.12);
  background: rgba(102,126,234,0.06);
  color:#1f2937;
  cursor:pointer;
  font-weight:700;
  font-size:0.92rem;
  display:inline-flex;
  gap:8px;
  align-items:center;
  transition: transform .12s ease, box-shadow .12s ease;
}
.quick-filter-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102,126,234,0.08); }
.quick-filter-btn.active { background: linear-gradient(135deg,#667eea,#764ba2); color:white; border:none; }

/* Search input & suggestions */
.search-container { position:relative; margin-bottom:12px; }
.search-input {
  width:100%;
  padding:12px 14px 12px 44px;
  border-radius:12px;
  border:1px solid #e6eef8;
  font-size:1rem;
  background:rgba(255,255,255,0.96);
  box-shadow: inset 0 1px 0 rgba(0,0,0,0.02);
}
.search-icon { position:absolute; left:14px; top:50%; transform:translateY(-50%); color:#667eea; font-size:14px; }
.suggestions-dropdown {
  position:absolute;
  left:0; right:0;
  top: calc(100% + 8px);
  background:white;
  border-radius:10px;
  box-shadow:0 10px 30px rgba(0,0,0,0.12);
  max-height:280px;
  overflow:auto;
  z-index:1200;
  display:none;
  padding:8px;
}
.suggestion-item { padding:10px 12px; cursor:pointer; border-radius:8px; }
.suggestion-item:hover { background:#f3f6ff; }
.suggestion-category { font-size:0.72rem; color:#4c66d6; font-weight:800; margin-bottom:6px; text-transform:uppercase; letter-spacing:0.06em; }
.suggestion-label { font-weight:700; color:#222; }

/* Active filters chips */
.active-filters { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; margin-bottom:6px; align-items:center; min-height:42px;}
.filter-chip {
  background: linear-gradient(135deg,#667eea,#764ba2);
  color:white;
  padding:8px 10px;
  border-radius:999px;
  font-weight:700;
  display:inline-flex;
  gap:8px;
  align-items:center;
  font-size:0.9rem;
}
.filter-chip .remove-filter { background: rgba(255,255,255,0.15); border:none; color:white; width:22px; height:22px; border-radius:50%; cursor:pointer; font-weight:700; }

/* Results */
.results-section { margin-top:14px; background: rgba(255,255,255,0.96); padding:12px; border-radius:12px; box-shadow: 0 10px 30px rgba(0,0,0,0.06); border:1px solid rgba(255,255,255,0.06); }
.results-header { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:8px; }
.results-count { font-weight:800; color:#1f2937; display:flex; gap:8px; align-items:center; }
.export-controls { display:flex; gap:8px; align-items:center; }

.export-btn {
  padding:8px 12px;
  border-radius:10px;
  border:none;
  color:white;
  cursor:pointer;
  font-weight:700;
  display:inline-flex;
  gap:8px;
  align-items:center;
}
.dataTables_scrollBody {
    overflow-y: auto !important;
    overflow-x: auto !important;
}

.dataTables_scrollHead {
    background: white;
    position: sticky;
    top: 0;
    z-index: 5;
}

.dataTables_scrollBody::-webkit-scrollbar {
    height: 8px;
    background-color: #f1f1f1;
}

.dataTables_scrollBody::-webkit-scrollbar-thumb {
    background-color: #2c5aa0;
    border-radius: 4px;
}

.export-btn.csv { background:#2563eb; } /* blue */
.export-btn.excel { background:#16a34a; } /* green */

/* Loading and empty */
.loading-indicator { text-align:center; padding:16px; display:none; color:#475569; }
.empty-state { text-align:center; padding:28px; color:#60708a; }

/* Results preview area */
.results-preview { background: rgba(247,250,252,0.72); border-radius:10px; padding:10px; overflow:auto; }

/* Small responsive tweaks */
@media (max-width:900px) {
  .export-header { padding:16px; }
  .export-title { font-size:1.4rem; }
  .quick-filter-btn { font-size:0.88rem; padding:6px 10px; }
}

/* DataTables tweaks */
.dataTables_wrapper .dt-buttons { margin-bottom: 8px; }
</style>
{% endblock %}

{% block content %}
<div class="export-container">
  <div class="export-header">
    <div style="display:flex; gap:12px; align-items:center; justify-content:space-between;">
      <div>
        <h1 class="export-title"><i class="fas fa-filter" aria-hidden="true"></i> Advanced Data Export & Analytics</h1>
        <div class="export-subtitle">Powerful search, intelligent filtering, and seamless data export — results shown below and available for export.</div>
      </div>
      <div style="display:flex; gap:12px; align-items:center;">
        {# Optional action icons could go here #}
        <img src="{% static 'core/img/logo-small.png' %}" alt="logo" style="height:38px; opacity:0.9;">
      </div>
    </div>
  </div>

  <div class="filter-section" role="region" aria-label="Filters">
    <h3 class="section-title"><i class="fas fa-search" aria-hidden="true"></i> Smart Search & Filtering</h3>

    <div class="quick-filters" id="quickFilters" aria-hidden="false">
      <!-- kept only working/validated quick filters -->
      <button class="quick-filter-btn" data-filter="profile_role:faculty"><i class="fas fa-chalkboard-teacher" aria-hidden="true"></i> Faculty Members</button>
      <button class="quick-filter-btn" data-filter="profile_role:student"><i class="fas fa-user-graduate" aria-hidden="true"></i> Students</button>
      <button class="quick-filter-btn" data-filter="date_range:30_days"><i class="fas fa-clock" aria-hidden="true"></i> Last 30 Days</button>
      <button class="quick-filter-btn" data-filter="date_range:academic_year"><i class="fas fa-school" aria-hidden="true"></i> This Academic Year</button>
    </div>

    <div class="search-container" role="search" aria-label="Global search">
      <i class="fas fa-search search-icon" aria-hidden="true"></i>
      <input id="mainSearch" class="search-input" type="text" placeholder="Search anything (name, org, event, report) — Press Enter to search" aria-label="Search input">
      <div id="suggestionsDropdown" class="suggestions-dropdown" role="listbox" aria-hidden="true"></div>
    </div>

    <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
      <div style="font-weight:700; color:#3b4252;">Filter Logic:</div>
      <button class="logic-btn" data-logic="AND" style="padding:6px 10px; border-radius:8px; border:1px solid #e6eef8; background:#fff; font-weight:800;">AND</button>
      <button class="logic-btn" data-logic="OR" style="padding:6px 10px; border-radius:8px; border:1px solid #e6eef8; background:#fff; font-weight:800;">OR</button>
      <div style="margin-left:auto; font-size:0.9rem; color:#475569;">Tip: press <kbd>Enter</kbd> to search text globally</div>
    </div>

    <div class="active-filters" id="activeFilters" aria-live="polite">
      <div class="empty-filters" style="padding:8px; background:rgba(160,174,192,0.06); border-radius:8px;">
        <i class="fas fa-info-circle" aria-hidden="true"></i> No filters applied. Use quick filters or search.
      </div>
    </div>
  </div>

  <div class="results-section" role="region" aria-label="Results">
    <div class="results-header">
      <div class="results-count" id="resultsCount"><i class="fas fa-database" style="color:#667eea;"></i> Ready to search</div>
      <div class="export-controls">
        <button id="exportCsvBackend" class="export-btn csv" title="Export CSV (server)" aria-label="Export CSV">Export CSV (Server)</button>
        <button id="exportExcelBackend" class="export-btn excel" title="Export Excel (server)" aria-label="Export Excel">Export Excel (Server)</button>
      </div>
    </div>

    <div id="loadingIndicator" class="loading-indicator" role="status" aria-hidden="true">
      <div style="width:40px;height:40px;border:4px solid rgba(102,126,234,0.12);border-top:4px solid #667eea;border-radius:50%;margin:0 auto 10px; animation:spin 1s linear infinite;"></div>
      <div><strong>Searching — fetching results...</strong></div>
    </div>

    <div class="results-preview" id="resultsPreview" aria-live="polite">
      <div class="empty-state">
        <i class="fas fa-search" style="font-size:40px;color:#667eea;display:block;margin-bottom:8px;"></i>
        <h3>Ready to Explore Data</h3>
        <p>Apply filters or use the search bar to discover insights — results will appear here and be interactive.</p>
      </div>
    </div>
  </div>
</div>

{# CSRF token is included as hidden input so JS can read it if needed #}
<form style="display:none;">{% csrf_token %}</form>

<!-- jQuery + DataTables + Buttons CDN -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.11.0/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

<script>
/* eslint-disable no-undef */
(function () {
  // DOM elements
  const searchInput = document.getElementById('mainSearch');
  const suggestionsDropdown = document.getElementById('suggestionsDropdown');
  const quickFilterBtns = document.querySelectorAll('.quick-filter-btn');
  const activeFiltersContainer = document.getElementById('activeFilters');
  const resultsPreview = document.getElementById('resultsPreview');
  const resultsCountElt = document.getElementById('resultsCount');
  const loadingIndicator = document.getElementById('loadingIndicator');
  const exportCsvBackend = document.getElementById('exportCsvBackend');
  const exportExcelBackend = document.getElementById('exportExcelBackend');
  const logicButtons = document.querySelectorAll('.logic-btn');

  // State
  let suggestions = [];
  let filters = []; // { raw, type, value, label }
  let filterLogic = 'AND';
  let currentDataTable = null;

  // CSRF helper (tries hidden form token then cookie)
  function getCSRF() {
    // first try the hidden input
    const tokenInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
    if (tokenInput && tokenInput.value) return tokenInput.value;
    // fallback to cookie
    const name = 'csrftoken';
    const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    return match ? match[2] : '';
  }
  const CSRF = getCSRF();

  // Init
  fetchSuggestions();
  bindQuickFilters();
  bindSearch();
  bindLogicButtons();
  bindBackendExports();

  // ---------- fetch suggestions ----------
  async function fetchSuggestions() {
    try {
      const resp = await fetch('/api/filter-suggestions/');
      if (!resp.ok) throw new Error('Failed fetching suggestions');
      suggestions = await resp.json();
    } catch (err) {
      // fallback small set
      suggestions = [
        { category: 'Users', label: 'Faculty Members', filter: 'profile_role:faculty', description: 'All faculty members' },
        { category: 'Users', label: 'Students', filter: 'profile_role:student', description: 'All students' },
        { category: 'Date Range', label: 'Last 30 Days', filter: 'date_range:30_days', description: 'Data from last 30 days' },
        { category: 'Date Range', label: 'This Academic Year', filter: 'date_range:academic_year', description: 'This academic year' },
      ];
    }
  }

  // ---------- Quick filters ----------
  function bindQuickFilters() {
    quickFilterBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const raw = btn.dataset.filter;
        // toggle active appearance
        btn.classList.toggle('active');
        if (filters.some(f => f.raw === raw)) {
          // remove filter
          filters = filters.filter(f => f.raw !== raw);
        } else {
          addFilterFromRaw(raw, /*noRender*/ true);
        }
        renderActiveFilters();
        executeSearch();
      });
    });
  }

  function addFilterFromRaw(raw, skipDuplicateToast) {
    if (!raw) return;
    if (filters.some(f => f.raw === raw)) {
      if (!skipDuplicateToast) showToast('Filter already applied', 'info');
      return;
    }
    const [type, ...rest] = raw.split(':');
    const value = rest.join(':') || 'true';
    const match = suggestions.find(s => s.filter === raw);
    const label = match ? match.label : `${type}: ${value}`;
    filters.push({ raw, type, value: String(value), label });
    renderActiveFilters();
  }

  // ---------- Search & suggestions ----------
  function bindSearch() {
    searchInput.addEventListener('input', (e) => {
      handleSearchInput(e.target.value);
    });

    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const q = searchInput.value.trim();
        if (!q) return;
        addSearchFilter(q);
        searchInput.value = '';
        hideSuggestions();
      } else if (e.key === 'Escape') {
        hideSuggestions();
      }
    });

    document.addEventListener('click', (e) => {
      if (!searchInput.contains(e.target) && !suggestionsDropdown.contains(e.target)) {
        hideSuggestions();
      }
    });
  }

  function handleSearchInput(text) {
    const q = (text || '').trim().toLowerCase();
    if (q.length < 2) {
      hideSuggestions();
      return;
    }
    const list = suggestions.filter(s =>
      (s.label || '').toLowerCase().includes(q) ||
      (s.description || '').toLowerCase().includes(q) ||
      (s.category || '').toLowerCase().includes(q) ||
      (s.filter || '').toLowerCase().includes(q)
    ).slice(0, 12);

    showSuggestions(list, q);
  }

  function showSuggestions(list, q) {
    if (!list.length) {
      suggestionsDropdown.style.display = 'none';
      suggestionsDropdown.innerHTML = '';
      return;
    }
    let html = '';
    let currentCategory = '';
    list.forEach(item => {
      if (item.category !== currentCategory) {
        html += `<div class="suggestion-item" style="background:transparent; cursor:default;"><div class="suggestion-category">${escapeHtml(item.category)}</div></div>`;
        currentCategory = item.category;
      }
      html += `<div class="suggestion-item" role="option" data-filter="${escapeHtml(item.filter)}"><div class="suggestion-label">${highlight(item.label || '', q)}</div><div style="font-size:.85rem;color:#6b7280;margin-top:6px;">${highlight(item.description || '', q)}</div></div>`;
    });
    html += `<div class="suggestion-item" data-filter="search:__raw__${encodeURIComponent(q)}" style="font-style:italic;color:#4b5563;">Search for "<strong>${escapeHtml(q)}</strong>" across all data</div>`;
    suggestionsDropdown.innerHTML = html;
    suggestionsDropdown.style.display = 'block';
    suggestionsDropdown.setAttribute('aria-hidden', 'false');

    suggestionsDropdown.querySelectorAll('.suggestion-item[data-filter]').forEach(el => {
      el.addEventListener('click', () => {
        const raw = el.dataset.filter;
        if (raw.startsWith('search:__raw__')) {
          const qterm = decodeURIComponent(raw.replace('search:__raw__', ''));
          addSearchFilter(qterm);
        } else {
          addFilterFromRaw(raw);
        }
        searchInput.value = '';
        hideSuggestions();
        executeSearch();
      });
    });
  }

  function hideSuggestions() {
    suggestionsDropdown.style.display = 'none';
    suggestionsDropdown.innerHTML = '';
    suggestionsDropdown.setAttribute('aria-hidden', 'true');
  }

  function addSearchFilter(query) {
    const raw = `search:${query}`;
    if (filters.some(f => f.raw === raw)) { showToast('Filter already applied', 'info'); return; }
    filters.push({ raw, type: 'search', value: query, label: `Search: ${query}` });
    renderActiveFilters();
    executeSearch();
  }

  // ---------- Active filters UI ----------
  function renderActiveFilters() {
    if (!filters.length) {
      activeFiltersContainer.innerHTML = `<div class="empty-filters" style="padding:8px;background:rgba(160,174,192,0.06);border-radius:8px;"><i class="fas fa-info-circle"></i> No filters applied. Use quick filters or search.</div>`;
      // remove quick filter active class if none selected
      quickFilterBtns.forEach(b => {
        if (filters.every(f => !b.dataset.filter || !filters.some(x => x.raw === b.dataset.filter))) {
          b.classList.remove('active');
        }
      });
      return;
    }
    activeFiltersContainer.innerHTML = filters.map((f, idx) => `
      <div class="filter-chip" title="${escapeHtml(f.raw)}">
        <span>${escapeHtml(f.label)}</span>
        <button class="remove-filter" title="Remove" data-idx="${idx}">&times;</button>
      </div>
    `).join('');
    activeFiltersContainer.querySelectorAll('.remove-filter').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const idx = Number(e.currentTarget.dataset.idx);
        const raw = filters[idx] && filters[idx].raw;
        filters.splice(idx, 1);
        // also remove matching quick-filter active if any
        quickFilterBtns.forEach(b => { if (b.dataset.filter === raw) b.classList.remove('active'); });
        renderActiveFilters();
        executeSearch();
      });
    });
  }

  // ---------- Logic buttons ----------
  function bindLogicButtons() {
    logicButtons.forEach(btn => {
      btn.addEventListener('click', (e) => {
        logicButtons.forEach(b => b.style.background = '#fff');
        e.currentTarget.style.background = 'linear-gradient(135deg,#667eea,#764ba2)';
        filterLogic = e.currentTarget.dataset.logic || 'AND';
        if (filters.length) executeSearch();
      });
    });
    // set default AND style
    const defaultBtn = document.querySelector('.logic-btn[data-logic="AND"]');
    if (defaultBtn) defaultBtn.style.background = 'linear-gradient(135deg,#667eea,#764ba2)';
  }

  // ---------- Execute search (backend) ----------
  async function executeSearch() {
    if (!filters.length) {
      clearResultsPreview();
      return;
    }

    showLoading(true);

    const payloadFilters = filters.map(f => ({ type: f.type, value: String(f.value), label: f.label || f.raw }));

    try {
      const resp = await fetch('/api/execute-filter/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF },
        body: JSON.stringify({ filters: payloadFilters, logic: filterLogic, unlimited: true })
      });
      if (!resp.ok) {
        const text = await resp.text();
        throw new Error('Server returned ' + resp.status + ' - ' + text);
      }
      const data = await resp.json();
      const results = Array.isArray(data.results) ? data.results : (data.results || []);
      renderResultsTable(results);
      showToast(`Found ${results.length} records`, 'success');
    } catch (err) {
      console.error('Search error:', err);
      showToast('Search failed. Check console for details.', 'error');
      clearResultsPreview();
    } finally {
      showLoading(false);
    }
  }

  // ---------- DataTable rendering ----------
  function renderResultsTable(rows) {
    resultsPreview.innerHTML = '';
    if (!rows || !rows.length) {
      resultsCountElt.innerHTML = `<i class="fas fa-database" style="color:#667eea;"></i> 0 records found`;
      resultsPreview.innerHTML = `<div class="empty-state"><i class="fas fa-search-minus" style="font-size:36px;color:#667eea;"></i><h3>No Results Found</h3><p>Try different filters or search terms.</p></div>`;
      destroyDataTable();
      return;
    }

    // collect header order deterministically
    const headersSet = new Set();
    rows.forEach(r => Object.keys(r).forEach(k => headersSet.add(k)));
    const headers = Array.from(headersSet);

    const tableId = 'dynamicResultsTable';
    let html = `<table id="${tableId}" class="display nowrap" style="width:100%"><thead><tr>`;
    headers.forEach(h => html += `<th>${formatHeader(h)}</th>`);
    html += `</tr></thead><tbody>`;
    rows.forEach(r => {
      html += '<tr>';
      headers.forEach(h => {
        let cell = (r[h] === null || r[h] === undefined) ? '' : r[h];
        // basic string conversion
        html += `<td>${escapeHtml(String(cell))}</td>`;
      });
      html += '</tr>';
    });
    html += `</tbody></table>`;
    resultsPreview.innerHTML = html;

    resultsCountElt.innerHTML = `<i class="fas fa-database" style="color:#667eea;"></i> ${rows.length.toLocaleString()} records found`;
    // init datatable
    setTimeout(() => initDataTable('#' + tableId), 10);
  }

  function formatHeader(h) {
    return h.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
  }

  function destroyDataTable() {
    if (currentDataTable) {
      try { currentDataTable.destroy(true); } catch (e) { /* ignore */ }
      currentDataTable = null;
      // remove table DOM left-over classes
      const existing = document.querySelector('.dataTables_wrapper');
      if (existing && existing.parentNode && existing.parentNode.id === 'resultsPreview') {
        // leave as is; initialization will recreate wrapper
      }
    }
  }

  function initDataTable(selector) {
    destroyDataTable();
    // eslint-disable-next-line no-undef
    currentDataTable = $(selector).DataTable({
      scrollX: true,
      responsive: true,
      dom: 'Bflrtip',
      buttons: [
        { extend: 'copyHtml5', text: 'Copy' },
        { extend: 'csvHtml5', text: 'CSV' },
        { extend: 'excelHtml5', text: 'Excel' },
        { extend: 'pdfHtml5', text: 'PDF' },
        { extend: 'print', text: 'Print' }
      ],
      pageLength: 25,
      lengthMenu: [10, 25, 50, 100, 250],
      order: []
    });
  }

  // ---------- Backend export (uses same filter payload) ----------
  function bindBackendExports() {
    exportCsvBackend.addEventListener('click', async () => {
      if (!filters.length) { showToast('No filters applied.', 'warning'); return; }
      const payload = filters.map(f => ({ type: f.type, value: String(f.value), label: f.label || f.raw }));
      try {
        const resp = await fetch('/api/export-data/csv/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF },
          body: JSON.stringify({ filters: payload, logic: filterLogic })
        });
        if (!resp.ok) throw new Error('Export failed: ' + resp.status);
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `export_${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        showToast('CSV exported (server)', 'success');
      } catch (err) {
        console.error(err);
        showToast('Backend CSV export failed', 'error');
      }
    });

    exportExcelBackend.addEventListener('click', async () => {
      if (!filters.length) { showToast('No filters applied.', 'warning'); return; }
      const payload = filters.map(f => ({ type: f.type, value: String(f.value), label: f.label || f.raw }));
      try {
        const resp = await fetch('/api/export-data/excel/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF },
          body: JSON.stringify({ filters: payload, logic: filterLogic })
        });
        if (!resp.ok) throw new Error('Export failed: ' + resp.status);
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `export_${new Date().toISOString().slice(0,10)}.xlsx`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        showToast('Excel exported (server)', 'success');
      } catch (err) {
        console.error(err);
        showToast('Backend Excel export failed', 'error');
      }
    });


  }

  // ---------- Helpers ----------
  function clearResultsPreview() {
    resultsPreview.innerHTML = `<div class="empty-state"><i class="fas fa-search" style="font-size:40px;color:#667eea;display:block;margin-bottom:8px;"></i><h3>Ready to Explore Data</h3><p>Apply filters or use the search bar to discover insights from your datasets. Results will appear here and be interactive.</p></div>`;
    resultsCountElt.innerHTML = `<i class="fas fa-database" style="color:#667eea;"></i> Ready to search`;
    destroyDataTable();
  }

  function showLoading(state) {
    loadingIndicator.style.display = state ? 'block' : 'none';
    if (state) {
      resultsPreview.style.opacity = '0.4';
      resultsPreview.setAttribute('aria-busy', 'true');
    } else {
      resultsPreview.style.opacity = '1';
      resultsPreview.setAttribute('aria-busy', 'false');
    }
  }

  function escapeHtml(str) {
    if (str === null || str === undefined) return '';
    return String(str).replace(/[&<>"'`=\/]/g, function (s) {
      return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', '/': '&#x2F;', '`': '&#x60;', '=': '&#x3D;' })[s];
    });
  }

  function highlight(text, q) {
    if (!q) return escapeHtml(text);
    try {
      const re = new RegExp('(' + q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'ig');
      return escapeHtml(text).replace(re, '<mark style="background:#667eea;color:#fff;padding:0 4px;border-radius:3px;">$1</mark>');
    } catch (err) {
      return escapeHtml(text);
    }
  }

  function showToast(message, type = 'info') {
    const colors = { success: '#16a34a', error: '#e53e3e', warning: '#f97316', info: '#2563eb' };
    const icon = { success: 'check-circle', error: 'exclamation-circle', warning: 'exclamation-triangle', info: 'info-circle' };
    const el = document.createElement('div');
    el.style.position = 'fixed';
    el.style.right = '20px';
    el.style.top = '20px';
    el.style.padding = '10px 14px';
    el.style.borderRadius = '8px';
    el.style.color = '#fff';
    el.style.zIndex = 99999;
    el.style.background = colors[type] || colors.info;
    el.style.boxShadow = '0 8px 20px rgba(0,0,0,0.12)';
    el.style.fontWeight = '700';
    el.innerHTML = `<i class="fas fa-${icon[type] || 'info-circle'}" style="margin-right:8px;"></i> ${escapeHtml(message)}`;
    document.body.appendChild(el);
    setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 3000);
  }
  $('#resultsTable').DataTable({
        dom: 'Bfrtip',
        buttons: ['copy', 'csv', 'excel', 'pdf', 'print'],
        scrollY: "60vh",
        scrollX: true,
        scrollCollapse: true,
        fixedHeader: true,
        paging: true,
        responsive: false
    });

})();
</script>
{% endblock %}
