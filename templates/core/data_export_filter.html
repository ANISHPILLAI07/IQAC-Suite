{# templates/core/data_export_filter.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}Advanced Data Export & Filter — Event Management Suite{% endblock %}

{% block head_extra %}
  <!-- Typography & Icons (same as Master Data) -->
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

  <!-- DataTables CSS + Buttons -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">

  <style>
    /* ===== Master-Data aligned: white bg, compact, blue palette ===== */
    :root{
      --primary:#1e60b1; --primary-dark:#164c8d;
      --ink:#0f172a; --muted:#64748b; --border:#e5e7eb;
      --surf:#ffffff; --subtle:#f8fafc;
      --light-grey:#eef2f7; --dark-grey:#6b7280;
      --shadow:0 8px 24px rgba(2,6,23,.06);
      --shadow-lg:0 12px 40px rgba(2,6,23,.10);
      --shadow-sm:0 4px 12px rgba(2,6,23,.04);
      --radius:14px;
    }

    /* Page shell — top-left start, white background */
    .ems-export{ margin:0; padding:16px; background:#fff;
      font-family:"Open Sans",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; color:var(--ink); }

    /* PAGE HEADER (same pattern as Master Data) */
    .page-header{ margin:0 0 12px 0; }
    .page-header h1{ margin:0; font-size:clamp(20px,2.2vw,28px); font-weight:800; color:var(--ink); letter-spacing:-.01em; }
    .page-header p{ margin:4px 0 0; color:var(--muted); font-size:13px; }

    /* Controls row (tabs + toolbar) */
    .controls{ display:flex; gap:10px; align-items:stretch; flex-wrap:wrap; margin:0 0 8px; }
    .tabs{ display:flex; gap:8px; }
    .tab-btn{
      border:1px solid var(--border); background:#fff; color:#475569;
      border-radius:10px; padding:10px 14px; font-weight:800; font-size:13px; line-height:1;
      cursor:pointer; transition:.18s ease;
    }
    .tab-btn:hover{ transform:translateY(-1px); box-shadow:var(--shadow-sm); }
    .tab-btn.active{
      background:linear-gradient(135deg,var(--primary) 0%, #4f62b6 100%); color:#fff; border-color:var(--primary);
    }

    .controls-right{ margin-left:auto; display:flex; gap:8px; align-items:stretch; }
    .toolbar{ display:flex; gap:8px; align-items:stretch; min-width:280px; }

    .search{
      flex:1; display:flex; align-items:center; gap:8px;
      border:1px solid var(--border); background:#fff; border-radius:10px; padding:10px 12px;
    }
    .search input{ border:none; outline:none; background:transparent; width:100%; font-size:14px; color:var(--ink); }

    .btn{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--border); background:#fff; color:#334155;
      font-weight:800; font-size:13px; line-height:1; padding:10px 12px; border-radius:10px;
      cursor:pointer; transition:.18s ease; text-decoration:none;
    }
    .btn:hover{ transform:translateY(-1px); box-shadow:var(--shadow-sm); }
    .btn-primary{ background:linear-gradient(135deg,var(--primary) 0%, #4f62b6 100%); color:#fff; border-color:var(--primary); }
    .btn-primary:hover{ filter:brightness(1.05); }
    .btn-danger{ background:#ef4444; color:#fff; border-color:#ef4444; }
    .btn-danger:hover{ filter:brightness(1.05); }

    /* Active filters chips (same tone as MD activity list) */
    .active-filters{
      display:flex; flex-wrap:wrap; gap:8px;
      background:#fff; border:1px solid var(--border); border-radius:12px;
      padding:10px; margin-top:8px;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      background:#f1f5f9; color:#334155; border:1px solid var(--border);
      font-weight:800; font-size:12px; border-radius:10px; padding:8px 10px; transition:.18s ease;
    }
    .chip:hover{ transform:translateY(-1px); box-shadow:var(--shadow-sm); }
    .chip .remove{ width:22px; height:22px; display:inline-grid; place-items:center; border-radius:6px; border:none;
      cursor:pointer; background:transparent; color:#64748b; }
    .chip .remove:hover{ background:#e2e8f0; color:#334155; }

    /* Results area uses the same card spec as MD lists */
    .results{
      background:#fff; border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:14px; margin-top:10px;
    }
    .results-header{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding-bottom:10px; border-bottom:1px solid #f1f5f9; margin-bottom:10px;
    }
    .results-count{ font-weight:800; color:var(--primary); font-size:14px; }
    .results-meta{ color:var(--muted); font-size:12px; }

    /* DataTables typography */
    .dataTables_wrapper, #resultsTable{
      font-family:"Open Sans",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; font-size:13px;
    }

    /* Offcanvas (Filters) */
    .offcanvas-backdrop.show{ opacity:.35; }
    .offcanvas .form-label{ font-weight:800; }
    .drawer-actions{ display:flex; gap:8px; margin-top:12px; }

    /* Responsive */
    @media (max-width:900px){
      .controls{ flex-direction:column; }
      .controls-right{ margin-left:0; }
      .toolbar{ width:100%; }
    }
  </style>
{% endblock %}

{% block content %}
<div class="ems-export" data-page="export">

  <!-- Page header (no box) -->
  <div class="page-header">
    <h1>Advanced Data Export & Filter</h1>
    <p>Search across Events, Users, Reports, and Organizations. Use the drawer to refine results.</p>
  </div>

  <!-- Controls -->
  <div class="controls" role="region" aria-label="Search and export controls">
    <div class="tabs" role="tablist" aria-label="Category selector">
      <button class="tab-btn active" data-category="events" role="tab" aria-selected="true">Events</button>
      <button class="tab-btn" data-category="users" role="tab" aria-selected="false">Users</button>
      <button class="tab-btn" data-category="reports" role="tab" aria-selected="false">Reports</button>
      <button class="tab-btn" data-category="organizations" role="tab" aria-selected="false">Organizations</button>
    </div>

    <div class="controls-right">
      <div class="toolbar" role="group" aria-label="Search, Filters and Export">
        <label class="search" for="globalSearch">
          <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
          <input id="globalSearch" type="search" placeholder="Press Enter to search…" aria-label="Global search">
        </label>
        <button id="openFilters" class="btn btn-primary" title="Open filters" aria-label="Open filters">
          <i class="fa-solid fa-sliders"></i><span>Filters</span>
        </button>
        <button id="exportCsv" class="btn" title="Export CSV">
          <i class="fa-regular fa-file-lines"></i><span>CSV</span>
        </button>
        <button id="exportExcel" class="btn" title="Export Excel">
          <i class="fa-regular fa-file-excel"></i><span>Excel</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Active filters -->
  <div class="active-filters" id="activeFilters" aria-live="polite"></div>

  <!-- Results -->
  <section class="results">
    <div class="results-header">
      <div class="results-count" id="resultsCount">Ready — select a category or apply filters</div>
      <div class="results-meta"><small id="resultsMeta"></small></div>
    </div>

    <div style="width:100%; overflow:auto;">
      <table id="resultsTable" class="display nowrap" style="width:100%;">
        <thead><tr id="resultsHead"></tr></thead>
        <tbody id="resultsBody"></tbody>
      </table>
    </div>
  </section>
</div>

{# Filter Drawer (Bootstrap offcanvas) #}
<div class="offcanvas offcanvas-end" tabindex="-1" id="filterDrawer" aria-labelledby="filterDrawerLabel">
  <div class="offcanvas-header">
    <h5 id="filterDrawerLabel" class="m-0">Filters</h5>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <form id="filterForm">
      <div id="filterFields"></div>
      <div class="drawer-actions">
        <button type="button" id="applyFilters" class="btn">Apply</button>
        <button type="button" id="clearFilters" class="btn btn-danger">Clear</button>
      </div>
    </form>
  </div>
</div>

{# CSRF token for JS #}
<form style="display:none;">{% csrf_token %}</form>
{% endblock %}

{% block scripts %}
  <!-- Dependencies -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.11.0/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  /* eslint-disable no-undef */
  (function () {
    // ----- Helpers -----
    const csrftoken = (() => {
      const input = document.querySelector('input[name="csrfmiddlewaretoken"]');
      if (input) return input.value;
      const m = document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)');
      return m ? m.pop() : '';
    })();

    function apiUrl(name, param) {
      const map = {
        'org_types': "{% url 'api_org_types' %}",
        'orgs_by_type': "{% url 'api_orgs_by_type' %}",
        'filter_meta': "{% url 'api_filter_meta' 'events' %}",
        'search': "{% url 'api_search' %}",
        'export_csv': "{% url 'api_export_csv' %}",
        'export_excel': "{% url 'api_export_excel' %}",
        'page': "{% url 'data_export_filter' %}"
      };
      if (name === 'orgs_by_type') {
        return "{% url 'api_orgs_by_type' %}?org_type_id=" + encodeURIComponent(param || '');
      }
      if (name === 'filter_meta') {
        const base = "{% url 'api_filter_meta' 'events' %}";
        return base.replace('events', param || 'events');
      }
      return map[name];
    }

    // ----- State & DOM -----
    let currentCategory = 'events';
    let appliedFilters = []; // {type,value,label,parent?}
    let dt = null;

    const tabBtns = document.querySelectorAll('.tab-btn[data-category]');
    const searchInput = document.getElementById('globalSearch');
    const openFiltersBtn = document.getElementById('openFilters');
    const filterDrawerEl = document.getElementById('filterDrawer');
    const filterDrawer = new bootstrap.Offcanvas(filterDrawerEl);
    const filterFieldsContainer = document.getElementById('filterFields');
    const applyFiltersBtn = document.getElementById('applyFilters');
    const clearFiltersBtn = document.getElementById('clearFilters');
    const activeFiltersEl = document.getElementById('activeFilters');
    const resultsCount = document.getElementById('resultsCount');
    const resultsMeta = document.getElementById('resultsMeta');
    const resultsHead = document.getElementById('resultsHead');
    const resultsBody = document.getElementById('resultsBody');
    const exportCsvBtn = document.getElementById('exportCsv');
    const exportExcelBtn = document.getElementById('exportExcel');

    // ----- Init -----
    function init(){
      bindTabs(); bindSearch(); bindDrawer(); bindExport(); loadInitialResults();
    }

    function bindTabs(){
      tabBtns.forEach(btn=>{
        btn.addEventListener('click',()=>{
          tabBtns.forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          currentCategory = btn.dataset.category;
          appliedFilters = appliedFilters.filter(f=>f.type==='search'); // keep free-text only
          renderActiveFilters();
          loadInitialResults();
        });
      });
    }

    function bindSearch(){
      searchInput.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter'){
          const q = searchInput.value.trim();
          if (!q) return;
          const idx = appliedFilters.findIndex(f=>f.type==='search');
          if (idx>=0) appliedFilters.splice(idx,1);
          appliedFilters.push({ type:'search', value:q, label:`Search: ${q}` });
          renderActiveFilters();
          doSearch();
          searchInput.value = '';
        }
      });
    }

    function bindDrawer(){
      openFiltersBtn.addEventListener('click', ()=>{
        fetch(apiUrl('filter_meta', currentCategory), { headers:{'X-CSRFToken': csrftoken} })
          .then(r=>r.json())
          .then(meta=>{
            buildFilterFieldsForCategory(currentCategory, meta.filters || {});
            filterDrawer.show();
          })
          .catch(()=>{
            buildFilterFieldsForCategory(currentCategory, {});
            filterDrawer.show();
          });
      });

      applyFiltersBtn.addEventListener('click', ()=>{
        const newFilters = readFiltersFromForm();
        appliedFilters = appliedFilters.filter(f=>f.type==='search');
        newFilters.forEach(f=>{
          if (!appliedFilters.some(x=>x.type===f.type && String(x.value)===String(f.value))) appliedFilters.push(f);
        });
        renderActiveFilters();
        filterDrawer.hide();
        doSearch();
      });

      clearFiltersBtn.addEventListener('click', ()=>{
        filterFieldsContainer.innerHTML = '';
        appliedFilters = [];
        renderActiveFilters();
        doSearch();
        filterDrawer.hide();
      });
    }

    // ----- Build dynamic fields -----
    function buildFilterFieldsForCategory(category, meta){
      filterFieldsContainer.innerHTML = '';

      // Org Type
      const orgTypeDiv = document.createElement('div');
      orgTypeDiv.className = 'mb-3';
      orgTypeDiv.innerHTML = `<label class="form-label">Organization Type</label>
        <select id="ff_org_type" class="form-select"><option value="">-- any --</option></select>`;
      filterFieldsContainer.appendChild(orgTypeDiv);

      // Organization
      const orgDiv = document.createElement('div');
      orgDiv.className = 'mb-3';
      orgDiv.innerHTML = `<label class="form-label">Organization</label>
        <select id="ff_org" class="form-select"><option value="">-- any --</option></select>`;
      filterFieldsContainer.appendChild(orgDiv);

      // populate org types
      fetch("{% url 'api_org_types' %}", { headers:{'X-CSRFToken': csrftoken} })
        .then(r=>r.json())
        .then(list=>{
          const sel = document.getElementById('ff_org_type');
          list.forEach(it=>{
            const o = document.createElement('option');
            o.value = it.id; o.textContent = it.name; sel.appendChild(o);
          });
          const existing = appliedFilters.find(f=>f.type==='organization_type');
          if (existing) sel.value = existing.value;
        });

      document.getElementById('ff_org_type').addEventListener('change', (e)=>{
        const id = e.target.value;
        const sel = document.getElementById('ff_org');
        sel.innerHTML = '<option value="">-- any --</option>';
        if (!id) return;
        fetch("{% url 'api_orgs_by_type' %}?org_type_id="+encodeURIComponent(id), { headers:{'X-CSRFToken': csrftoken} })
          .then(r=>r.json())
          .then(list=>{
            list.forEach(it=>{
              const o = document.createElement('option');
              o.value = it.id; o.textContent = it.name; sel.appendChild(o);
            });
            const existing = appliedFilters.find(f=>f.type==='organization' && String(f.parent)===String(id));
            if (existing) sel.value = existing.value;
          });
      });

      // Category-specific
      if (category==='events'){
        const statuses = meta.statuses || [];
        const statusDiv = document.createElement('div');
        statusDiv.className = 'mb-3';
        let opts = '<option value="">-- any --</option>';
        statuses.forEach(s=> opts += `<option value="${s.value}">${s.label}</option>`);
        statusDiv.innerHTML = `<label class="form-label">Status</label><select id="ff_status" class="form-select">${opts}</select>`;
        filterFieldsContainer.appendChild(statusDiv);

        const flagsDiv = document.createElement('div');
        flagsDiv.className = 'mb-3';
        flagsDiv.innerHTML = `<label class="form-label">Flags</label>
          <div class="d-flex gap-3 mt-1">
            <label class="form-check"><input id="ff_big" type="checkbox" class="form-check-input"> Big Event</label>
            <label class="form-check"><input id="ff_finance" type="checkbox" class="form-check-input"> Needs Finance</label>
          </div>`;
        filterFieldsContainer.appendChild(flagsDiv);

        const dateDiv = document.createElement('div');
        dateDiv.className = 'mb-3';
        dateDiv.innerHTML = `<label class="form-label">Date range</label>
          <select id="ff_date" class="form-select">
            <option value="">-- any --</option>
            <option value="7_days">Last 7 days</option>
            <option value="30_days">Last 30 days</option>
            <option value="this_month">This month</option>
            <option value="this_year">This year</option>
            <option value="academic_year">This academic year</option>
          </select>`;
        filterFieldsContainer.appendChild(dateDiv);
      }

      if (category==='users'){
        const roles = meta.roles || [];
        const roleDiv = document.createElement('div');
        roleDiv.className = 'mb-3';
        let opts = '<option value="">-- any --</option>';
        roles.forEach(r=> opts += `<option value="${r.value}">${r.label}</option>`);
        roleDiv.innerHTML = `<label class="form-label">Role</label><select id="ff_role" class="form-select">${opts}</select>`;
        filterFieldsContainer.appendChild(roleDiv);

        const actDiv = document.createElement('div');
        actDiv.className = 'mb-3';
        actDiv.innerHTML = `<label class="form-label">Active</label>
          <select id="ff_active" class="form-select">
            <option value="">-- any --</option>
            <option value="true">Active</option>
            <option value="false">Inactive</option>
          </select>`;
        filterFieldsContainer.appendChild(actDiv);
      }

      if (category==='reports'){
        const rtypes = meta.report_types || [];
        const rDiv = document.createElement('div');
        rDiv.className = 'mb-3';
        let opts = '<option value="">-- any --</option>';
        rtypes.forEach(r=> opts += `<option value="${r.value}">${r.label}</option>`);
        rDiv.innerHTML = `<label class="form-label">Report Type</label><select id="ff_report_type" class="form-select">${opts}</select>`;
        filterFieldsContainer.appendChild(rDiv);

        const stDiv = document.createElement('div');
        stDiv.className = 'mb-3';
        let statusOpts = '<option value="">-- any --</option>';
        (meta.statuses||[]).forEach(s=> statusOpts += `<option value="${s.value}">${s.label}</option>`);
        stDiv.innerHTML = `<label class="form-label">Status</label><select id="ff_report_status" class="form-select">${statusOpts}</select>`;
        filterFieldsContainer.appendChild(stDiv);

        const dateDiv = document.createElement('div');
        dateDiv.className = 'mb-3';
        dateDiv.innerHTML = `<label class="form-label">Date range</label>
          <select id="ff_report_date" class="form-select">
            <option value="">-- any --</option>
            <option value="7_days">Last 7 days</option>
            <option value="30_days">Last 30 days</option>
            <option value="this_month">This month</option>
            <option value="this_year">This year</option>
            <option value="academic_year">This academic year</option>
          </select>`;
        filterFieldsContainer.appendChild(dateDiv);
      }

      if (category==='organizations'){
        const activeDiv = document.createElement('div');
        activeDiv.className = 'mb-3';
        activeDiv.innerHTML = `<label class="form-label">Active</label>
          <select id="ff_org_active" class="form-select">
            <option value="">-- any --</option>
            <option value="true">Active</option>
            <option value="false">Inactive</option>
          </select>`;
        filterFieldsContainer.appendChild(activeDiv);
      }

      restoreFormValuesFromAppliedFilters();
    }

    function restoreFormValuesFromAppliedFilters(){
      const ot = appliedFilters.find(f=>f.type==='organization_type');
      if (ot){
        const sel = document.getElementById('ff_org_type');
        if (sel) sel.value = ot.value;
        if (sel) sel.dispatchEvent(new Event('change'));
      }
      const org = appliedFilters.find(f=>f.type==='organization');
      if (org){
        const sel = document.getElementById('ff_org');
        if (sel) sel.value = org.value;
      }
      appliedFilters.forEach(f=>{
        if (f.type==='status' && document.getElementById('ff_status')) document.getElementById('ff_status').value = f.value;
        if (f.type==='date_range' && document.getElementById('ff_date')) document.getElementById('ff_date').value = f.value;
        if (f.type==='flag' && f.value==='is_big_event' && document.getElementById('ff_big')) document.getElementById('ff_big').checked = true;
        if (f.type==='flag' && f.value==='needs_finance_approval' && document.getElementById('ff_finance')) document.getElementById('ff_finance').checked = true;
        if (f.type==='role' && document.getElementById('ff_role')) document.getElementById('ff_role').value = f.value;
        if (f.type==='active' && document.getElementById('ff_active')) document.getElementById('ff_active').value = f.value;
        if (f.type==='report_type' && document.getElementById('ff_report_type')) document.getElementById('ff_report_type').value = f.value;
        if (f.type==='report_status' && document.getElementById('ff_report_status')) document.getElementById('ff_report_status').value = f.value;
        if (f.type==='org_active' && document.getElementById('ff_org_active')) document.getElementById('ff_org_active').value = f.value;
      });
    }

    // ----- Read filters -> array -----
    function readFiltersFromForm(){
      const out = [];
      const otEl = document.getElementById('ff_org_type');
      if (otEl && otEl.value) out.push({ type:'organization_type', value:otEl.value, label:`Org type: ${otEl.options[otEl.selectedIndex].text}` });

      const orgEl = document.getElementById('ff_org');
      if (orgEl && orgEl.value) out.push({ type:'organization', value:orgEl.value, parent:(otEl?otEl.value:null), label:`Org: ${orgEl.options[orgEl.selectedIndex].text}` });

      if (currentCategory==='events'){
        const s = document.getElementById('ff_status'); if (s && s.value) out.push({ type:'status', value:s.value, label:`Status: ${s.options[s.selectedIndex].text}` });
        const d = document.getElementById('ff_date'); if (d && d.value) out.push({ type:'date_range', value:d.value, label:`Date: ${d.options[d.selectedIndex].text}` });
        const big = document.getElementById('ff_big'); if (big && big.checked) out.push({ type:'flag', value:'is_big_event', label:'Big event' });
        const fin = document.getElementById('ff_finance'); if (fin && fin.checked) out.push({ type:'flag', value:'needs_finance_approval', label:'Needs finance' });
      }
      if (currentCategory==='users'){
        const r = document.getElementById('ff_role'); if (r && r.value) out.push({ type:'role', value:r.value, label:`Role: ${r.options[r.selectedIndex].text}` });
        const a = document.getElementById('ff_active'); if (a && a.value) out.push({ type:'active', value:a.value, label:`Active: ${a.options[a.selectedIndex].text}` });
      }
      if (currentCategory==='reports'){
        const rt = document.getElementById('ff_report_type'); if (rt && rt.value) out.push({ type:'report_type', value:rt.value, label:`Report Type: ${rt.options[rt.selectedIndex].text}` });
        const rs = document.getElementById('ff_report_status'); if (rs && rs.value) out.push({ type:'status', value:rs.value, label:`Status: ${rs.options[rs.selectedIndex].text}` });
        const rd = document.getElementById('ff_report_date'); if (rd && rd.value) out.push({ type:'date_range', value:rd.value, label:`Date: ${rd.options[rd.selectedIndex].text}` });
      }
      if (currentCategory==='organizations'){
        const oa = document.getElementById('ff_org_active'); if (oa && oa.value) out.push({ type:'active', value:oa.value, label:`Active: ${oa.options[oa.selectedIndex].text}` });
      }
      return out;
    }

    // ----- Active filters chips -----
    function renderActiveFilters(){
      activeFiltersEl.innerHTML = '';
      if (!appliedFilters.length){
        activeFiltersEl.innerHTML = '<div style="color:#6b7280;">No filters applied — open the drawer to add filters.</div>';
        resultsCount.textContent = 'No filters applied — showing all records for category: ' + currentCategory;
        return;
      }
      appliedFilters.forEach((f, idx)=>{
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.innerHTML = `<span>${f.label || (f.type+':'+f.value)}</span><button class="remove" data-idx="${idx}" aria-label="remove">&times;</button>`;
        activeFiltersEl.appendChild(chip);
        chip.querySelector('.remove').addEventListener('click', ()=>{
          appliedFilters.splice(idx,1);
          renderActiveFilters();
          doSearch();
        });
      });
    }

    // ----- Search & render -----
    function loadInitialResults(){
      appliedFilters = appliedFilters.filter(f=>f.type==='search');
      renderActiveFilters();
      doSearch();
    }

    function doSearch(){
      const payload = {
        category: currentCategory,
        q: null,
        filters: appliedFilters.map(f=>({ type:f.type, value:f.value }))
      };
      const sf = appliedFilters.find(f=>f.type==='search');
      if (sf){ payload.q = sf.value; payload.filters = payload.filters.filter(p=>p.type!=='search'); }

      fetch("{% url 'api_search' %}", {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'X-CSRFToken': csrftoken },
        body:JSON.stringify(payload)
      })
      .then(r=>{ if(!r.ok) throw new Error('Search failed: '+r.status); return r.json(); })
      .then(data=>{ const rows = data.results || []; renderResults(rows, data.total || rows.length); })
      .catch(err=>{
        console.error(err);
        resultsHead.innerHTML = '';
        resultsBody.innerHTML = `<tr><td colspan="10">Search failed. Check console.</td></tr>`;
      });
    }

    function renderResults(rows, total){
      if ($.fn.dataTable && $.fn.dataTable.isDataTable('#resultsTable')){
        $('#resultsTable').DataTable().clear().destroy();
        $('#resultsHead').empty(); $('#resultsBody').empty();
      }

      let keys = [];
      if (rows.length){
        const set = new Set();
        rows.forEach(r=>Object.keys(r).forEach(k=>set.add(k)));
        keys = Array.from(set);
      }
      if (!keys.length){
        keys = (currentCategory==='events') ? ['id','title','status','organization','created_at'] :
               (currentCategory==='users') ? ['id','username','full_name','email','role','organization'] :
               (currentCategory==='reports') ? ['id','title','report_type','status','organization'] :
               ['id','name','org_type','is_active'];
      }

      resultsHead.innerHTML = keys.map(k=>`<th>${k.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase())}</th>`).join('');
      resultsBody.innerHTML = rows.map(r=>('<tr>' + keys.map(k=>`<td>${escapeHtml(r[k] == null ? '' : r[k])}</td>`).join('') + '</tr>')).join('');

      $('#resultsTable').DataTable({
        dom:'Bfrtip',
        buttons:['copy','csv','excel','pdf','print'],
        scrollX:true,
        pageLength:25,
        order:[]
      });

      resultsCount.textContent = `${(total||0).toLocaleString()} records`;
      resultsMeta.textContent = `Category: ${currentCategory.charAt(0).toUpperCase()+currentCategory.slice(1)}`;
    }

    // ----- Export -----
    function bindExport(){
      exportCsvBtn.addEventListener('click', ()=>{
        const payload = { category: currentCategory, filters: appliedFilters.map(f=>({type:f.type, value:f.value})) };
        const s = appliedFilters.find(f=>f.type==='search'); if (s) payload.q = s.value;
        fetch("{% url 'api_export_csv' %}", {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'X-CSRFToken': csrftoken },
          body:JSON.stringify(payload)
        }).then(r=>{ if(!r.ok) throw new Error('Export failed: '+r.status); return r.blob(); })
          .then(blob=>{
            const fileName = `${currentCategory}_export_${new Date().toISOString().slice(0,10)}.csv`;
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = fileName; document.body.appendChild(a); a.click(); a.remove();
            URL.revokeObjectURL(url);
          }).catch(err=>{ console.error('CSV export err', err); alert('CSV export failed — check console.'); });
      });

      exportExcelBtn.addEventListener('click', ()=>{
        const payload = { category: currentCategory, filters: appliedFilters.map(f=>({type:f.type, value:f.value})) };
        const s = appliedFilters.find(f=>f.type==='search'); if (s) payload.q = s.value;
        fetch("{% url 'api_export_excel' %}", {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'X-CSRFToken': csrftoken },
          body:JSON.stringify(payload)
        }).then(r=>{ if(!r.ok) throw new Error('Export failed: '+r.status); return r.blob(); })
          .then(blob=>{
            const fileName = `${currentCategory}_export_${new Date().toISOString().slice(0,10)}.xlsx`;
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = fileName; document.body.appendChild(a); a.click(); a.remove();
            URL.revokeObjectURL(url);
          }).catch(err=>{ console.error('Excel export err', err); alert('Excel export failed — check console.'); });
      });
    }

    // ----- Utils -----
    function escapeHtml(str){
      if (str==null) return '';
      return String(str).replace(/[&<>"'`=\/]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[s]));
    }

    init();
  })();
  </script>
{% endblock %}
