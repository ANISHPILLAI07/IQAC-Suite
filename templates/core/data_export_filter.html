{% extends 'base.html' %}
{% load static %}

{% block title %}Data Export - CHRIST University{% endblock %}

{% block head_extra %}
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    color: #2d3748;
}

.export-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
    min-height: 100vh;
}

.export-header {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #2d3748;
    padding: 3rem 2.5rem;
    border-radius: 20px;
    margin-bottom: 2rem;
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
}

.export-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #667eea, #764ba2, #f093fb, #f5576c);
    background-size: 300% 300%;
    animation: gradientShift 3s ease infinite;
}

@keyframes gradientShift {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

.export-header:hover {
    transform: translateY(-2px);
    box-shadow: 0 25px 50px rgba(0,0,0,0.15);
}

.export-title {
    margin: 0;
    font-size: 2.5rem;
    font-weight: 700;
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.export-title i {
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.export-subtitle {
    margin: 1rem 0 0 0;
    opacity: 0.8;
    font-size: 1.1rem;
    font-weight: 400;
    line-height: 1.6;
}

.filter-section {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    padding: 2.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 20px 40px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
}

.filter-section:hover {
    transform: translateY(-2px);
    box-shadow: 0 25px 50px rgba(0,0,0,0.12);
}

.section-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 2rem;
    color: #2d3748;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    position: relative;
}

.section-title::after {
    content: '';
    position: absolute;
    bottom: -0.5rem;
    left: 0;
    width: 60px;
    height: 3px;
    background: linear-gradient(90deg, #667eea, #764ba2);
    border-radius: 2px;
}

.search-container {
    position: relative;
    margin-bottom: 2rem;
}

.search-input {
    width: 100%;
    padding: 1.25rem 1.25rem 1.25rem 3.5rem;
    border: 2px solid #e2e8f0;
    border-radius: 16px;
    font-size: 1.1rem;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    font-weight: 500;
}

.search-input:focus {
    outline: none;
    border-color: #667eea;
    background: rgba(255, 255, 255, 0.95);
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1), 0 10px 25px rgba(0,0,0,0.08);
    transform: translateY(-1px);
}

.search-input::placeholder {
    color: #a0aec0;
    font-weight: 400;
}

.search-icon {
    position: absolute;
    left: 1.25rem;
    top: 50%;
    transform: translateY(-50%);
    color: #667eea;
    font-size: 1.25rem;
    z-index: 2;
}

.suggestions-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 16px;
    max-height: 400px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
    box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    margin-top: 0.5rem;
}

.suggestions-dropdown::-webkit-scrollbar {
    width: 6px;
}

.suggestions-dropdown::-webkit-scrollbar-track {
    background: transparent;
}

.suggestions-dropdown::-webkit-scrollbar-thumb {
    background: #cbd5e0;
    border-radius: 3px;
}

.suggestions-dropdown::-webkit-scrollbar-thumb:hover {
    background: #a0aec0;
}

.suggestion-item {
    padding: 1rem 1.25rem;
    cursor: pointer;
    border-bottom: 1px solid rgba(226, 232, 240, 0.3);
    transition: all 0.2s ease;
    position: relative;
}

.suggestion-item:hover {
    background: rgba(102, 126, 234, 0.08);
    transform: translateX(4px);
}

.suggestion-item:last-child {
    border-bottom: none;
}

.suggestion-category {
    font-weight: 700;
    color: #667eea;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 0.25rem;
}

.suggestion-label {
    color: #2d3748;
    font-weight: 600;
    font-size: 1rem;
}

.suggestion-description {
    color: #718096;
    font-size: 0.9rem;
    margin-top: 0.25rem;
    line-height: 1.4;
}

.active-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 2rem;
    min-height: 3rem;
    align-items: center;
}

.filter-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1.25rem;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-radius: 25px;
    font-size: 0.9rem;
    font-weight: 600;
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.filter-chip::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s ease;
}

.filter-chip:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 25px rgba(102, 126, 234, 0.4);
}

.filter-chip:hover::before {
    left: 100%;
}

.filter-chip .remove-filter {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.3s ease;
}

.filter-chip .remove-filter:hover {
    background: rgba(255,255,255,0.35);
    transform: scale(1.1);
}

.empty-filters {
    color: #a0aec0;
    font-style: italic;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1rem;
    padding: 1rem;
    background: rgba(160, 174, 192, 0.1);
    border-radius: 12px;
    border: 2px dashed rgba(160, 174, 192, 0.3);
    width: 100%;
    justify-content: center;
}

.results-section {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    padding: 2.5rem;
    box-shadow: 0 20px 40px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
}

.results-section:hover {
    transform: translateY(-2px);
    box-shadow: 0 25px 50px rgba(0,0,0,0.12);
}

.results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.results-count {
    font-size: 1.4rem;
    font-weight: 700;
    color: #2d3748;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.results-count i {
    color: #667eea;
}

.export-controls {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.export-btn {
    background: linear-gradient(135deg, #48bb78, #38a169);
    color: white;
    border: none;
    padding: 1rem 1.75rem;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    text-decoration: none;
    font-size: 1rem;
    position: relative;
    overflow: hidden;
}

.export-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s ease;
}

.export-btn:hover::before {
    left: 100%;
}

.export-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 25px rgba(72, 187, 120, 0.4);
}

.export-btn:disabled {
    background: #e2e8f0;
    color: #a0aec0;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.export-btn:disabled:hover {
    transform: none;
    box-shadow: none;
}

.export-btn.csv {
    background: linear-gradient(135deg, #4299e1, #3182ce);
}

.export-btn.csv:hover {
    box-shadow: 0 12px 25px rgba(66, 153, 225, 0.4);
}

.results-preview {
    background: rgba(247, 250, 252, 0.5);
    border-radius: 16px;
    padding: 1.5rem;
    max-height: 600px;
    overflow: auto;
    border: 1px solid rgba(226, 232, 240, 0.5);
}

.results-preview::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

.results-preview::-webkit-scrollbar-track {
    background: rgba(226, 232, 240, 0.3);
    border-radius: 4px;
}

.results-preview::-webkit-scrollbar-thumb {
    background: #cbd5e0;
    border-radius: 4px;
}

.results-preview::-webkit-scrollbar-thumb:hover {
    background: #a0aec0;
}

.preview-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

.preview-table th,
.preview-table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid #f1f5f9;
    transition: all 0.2s ease;
}

.preview-table th {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-size: 0.8rem;
    position: sticky;
    top: 0;
    z-index: 10;
}

.preview-table tbody tr:hover {
    background: rgba(102, 126, 234, 0.05);
    transform: scale(1.01);
}

.preview-table tbody tr:hover td {
    border-color: rgba(102, 126, 234, 0.2);
}

.loading-indicator {
    display: none;
    text-align: center;
    padding: 3rem;
    color: #718096;
}

.loading-spinner {
    border: 4px solid rgba(102, 126, 234, 0.1);
    border-top: 4px solid #667eea;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 0 auto 1.5rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.quick-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 2rem;
}

.quick-filter-btn {
    padding: 0.75rem 1.5rem;
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
    border: 2px solid rgba(102, 126, 234, 0.2);
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
    font-weight: 600;
    position: relative;
    overflow: hidden;
}

.quick-filter-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
    transition: left 0.5s ease;
}

.quick-filter-btn:hover {
    background: rgba(102, 126, 234, 0.15);
    border-color: #667eea;
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
}

.quick-filter-btn:hover::before {
    left: 100%;
}

.filter-logic {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
    align-items: center;
}

.filter-logic-label {
    font-size: 1rem;
    color: #4a5568;
    font-weight: 600;
    margin-right: 0.5rem;
}

.logic-btn {
    padding: 0.5rem 1.25rem;
    border: 2px solid #e2e8f0;
    background: white;
    cursor: pointer;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 700;
    text-transform: uppercase;
    transition: all 0.3s ease;
    letter-spacing: 0.05em;
}

.logic-btn:hover {
    border-color: #667eea;
    transform: translateY(-1px);
}

.logic-btn.active {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-color: #667eea;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.empty-state {
    text-align: center;
    color: #718096;
    padding: 4rem 2rem;
}

.empty-state i {
    font-size: 4rem;
    opacity: 0.3;
    display: block;
    margin-bottom: 1.5rem;
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.empty-state h3 {
    font-size: 1.25rem;
    margin-bottom: 0.5rem;
    color: #4a5568;
}

.empty-state p {
    font-size: 1rem;
    line-height: 1.6;
}

.results-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding: 1rem;
    background: rgba(102, 126, 234, 0.05);
    border-radius: 12px;
    border-left: 4px solid #667eea;
}

.results-info-text {
    font-size: 0.95rem;
    color: #4a5568;
    font-weight: 500;
}

.pagination-info {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
    margin-top: 1.5rem;
    padding: 1rem;
    background: rgba(247, 250, 252, 0.5);
    border-radius: 12px;
    font-size: 0.9rem;
    color: #4a5568;
}

@media (max-width: 768px) {
    .export-container {
        padding: 1rem;
    }
    
    .export-title {
        font-size: 2rem;
    }
    
    .results-header {
        flex-direction: column;
        align-items: stretch;
    }
    
    .export-controls {
        justify-content: center;
    }
    
    .quick-filters {
        gap: 0.5rem;
    }
    
    .quick-filter-btn {
        font-size: 0.8rem;
        padding: 0.5rem 1rem;
    }
}

.fade-in {
    animation: fadeIn 0.5s ease-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.scale-in {
    animation: scaleIn 0.3s ease-out;
}

@keyframes scaleIn {
    from {
        opacity: 0;
        transform: scale(0.9);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="export-container">
  <div class="export-header fade-in">
    <h1 class="export-title">
      <i class="fas fa-filter"></i>
      Advanced Data Export & Analytics
    </h1>
    <p class="export-subtitle">Powerful search, intelligent filtering, and seamless data export with unlimited results</p>
  </div>

  <!-- Search and Filter Section -->
  <div class="filter-section fade-in">
    <h3 class="section-title">
      <i class="fas fa-search"></i>
      Smart Search & Filtering
    </h3>

    <!-- Quick Filters -->
    <div class="quick-filters">
      <button class="quick-filter-btn" data-filter="profile_role:faculty">
        <i class="fas fa-chalkboard-teacher"></i> Faculty Members
      </button>
      <button class="quick-filter-btn" data-filter="proposal_status:pending">
        <i class="fas fa-clock"></i> Pending Proposals
      </button>
      <button class="quick-filter-btn" data-filter="profile_role:student">
        <i class="fas fa-user-graduate"></i> Students
      </button>
      <button class="quick-filter-btn" data-filter="organization_type:Department">
        <i class="fas fa-building"></i> Departments
      </button>
      <button class="quick-filter-btn" data-filter="proposal_status:approved">
        <i class="fas fa-check-circle"></i> Approved Events
      </button>
      <button class="quick-filter-btn" data-filter="report_type:annual">
        <i class="fas fa-chart-line"></i> Annual Reports
      </button>
    </div>

    <!-- Main Search Input -->
    <div class="search-container">
      <i class="fas fa-search search-icon"></i>
      <input 
        type="text" 
        class="search-input" 
        id="mainSearch"
        placeholder="Search anything... (faculty, departments, events, reports, etc.)"
        autocomplete="off"
      >
      <div class="suggestions-dropdown" id="suggestionsDropdown"></div>
    </div>

    <!-- Filter Logic -->
    <div class="filter-logic">
      <span class="filter-logic-label">Filter Logic:</span>
      <button class="logic-btn active" data-logic="AND">AND</button>
      <button class="logic-btn" data-logic="OR">OR</button>
    </div>

    <!-- Active Filters -->
    <div class="active-filters" id="activeFilters">
      <div class="empty-filters">
        <i class="fas fa-info-circle"></i>
        No filters applied. Start typing or use quick filters to begin.
      </div>
    </div>
  </div>

  <!-- Results Section -->
  <div class="results-section fade-in">
    <div class="results-header">
      <div class="results-count" id="resultsCount">
        <i class="fas fa-database"></i>
        Ready to search
      </div>
      <div class="export-controls">
        <button class="export-btn csv" id="exportCsv" disabled>
          <i class="fas fa-file-csv"></i>
          Export CSV
        </button>
        <button class="export-btn" id="exportExcel" disabled>
          <i class="fas fa-file-excel"></i>
          Export Excel
        </button>
      </div>
    </div>

    <!-- Results Info -->
    <div class="results-info" id="resultsInfo" style="display: none;">
      <div class="results-info-text">
        <i class="fas fa-info-circle"></i>
        Showing all results - no pagination limits applied
      </div>
    </div>

    <!-- Loading Indicator -->
    <div class="loading-indicator" id="loadingIndicator">
      <div class="loading-spinner"></div>
      <p><strong>Searching through all data...</strong></p>
      <p style="opacity: 0.7; margin-top: 0.5rem;">Please wait while we fetch unlimited results</p>
    </div>

    <!-- Results Preview -->
    <div class="results-preview" id="resultsPreview">
      <div class="empty-state">
        <i class="fas fa-search"></i>
        <h3>Ready to Explore Data</h3>
        <p>Apply filters or use the search bar to discover insights from your data.<br>All results will be shown without any limits.</p>
      </div>
    </div>
  </div>
</div>

<script>
class DataExportFilter {
  constructor() {
    this.filters = [];
    this.currentLogic = 'AND';
    this.searchCache = {};
    this.suggestions = [];
    this.currentResults = [];
    
    this.initializeElements();
    this.loadSuggestions();
    this.bindEvents();
    this.initAnimations();
  }

  initializeElements() {
    this.searchInput = document.getElementById('mainSearch');
    this.suggestionsDropdown = document.getElementById('suggestionsDropdown');
    this.activeFiltersContainer = document.getElementById('activeFilters');
    this.resultsCount = document.getElementById('resultsCount');
    this.resultsPreview = document.getElementById('resultsPreview');
    this.resultsInfo = document.getElementById('resultsInfo');
    this.loadingIndicator = document.getElementById('loadingIndicator');
    this.exportCsvBtn = document.getElementById('exportCsv');
    this.exportExcelBtn = document.getElementById('exportExcel');
  }

  initAnimations() {
    // Add staggered animation to quick filter buttons
    const quickFilters = document.querySelectorAll('.quick-filter-btn');
    quickFilters.forEach((btn, index) => {
      btn.style.animationDelay = `${index * 0.1}s`;
      btn.classList.add('fade-in');
    });
  }

  async loadSuggestions() {
    try {
      const response = await fetch('/api/filter-suggestions/');
      if (response.ok) {
        this.suggestions = await response.json();
      } else {
        this.suggestions = this.getDefaultSuggestions();
      }
    } catch (error) {
      console.error('Failed to load suggestions:', error);
      this.suggestions = this.getDefaultSuggestions();
    }
  }

  getDefaultSuggestions() {
    return [
      // User Profile Filters
      {category: 'User Profiles', label: 'Faculty Members', filter: 'profile_role:faculty', description: 'All faculty members in the system'},
      {category: 'User Profiles', label: 'Students', filter: 'profile_role:student', description: 'All registered students'},
      {category: 'User Profiles', label: 'HODs', filter: 'profile_role:hod', description: 'Heads of Departments'},
      {category: 'User Profiles', label: 'System Admins', filter: 'profile_role:admin', description: 'System administrators'},
      {category: 'User Profiles', label: 'Active Users', filter: 'user_status:active', description: 'Currently active users'},
      
      // Organization Filters
      {category: 'Organizations', label: 'Academic Departments', filter: 'organization_type:Department', description: 'All academic departments'},
      {category: 'Organizations', label: 'Student Clubs', filter: 'organization_type:Club', description: 'Registered student clubs'},
      {category: 'Organizations', label: 'Research Centers', filter: 'organization_type:Research', description: 'Research centers and labs'},
      {category: 'Organizations', label: 'Active Organizations', filter: 'organization_active:true', description: 'Currently active organizations'},
      
      // Event Proposal Filters
      {category: 'Event Proposals', label: 'Pending Approval', filter: 'proposal_status:submitted', description: 'Proposals awaiting approval'},
      {category: 'Event Proposals', label: 'Approved Events', filter: 'proposal_status:approved', description: 'Approved event proposals'},
      {category: 'Event Proposals', label: 'Rejected Proposals', filter: 'proposal_status:rejected', description: 'Rejected event proposals'},
      {category: 'Event Proposals', label: 'Big Events', filter: 'proposal_big_event:true', description: 'Major/flagship events'},
      {category: 'Event Proposals', label: 'Finance Approval Needed', filter: 'proposal_finance_approval:true', description: 'Events requiring financial approval'},
      {category: 'Event Proposals', label: 'Completed Events', filter: 'proposal_status:completed', description: 'Successfully completed events'},
      
      // Report Filters
      {category: 'Reports & Analytics', label: 'Annual Reports', filter: 'report_type:annual', description: 'Yearly performance reports'},
      {category: 'Reports & Analytics', label: 'Event Reports', filter: 'report_type:event', description: 'Event-specific reports'},
      {category: 'Reports & Analytics', label: 'IQAC Reports', filter: 'report_type:iqac', description: 'Internal Quality Assurance Cell reports'},
      {category: 'Reports & Analytics', label: 'Financial Reports', filter: 'report_type:financial', description: 'Budget and expenditure reports'},
      {category: 'Reports & Analytics', label: 'Academic Reports', filter: 'report_type:academic', description: 'Academic performance reports'},
      
      // Date Filters
      {category: 'Time Periods', label: 'Current Academic Year', filter: 'date_range:academic_year', description: 'Current academic year data'},
      {category: 'Time Periods', label: 'Last 30 Days', filter: 'date_range:30_days', description: 'Recent activity from last month'},
      {category: 'Time Periods', label: 'This Semester', filter: 'date_range:this_semester', description: 'Current semester data'},
      {category: 'Time Periods', label: 'Last Quarter', filter: 'date_range:last_quarter', description: 'Previous quarter data'},
      {category: 'Time Periods', label: 'This Year', filter: 'date_range:this_year', description: 'Current calendar year'},
      
      // Status Filters
      {category: 'Status & Priority', label: 'High Priority', filter: 'priority:high', description: 'High priority items'},
      {category: 'Status & Priority', label: 'Urgent Items', filter: 'status:urgent', description: 'Items requiring immediate attention'},
      {category: 'Status & Priority', label: 'In Progress', filter: 'status:in_progress', description: 'Currently ongoing activities'},
      {category: 'Status & Priority', label: 'Completed Tasks', filter: 'status:completed', description: 'Successfully finished items'},
    ];
  }

  bindEvents() {
    // Search input events
    this.searchInput.addEventListener('input', (e) => this.handleSearchInput(e));
    this.searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        this.handleSearchSubmit();
      } else if (e.key === 'Escape') {
        this.hideSuggestions();
      }
    });

    // Click outside to hide suggestions
    document.addEventListener('click', (e) => {
      if (!this.searchInput.contains(e.target) && !this.suggestionsDropdown.contains(e.target)) {
        this.hideSuggestions();
      }
    });

    // Quick filter buttons
    document.querySelectorAll('.quick-filter-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const filterData = e.target.closest('.quick-filter-btn').dataset.filter;
        this.addFilter(filterData);
        
        // Add visual feedback
        e.target.style.transform = 'scale(0.95)';
        setTimeout(() => {
          e.target.style.transform = '';
        }, 150);
      });
    });

    // Logic buttons
    document.querySelectorAll('.logic-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        this.setFilterLogic(e.target.dataset.logic);
      });
    });

    // Export buttons
    this.exportCsvBtn.addEventListener('click', () => this.exportData('csv'));
    this.exportExcelBtn.addEventListener('click', () => this.exportData('excel'));
  }

  handleSearchInput(e) {
    const query = e.target.value.toLowerCase().trim();
    
    if (query.length < 2) {
      this.hideSuggestions();
      return;
    }

    const filteredSuggestions = this.suggestions.filter(item => 
      item.label.toLowerCase().includes(query) ||
      item.description.toLowerCase().includes(query) ||
      item.category.toLowerCase().includes(query) ||
      item.filter.toLowerCase().includes(query)
    );

    this.showSuggestions(filteredSuggestions, query);
  }

  showSuggestions(suggestions, query = '') {
    if (suggestions.length === 0) {
      this.hideSuggestions();
      return;
    }

    let html = '';
    let currentCategory = '';

    suggestions.forEach(item => {
      if (item.category !== currentCategory) {
        if (currentCategory !== '') html += '<hr style="margin: 0.5rem 0; border: 1px solid rgba(226, 232, 240, 0.5);">';
        html += `<div class="suggestion-item" style="background: rgba(102, 126, 234, 0.05); cursor: default;">
          <div class="suggestion-category">${item.category}</div>
        </div>`;
        currentCategory = item.category;
      }

      // Highlight matching text
      let highlightedLabel = item.label;
      let highlightedDescription = item.description;
      
      if (query) {
        const regex = new RegExp(`(${query})`, 'gi');
        highlightedLabel = item.label.replace(regex, '<mark style="background: #667eea; color: white; padding: 2px 4px; border-radius: 3px;">$1</mark>');
        highlightedDescription = item.description.replace(regex, '<mark style="background: #667eea; color: white; padding: 2px 4px; border-radius: 3px;">$1</mark>');
      }

      html += `
        <div class="suggestion-item" data-filter="${item.filter}">
          <div class="suggestion-label">${highlightedLabel}</div>
          <div class="suggestion-description">${highlightedDescription}</div>
        </div>
      `;
    });

    this.suggestionsDropdown.innerHTML = html;
    this.suggestionsDropdown.style.display = 'block';
    this.suggestionsDropdown.classList.add('scale-in');

    // Bind click events to suggestions
    this.suggestionsDropdown.querySelectorAll('.suggestion-item[data-filter]').forEach(item => {
      item.addEventListener('click', (e) => {
        const filterData = e.target.closest('[data-filter]').dataset.filter;
        this.addFilter(filterData);
        this.searchInput.value = '';
        this.hideSuggestions();
      });
    });
  }

  hideSuggestions() {
    this.suggestionsDropdown.style.display = 'none';
    this.suggestionsDropdown.classList.remove('scale-in');
  }

  handleSearchSubmit() {
    const query = this.searchInput.value.trim();
    if (query) {
      // Create a generic search filter
      this.addFilter(`search:${query}`);
      this.searchInput.value = '';
      this.hideSuggestions();
    }
  }

  addFilter(filterString) {
    // Avoid duplicate filters
    if (this.filters.some(f => f.raw === filterString)) {
      this.showNotification('Filter already applied', 'warning');
      return;
    }

    const filter = this.parseFilter(filterString);
    this.filters.push(filter);
    this.updateActiveFiltersDisplay();
    this.executeSearch();
    this.showNotification('Filter added successfully', 'success');
  }

  parseFilter(filterString) {
    const [type, value] = filterString.split(':');
    const suggestion = this.suggestions.find(s => s.filter === filterString);
    
    return {
      raw: filterString,
      type: type,
      value: value,
      label: suggestion ? suggestion.label : `${type}: ${value}`,
      description: suggestion ? suggestion.description : ''
    };
  }

  removeFilter(index) {
    const removedFilter = this.filters[index];
    this.filters.splice(index, 1);
    this.updateActiveFiltersDisplay();
    this.executeSearch();
    this.showNotification(`Removed: ${removedFilter.label}`, 'info');
  }

  updateActiveFiltersDisplay() {
    if (this.filters.length === 0) {
      this.activeFiltersContainer.innerHTML = `
        <div class="empty-filters">
          <i class="fas fa-info-circle"></i>
          No filters applied. Start typing or use quick filters to begin.
        </div>
      `;
      return;
    }

    const filtersHtml = this.filters.map((filter, index) => `
      <div class="filter-chip scale-in">
        <span><strong>${filter.label}</strong></span>
        <button class="remove-filter" onclick="dataExportFilter.removeFilter(${index})" title="Remove filter">
          <i class="fas fa-times"></i>
        </button>
      </div>
    `).join('');

    this.activeFiltersContainer.innerHTML = filtersHtml;
  }

  setFilterLogic(logic) {
    this.currentLogic = logic;
    document.querySelectorAll('.logic-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.logic === logic);
    });
    
    if (this.filters.length > 1) {
      this.executeSearch();
      this.showNotification(`Filter logic changed to ${logic}`, 'info');
    }
  }

  async executeSearch() {
    if (this.filters.length === 0) {
      this.currentResults = [];
      this.updateResultsDisplay();
      return;
    }

    this.showLoading();

    try {
      const response = await fetch('/api/execute-filter/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': this.getCsrfToken()
        },
        body: JSON.stringify({
          filters: this.filters,
          logic: this.currentLogic,
          unlimited: true  // Request all results without pagination
        })
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      this.currentResults = data.results || [];
      this.updateResultsDisplay();
      
      if (this.currentResults.length > 0) {
        this.showNotification(`Found ${this.currentResults.length} records`, 'success');
      } else {
        this.showNotification('No results found for current filters', 'warning');
      }
    } catch (error) {
      console.error('Search failed:', error);
      this.showError('Search failed. Please check your connection and try again.');
      this.showNotification('Search failed', 'error');
    } finally {
      this.hideLoading();
    }
  }

  updateResultsDisplay() {
    const count = this.currentResults.length;
    this.resultsCount.innerHTML = `<i class="fas fa-database"></i> ${count.toLocaleString()} record${count !== 1 ? 's' : ''} found`;

    // Show/hide results info
    if (count > 0) {
      this.resultsInfo.style.display = 'flex';
      this.resultsInfo.querySelector('.results-info-text').innerHTML = 
        `<i class="fas fa-info-circle"></i> Displaying all ${count.toLocaleString()} results - no pagination limits applied`;
    } else {
      this.resultsInfo.style.display = 'none';
    }

    // Enable/disable export buttons
    const hasResults = count > 0;
    this.exportCsvBtn.disabled = !hasResults;
    this.exportExcelBtn.disabled = !hasResults;

    if (count === 0) {
      this.resultsPreview.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-search-minus"></i>
          <h3>No Results Found</h3>
          <p>Try adjusting your filters or search terms.<br>All data sources are being searched without limits.</p>
        </div>
      `;
      return;
    }

    // Show all results in table
    this.renderFullResultsTable();
  }

  renderFullResultsTable() {
    if (this.currentResults.length === 0) return;

    const headers = Object.keys(this.currentResults[0]);
    
    let tableHtml = `
      <table class="preview-table">
        <thead>
          <tr>${headers.map(h => `<th>${this.formatHeader(h)}</th>`).join('')}</tr>
        </thead>
        <tbody>
    `;

    // Render ALL results (no limit)
    this.currentResults.forEach((row, index) => {
      tableHtml += `<tr>${headers.map(h => `<td>${this.formatCellValue(row[h]) || '-'}</td>`).join('')}</tr>`;
    });

    tableHtml += `
        </tbody>
      </table>
    `;

    // Add results summary
    const summaryHtml = `
      <div class="pagination-info">
        <i class="fas fa-check-circle" style="color: #48bb78;"></i>
        <strong>All ${this.currentResults.length.toLocaleString()} records displayed</strong>
        <span style="opacity: 0.7;">• No pagination limits • Complete dataset</span>
      </div>
    `;

    this.resultsPreview.innerHTML = tableHtml + summaryHtml;
  }

  formatHeader(header) {
    return header
      .replace(/_/g, ' ')
      .replace(/\b\w/g, l => l.toUpperCase())
      .trim();
  }

  formatCellValue(value) {
    if (value === null || value === undefined) return '';
    if (typeof value === 'boolean') return value ? 'Yes' : 'No';
    if (typeof value === 'string' && value.length > 50) {
      return value.substring(0, 50) + '...';
    }
    return String(value);
  }

  showLoading() {
    this.loadingIndicator.style.display = 'block';
    this.resultsPreview.style.display = 'none';
    this.resultsInfo.style.display = 'none';
  }

  hideLoading() {
    this.loadingIndicator.style.display = 'none';
    this.resultsPreview.style.display = 'block';
  }

  showError(message) {
    this.resultsPreview.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-exclamation-triangle" style="color: #e53e3e;"></i>
        <h3>Error Occurred</h3>
        <p>${message}</p>
      </div>
    `;
  }

  showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 9999;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    `;

    // Set background color based on type
    const colors = {
      success: '#48bb78',
      error: '#e53e3e',
      warning: '#ed8936',
      info: '#4299e1'
    };
    notification.style.background = colors[type] || colors.info;

    // Add icon
    const icons = {
      success: 'check-circle',
      error: 'exclamation-triangle',
      warning: 'exclamation-circle',
      info: 'info-circle'
    };
    notification.innerHTML = `<i class="fas fa-${icons[type] || icons.info}"></i> ${message}`;

    document.body.appendChild(notification);

    // Animate in
    setTimeout(() => {
      notification.style.transform = 'translateX(0)';
    }, 100);

    // Remove after 3 seconds
    setTimeout(() => {
      notification.style.transform = 'translateX(100%)';
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    }, 3000);
  }

  async exportData(format) {
    if (this.currentResults.length === 0) {
      this.showNotification('No data to export', 'warning');
      return;
    }

    const exportBtn = format === 'csv' ? this.exportCsvBtn : this.exportExcelBtn;
    const originalText = exportBtn.innerHTML;
    
    // Show loading state
    exportBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Exporting...`;
    exportBtn.disabled = true;

    try {
      const response = await fetch(`/api/export-data/${format}/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': this.getCsrfToken()
        },
        body: JSON.stringify({
          filters: this.filters,
          logic: this.currentLogic,
          unlimited: true  // Export all results
        })
      });

      if (response.ok) {
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `data_export_${new Date().toISOString().split('T')[0]}_${this.currentResults.length}_records.${format}`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        this.showNotification(`Successfully exported ${this.currentResults.length.toLocaleString()} records`, 'success');
      } else {
        throw new Error(`Export failed with status: ${response.status}`);
      }
    } catch (error) {
      console.error('Export failed:', error);
      this.showNotification('Export failed. Please try again.', 'error');
    } finally {
      // Restore button state
      exportBtn.innerHTML = originalText;
      exportBtn.disabled = false;
    }
  }

  getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
           document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
  }
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
  window.dataExportFilter = new DataExportFilter();
});
</script>

<!-- Add CSRF Token -->
{% csrf_token %}

{% endblock %}