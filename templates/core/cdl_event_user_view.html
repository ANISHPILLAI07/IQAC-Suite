{% extends "base.html" %}
{% load static %}
{% block title %}CDL Support{% endblock %}
{% block head_extra %}
<link rel="stylesheet" href="{% static 'core/css/cdl_event_user_view.css' %}">
{% endblock %}
{% block content %}
<div class="cdl-support-page">
  <div class="pane-left">
    <div class="pane-head">My CDL Events</div>
    <div class="pane-body" id="eventList"></div>
  </div>
  <div class="pane-right">
    <div class="pane-head row-between" id="detailHead">
      <span id="eventNameDisplay">Select an event</span>
      <a id="btnCommOpen" class="chip-btn disabled" href="#"><i class="fa-regular fa-comments"></i> Chat</a>
    </div>
    <div class="pane-content">
      <section class="section">
        <h3>Event Details</h3>
        <div id="eventDetails" class="card"></div>
      </section>
      <section class="section">
        <h3>Event Content</h3>
        <div id="eventContent" class="card"></div>
      </section>
      <section class="section">
        <h3>Work Process / Status</h3>
        <div id="workProcess" class="card"></div>
      </section>
    </div>
  </div>
  
</div>
<style>
/* Minimal fallback in case CSS file fails to load */
.row-between{display:flex;align-items:center;justify-content:space-between;gap:12px}
</style>
<script>
document.addEventListener('DOMContentLoaded', async function() {
  const listEl = document.getElementById('eventList');
  const headEl = document.getElementById('detailHead');
  const qs = new URLSearchParams(location.search); const initialId = qs.get('eventId');

  // Load my CDL events
  const listRes = await fetch('/api/cdl/events/my-support/');
  const listData = listRes.ok ? await listRes.json() : {success:false};
  if (!listData.success) {
    listEl.innerHTML = '<div class="text-muted">No events found.</div>';
    return;
  }
  listEl.innerHTML = listData.items.map(it=>`
    <div class="event-card" data-id="${it.id}">
      <div class="event-title">${it.title}</div>
      <div class="event-meta">${it.date || ''} • ${it.organization || ''} • ${it.status}</div>
      <div class="event-desc">${it.description || ''}</div>
    </div>
  `).join('');

  async function loadEvent(eventId){
    if(!eventId){ return; }
    
    // First get the event title for the header
    const headerRes = await fetch(`/api/cdl/event/${eventId}/details/`);
    const headerData = headerRes.ok ? await headerRes.json() : {};
    const eventNameEl = document.getElementById('eventNameDisplay');
    if(eventNameEl) {
      eventNameEl.textContent = headerData.success && headerData.title ? headerData.title : `Event #${eventId}`;
    }
  
  const [dRes, cRes, pRes, docRes] = await Promise.all([
      fetch(`/api/cdl/event/${eventId}/details/`),
      fetch(`/api/cdl/event/${eventId}/content/`),
      fetch(`/api/cdl/event/${eventId}/process/`),
      fetch(`/api/cdl/event/${eventId}/documents/`)
    ]);
  const d= dRes.ok? await dRes.json():{}; const c=cRes.ok?await cRes.json():{}; const p=pRes.ok?await pRes.json():{}; const docs=docRes.ok?await docRes.json():{};
    document.getElementById('eventDetails').innerHTML = d.success ? `
      <div><strong>Title:</strong> ${d.title}</div>
      <div><strong>Date:</strong> ${d.date || ''}</div>
      <div><strong>Location:</strong> ${d.location || ''}</div>
      <div><strong>Organization:</strong> ${d.organization || ''}</div>
      <div><strong>Description:</strong> ${d.description || ''}</div>
    ` : '<div class="text-muted">Unable to load details.</div>';
    document.getElementById('eventContent').innerHTML = c.success ? c.html : '<div class="text-muted">No content.</div>';
    function statusClass(s){
      if(!s) return 'neutral';
      const key = String(s).toLowerCase().replace(/\s+/g,'_');
      return ({assigned:'assigned', backlog:'backlog', in_progress:'in_progress'})[key] || 'neutral';
    }
    document.getElementById('workProcess').innerHTML = (p.success && Array.isArray(p.items) && p.items.length) ? p.items.map(item=>`
      <div class="wp-row"><div class="wp-col label">${item.label}</div><div class="wp-col value"><span class="badge ${statusClass(item.status)}">${item.status||''}</span></div></div>
    `).join('') : '<div class="text-muted">No status yet.</div>';

    // Enable communication button
    const commBtn = document.getElementById('btnCommOpen');
    if(commBtn){
      const url = new URL(window.location.origin + '{% url "cdl_communication_page" %}');
      url.searchParams.set('eventId', eventId);
      commBtn.href = url.toString();
      commBtn.classList.remove('disabled');
      commBtn.style.pointerEvents='auto';
      commBtn.style.opacity='1';
    }
  }

  listEl.addEventListener('click', (e)=>{
    const card = e.target.closest('.event-card'); if(!card) return;
    const id = card.dataset.id; const url = new URL(location.href); url.searchParams.set('eventId', id); history.replaceState({}, '', url);
    document.querySelectorAll('.event-card').forEach(n=>n.classList.remove('active'));
    card.classList.add('active');
    loadEvent(id);
  });

  const first = initialId || (listData.items[0] && listData.items[0].id);
  if(first){
    const card = document.querySelector(`.event-card[data-id="${first}"]`);
    if(card){ card.classList.add('active'); }
    loadEvent(first);
  }

  // If no event selected keep button disabled (already default state)
});
</script>
{% endblock %}
