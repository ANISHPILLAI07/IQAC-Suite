{% extends "base.html" %}
{% block title %}CDL Support{% endblock %}
{% block content %}
<div class="cdl-support-page">
  <div class="pane-left">
    <div class="pane-head">My CDL Events</div>
    <div class="pane-body" id="eventList"></div>
  </div>
  <div class="pane-right">
    <div class="pane-head" id="detailHead">Select an event</div>
    <div class="pane-content">
      <section class="section">
        <h3>Event Details</h3>
        <div id="eventDetails" class="card"></div>
      </section>
      <section class="section">
        <h3>Event Content</h3>
        <div id="eventContent" class="card"></div>
      </section>
      <section class="section">
        <h3>Work Process / Status</h3>
        <div id="workProcess" class="card"></div>
      </section>
      <section class="section">
        <h3>Communication</h3>
        <div class="card" id="commSection" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
          <div id="commInfo" class="text-muted" style="font-size:13px">Select an event to open communication.</div>
          <a id="btnCommOpen" class="chip-btn disabled" style="pointer-events:none;opacity:.5" href="#"><i class="fa-regular fa-comments"></i> Open</a>
        </div>
      </section>
    </div>
  </div>
  
</div>
<style>
.cdl-support-page { display:grid; grid-template-columns: 320px 1fr; gap:16px; padding:16px; }
.pane-left, .pane-right { background:#fff; border:1px solid var(--border,#e9ecef); border-radius:12px; box-shadow: 0 2px 8px #f1f3f5; display:flex; flex-direction:column; }
.pane-head { padding:12px 14px; border-bottom:1px solid var(--border,#e9ecef); font-weight:600; color:var(--muted,#495057) }
.pane-body { padding:10px; overflow:auto; max-height: calc(100vh - 220px); }
.pane-content { padding:12px; overflow:auto; max-height: calc(100vh - 220px); }
.event-card { border:1px solid var(--border,#e9ecef); border-radius:10px; padding:10px; margin-bottom:10px; cursor:pointer; }
.event-card:hover { background:#f8f9fa }
.event-title { font-weight:600; }
.event-meta { font-size:12px; color:#6c757d }
.section { margin-bottom:16px }
.section h3 { font-size:1.05rem; margin:0 0 8px 0; color:#2a3a4a }
.card { border:1px solid var(--border,#e9ecef); background:#fff; border-radius:10px; padding:10px }
.placeholder { background: #f6f6f6; border: 1px dashed #bbb; color: #888; text-align: center; }
@media (max-width: 960px){ .cdl-support-page{ grid-template-columns: 1fr; } .pane-body, .pane-content{ max-height:unset } }
</style>
<script>
document.addEventListener('DOMContentLoaded', async function() {
  const listEl = document.getElementById('eventList');
  const headEl = document.getElementById('detailHead');
  const qs = new URLSearchParams(location.search); const initialId = qs.get('eventId');

  // Load my CDL events
  const listRes = await fetch('/api/cdl/events/my-support/');
  const listData = listRes.ok ? await listRes.json() : {success:false};
  if (!listData.success) {
    listEl.innerHTML = '<div class="text-muted">No events found.</div>';
    return;
  }
  listEl.innerHTML = listData.items.map(it=>`
    <div class="event-card" data-id="${it.id}">
      <div class="event-title">${it.title}</div>
      <div class="event-meta">${it.date || ''} • ${it.organization || ''} • ${it.status}</div>
      <div class="event-desc">${it.description || ''}</div>
    </div>
  `).join('');

  async function loadEvent(eventId){
    if(!eventId){ return; }
    headEl.textContent = 'Event #' + eventId;
  const [dRes, cRes, pRes, docRes] = await Promise.all([
      fetch(`/api/cdl/event/${eventId}/details/`),
      fetch(`/api/cdl/event/${eventId}/content/`),
      fetch(`/api/cdl/event/${eventId}/process/`),
      fetch(`/api/cdl/event/${eventId}/documents/`)
    ]);
  const d= dRes.ok? await dRes.json():{}; const c=cRes.ok?await cRes.json():{}; const p=pRes.ok?await pRes.json():{}; const docs=docRes.ok?await docRes.json():{};
    document.getElementById('eventDetails').innerHTML = d.success ? `
      <div><strong>Title:</strong> ${d.title}</div>
      <div><strong>Date:</strong> ${d.date || ''}</div>
      <div><strong>Location:</strong> ${d.location || ''}</div>
      <div><strong>Organization:</strong> ${d.organization || ''}</div>
      <div><strong>Description:</strong> ${d.description || ''}</div>
    ` : '<div class="text-muted">Unable to load details.</div>';
    document.getElementById('eventContent').innerHTML = c.success ? c.html : '<div class="text-muted">No content.</div>';
    document.getElementById('workProcess').innerHTML = (p.success && Array.isArray(p.items) && p.items.length) ? p.items.map(item=>`
      <div class="row"><div class="col">${item.label}</div><div class="col text-end"><span class="badge bg-light text-dark">${item.status}</span></div></div>
    `).join('') : '<div class="text-muted">No status yet.</div>';

    // Enable communication button
    const commBtn = document.getElementById('btnCommOpen');
    const commInfo = document.getElementById('commInfo');
    if(commBtn){
      const url = new URL(window.location.origin + '{% url "cdl_communication_page" %}');
      url.searchParams.set('eventId', eventId);
      commBtn.href = url.toString();
      commBtn.classList.remove('disabled');
      commBtn.style.pointerEvents='auto';
      commBtn.style.opacity='1';
      if(commInfo) commInfo.textContent = 'Open communication log for this event.';
    }
  }

  listEl.addEventListener('click', (e)=>{
    const card = e.target.closest('.event-card'); if(!card) return;
    const id = card.dataset.id; const url = new URL(location.href); url.searchParams.set('eventId', id); history.replaceState({}, '', url);
    document.querySelectorAll('.event-card').forEach(n=>n.classList.remove('active'));
    card.classList.add('active');
    loadEvent(id);
  });

  const first = initialId || (listData.items[0] && listData.items[0].id);
  if(first){
    const card = document.querySelector(`.event-card[data-id="${first}"]`);
    if(card){ card.classList.add('active'); }
    loadEvent(first);
  }

  // If no event selected keep button disabled (already default state)
});
</script>
{% endblock %}
