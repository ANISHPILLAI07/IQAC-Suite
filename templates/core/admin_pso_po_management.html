{% extends "base.html" %}
{% load static %}
{% load dict_filters %}

{% block content %}
<link rel="stylesheet" href="{% static 'core/css/admin_master_data.css' %}">
<link rel="stylesheet" href="{% static 'core/css/admin_pso_po_management.css' %}">

<div class="main-container">
  <!-- Page Header -->
  <div class="page-header">
    <h1 class="page-title">POs & PSOs Management</h1>
  </div>

  <!-- Controls Section -->
  <div class="controls-section">
    <div class="filter-tabs">
      <button class="filter-btn active" data-type="all">All</button>
      {% for org_type in org_types %}
        <button class="filter-btn" data-type="{{ org_type.name|lower }}">{{ org_type.name }}s</button>
      {% endfor %}
    </div>
    
    <div class="search-container">
      <input type="text" id="org-search" placeholder="Search organizations...">
    </div>
  </div>

  <!-- Organizations Table -->
  <div class="table-container">
    <table class="data-table">
      <thead>
        <tr>
          <th>S.on</th>
          <th>Organization</th>
          <th>Type</th>
          <th>Status</th>
          <th>Parent</th>
          <th>POs & PSOs</th>
          <th>Assign To</th>
        </tr>
      </thead>
      <tbody id="organizations-list">
        {% for org_type in org_types %}
          {% for org in orgs_by_type|get_item:org_type.name %}
            <tr class="org-row" 
                data-id="{{ org.id }}" 
                data-name="{{ org.name }}" 
                data-type="{{ org_type.name|lower }}"
                data-parent="{{ org.parent.name|default:'' }}">
              <td>{{ org.id }}</td>
              <td class="org-name">{{ org.name }}</td>
              <td>{{ org_type.name }}</td>
              <td>
                <span class="status-badge {% if org.is_active %}active{% else %}inactive{% endif %}">
                  {% if org.is_active %}Active{% else %}Inactive{% endif %}
                </span>
              </td>
              <td class="parent-name">
                {% if org.parent %}{{ org.parent.name }}{% else %}-{% endif %}
              </td>
              <td>
                <div class="outcomes-cell">
                  <div class="outcome-counts">
                    <a class="po-count" href="{% url 'admin_outcomes_for_org' org.id %}" data-org-id="{{ org.id }}">
                      <span class="count">0</span> POs
                    </a>
                    <a class="pso-count" href="{% url 'admin_outcomes_for_org' org.id %}" data-org-id="{{ org.id }}">
                      <span class="count">0</span> PSOs
                    </a>
                  </div>
                  <a class="edit-outcomes-btn" href="{% url 'admin_outcomes_for_org' org.id %}">
                    <i class="fas fa-edit"></i> Edit
                  </a>
                </div>
              </td>
              <td>
                <div class="assign-cell">
                  <div class="assigned-user" data-org-id="{{ org.id }}">
                    <i class="fas fa-user-circle"></i>
                    <span class="assigned-name">Unassigned</span>
                  </div>
                  <button class="assign-user-btn" data-org-id="{{ org.id }}" data-org-name="{{ org.name }}" data-org-type="{{ org_type.name|lower }}">
                    <i class="fas fa-user-plus"></i> Assign
                  </button>
                </div>
              </td>
            </tr>
          {% endfor %}
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Dedicated outcomes page is used; embedded panel removed. -->
</div>

<!-- Removed outcome modals; using full-page inline panel -->

<!-- User Assignment Modal -->
<div id="assignUserModal" class="modal">
  <div class="modal-content medium">
    <div class="modal-header">
      <h3>Assign User to <span id="assign-org-name"></span></h3>
      <button class="close">&times;</button>
    </div>
    <div class="modal-body">
      <form id="assignUserForm">
    <!-- Removed Filter by Role dropdown -->
        <div class="form-group">
          <label for="userSelect">Select Faculty User</label>
          <div class="org-context">
            <small class="text-muted">
              <i class="fas fa-info-circle"></i>
              Showing faculty assigned to <strong><span id="assign-org-name-context"></span></strong> and its parent organizations.
              Department faculty are shown first.
            </small>
          </div>
          <div class="user-search-container">
            <input type="text" id="userSearch" placeholder="Search faculty users (real-time)..." autocomplete="off">
            <div id="userDropdown" class="user-dropdown" style="display:none;"></div>
          </div>
          <input type="hidden" id="selectedUserId" required>
        </div>
        <div class="current-assignment" id="currentAssignment" style="display: none;">
          <h4>Current Assignment</h4>
          <div class="assignment-info">
            <span id="currentAssignedUser"></span>
            <button type="button" id="removeAssignmentBtn" class="btn-remove">Remove Assignment</button>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-cancel">Cancel</button>
          <button type="submit" class="btn-save">Assign User</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="{% static 'core/js/admin_pso_po_management.js' %}"></script>

<script>
  // Pass backend data to JavaScript safely
  try {
    window.orgOutcomeCounts = JSON.parse('{{ org_outcome_counts|escapejs }}');
  } catch (e) {
    console.error('Failed to parse orgOutcomeCounts from template:', e);
    window.orgOutcomeCounts = {};
  }

  // Update outcome counts in the table
  document.addEventListener('DOMContentLoaded', function() {
    const outcomeCounts = window.orgOutcomeCounts || {};
    Object.keys(outcomeCounts).forEach(orgId => {
      const counts = outcomeCounts[orgId] || {};
      const poCountSpan = document.querySelector(`.po-count[data-org-id="${orgId}"] .count`);
      if (poCountSpan) poCountSpan.textContent = counts.po_count || 0;
      const psoCountSpan = document.querySelector(`.pso-count[data-org-id="${orgId}"] .count`);
      if (psoCountSpan) psoCountSpan.textContent = counts.pso_count || 0;
    });
  });
</script>
{% endblock %}
