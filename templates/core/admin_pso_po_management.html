{% extends "base.html" %}
{% load static %}
{% load dict_filters %}

{% block content %}
<link rel="stylesheet" href="{% static 'core/css/admin_master_data.css' %}">
<link rel="stylesheet" href="{% static 'core/css/admin_pso_po_management.css' %}">

<div class="main-container">
  <!-- Page Header -->
  <div class="page-header">
    <h1 class="page-title">POs & PSOs Management</h1>
  </div>

  <!-- Controls Section -->
  <div class="controls-section">
    <div class="filter-tabs">
      <button class="filter-btn active" data-type="all">All</button>
      {% for org_type in org_types %}
        <button class="filter-btn" data-type="{{ org_type.name|lower }}">{{ org_type.name }}s</button>
      {% endfor %}
    </div>
    
    <div class="search-container">
      <input type="text" id="org-search" placeholder="Search organizations...">
    </div>
  </div>

  <!-- Organizations Table -->
  <div class="table-container">
    <table class="data-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Organization</th>
          <th>Type</th>
          <th>Status</th>
          <th>Parent</th>
          <th>POs & PSOs</th>
          <th>Assign To</th>
        </tr>
      </thead>
      <tbody id="organizations-list">
        {% for org_type in org_types %}
          {% for org in orgs_by_type|get_item:org_type.name %}
            <tr class="org-row" 
                data-id="{{ org.id }}" 
                data-name="{{ org.name }}" 
                data-type="{{ org_type.name|lower }}"
                data-parent="{{ org.parent.name|default:'' }}">
              <td>{{ org.id }}</td>
              <td class="org-name">{{ org.name }}</td>
              <td>{{ org_type.name }}</td>
              <td>
                <span class="status-badge {% if org.is_active %}active{% else %}inactive{% endif %}">
                  {% if org.is_active %}Active{% else %}Inactive{% endif %}
                </span>
              </td>
              <td class="parent-name">
                {% if org.parent %}{{ org.parent.name }}{% else %}-{% endif %}
              </td>
              <td>
                <div class="outcomes-cell">
                  <div class="outcome-counts">
                    <span class="po-count" data-org-id="{{ org.id }}">
                      <span class="count">0</span> POs
                    </span>
                    <span class="pso-count" data-org-id="{{ org.id }}">
                      <span class="count">0</span> PSOs
                    </span>
                  </div>
                  <button class="edit-outcomes-btn" data-org-id="{{ org.id }}" data-org-name="{{ org.name }}">
                    <i class="fas fa-edit"></i> Edit
                  </button>
                </div>
              </td>
              <td>
                <div class="assign-cell">
                  <div class="assigned-user" data-org-id="{{ org.id }}">
                    <span class="assigned-name">Unassigned</span>
                  </div>
                  <button class="assign-user-btn" data-org-id="{{ org.id }}" data-org-name="{{ org.name }}" data-org-type="{{ org_type.name|lower }}">
                    <i class="fas fa-user-plus"></i> Assign
                  </button>
                </div>
              </td>
            </tr>
          {% endfor %}
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Outcomes Management Modal -->
  <div id="outcomesModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Manage Outcomes for <span id="modal-org-name"></span></h3>
        <button class="close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="outcomes-container">
          <!-- Programme Outcomes Card -->
          <div class="outcome-card po-card">
            <div class="card-header">
              <h4>PROGRAMME OUTCOMES (POS)</h4>
            </div>
            <div class="card-body">
              <div class="outcomes-list" id="posList">
                <!-- POs will be loaded here -->
              </div>
              <div class="add-outcome-section">
                <input type="text" id="newPOInput" placeholder="Add new Programme Outcome..." class="outcome-input">
                <button class="add-outcome-btn" id="addPOBtn">
                  <i class="fas fa-plus"></i> ADD PO
                </button>
              </div>
            </div>
          </div>

          <!-- Programme Specific Outcomes Card -->
          <div class="outcome-card pso-card">
            <div class="card-header">
              <h4>PROGRAMME SPECIFIC OUTCOMES (PSOS)</h4>
            </div>
            <div class="card-body">
              <div class="outcomes-list" id="psosList">
                <!-- PSOs will be loaded here -->
              </div>
              <div class="add-outcome-section">
                <input type="text" id="newPSOInput" placeholder="Add new Programme Specific Outcome..." class="outcome-input">
                <button class="add-outcome-btn" id="addPSOBtn">
                  <i class="fas fa-plus"></i> ADD PSO
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Outcome Modal -->
<div id="editOutcomeModal" class="modal">
  <div class="modal-content small">
    <div class="modal-header">
      <h3>Edit <span id="editOutcomeType"></span></h3>
      <button class="close">&times;</button>
    </div>
    <div class="modal-body">
      <form id="editOutcomeForm">
        <div class="form-group">
          <label for="editOutcomeText">Outcome Description</label>
          <textarea id="editOutcomeText" rows="4" required placeholder="Enter outcome description..."></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-cancel">Cancel</button>
          <button type="submit" class="btn-save">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Outcome Modal -->
<div id="addOutcomeModal" class="modal">
  <div class="modal-content small">
    <div class="modal-header">
      <h3>Add <span id="addOutcomeType"></span></h3>
      <button class="close">&times;</button>
    </div>
    <div class="modal-body">
      <form id="addOutcomeForm">
        <div class="form-group">
          <label for="addOutcomeText">Outcome Description</label>
          <textarea id="addOutcomeText" rows="4" required placeholder="Enter outcome description..."></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-cancel">Cancel</button>
          <button type="submit" class="btn-save">Add <span id="addOutcomeButtonText"></span></button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- User Assignment Modal -->
<div id="assignUserModal" class="modal">
  <div class="modal-content medium">
    <div class="modal-header">
      <h3>Assign User to <span id="assign-org-name"></span></h3>
      <button class="close">&times;</button>
    </div>
    <div class="modal-body">
      <form id="assignUserForm">
    <!-- Removed Filter by Role dropdown -->
        <div class="form-group">
          <label for="userSelect">Select Faculty User</label>
          <div class="user-search-container">
            <input type="text" id="userSearch" placeholder="Search faculty users (real-time)..." autocomplete="off">
            <div id="userDropdown" class="user-dropdown" style="display:none;"></div>
          </div>
          <input type="hidden" id="selectedUserId" required>
        </div>
        <div class="current-assignment" id="currentAssignment" style="display: none;">
          <h4>Current Assignment</h4>
          <div class="assignment-info">
            <span id="currentAssignedUser"></span>
            <button type="button" id="removeAssignmentBtn" class="btn-remove">Remove Assignment</button>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-cancel">Cancel</button>
          <button type="submit" class="btn-save">Assign User</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="{% static 'core/js/admin_pso_po_management.js' %}"></script>

<script>
  // Pass backend data to JavaScript
  window.orgOutcomeCounts = {{ org_outcome_counts|safe }};
  
  // Update outcome counts in the table
  document.addEventListener('DOMContentLoaded', function() {
    const outcomeCounts = window.orgOutcomeCounts || {};
    
    Object.keys(outcomeCounts).forEach(orgId => {
      const counts = outcomeCounts[orgId];
      
      // Update PO count
      const poCountSpan = document.querySelector(`.po-count[data-org-id="${orgId}"] .count`);
      if (poCountSpan) {
        poCountSpan.textContent = counts.po_count || 0;
      }
      
      // Update PSO count
      const psoCountSpan = document.querySelector(`.pso-count[data-org-id="${orgId}"] .count`);
      if (psoCountSpan) {
        psoCountSpan.textContent = counts.pso_count || 0;
      }
    });
  });
</script>
{% endblock %}
