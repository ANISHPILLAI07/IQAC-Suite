{% extends "base.html" %}
{% load static %}

{% block title %}Review{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'core/css/dashboard.css' %}">
<style>
  .rv-shell { display:grid; grid-template-columns: 320px 1fr; gap:14px; max-width: 1200px; margin: 0 auto; }
  .rv-left, .rv-right { background:#fff; border:1px solid #e6e8f0; border-radius:14px; padding:0; box-shadow:0 8px 30px rgba(2,6,23,.04); }
  .rv-header { padding:12px 14px; border-bottom:1px solid #eef1f6; display:flex; align-items:center; justify-content:space-between; }
  .rv-list { max-height: calc(100vh - 220px); overflow:auto; }
  .rv-item { padding:12px 14px; border-bottom:1px solid #f3f4f6; display:flex; gap:10px; cursor:pointer; }
  .rv-item:hover { background:#f9fafb; }
  .rv-item.active { background:#eef6ff; }
  .rv-title { font-weight:600; }
  .rv-meta { font-size:12px; color:var(--muted); }
  .chat { display:flex; flex-direction:column; height: calc(100vh - 220px); }
  .chat-log { flex:1; overflow:auto; padding:0; background:#fff; border-top:1px solid #eef1f6; }
  .actions { display:flex; gap:8px; align-items:center; padding:10px 14px; border-top:1px solid #eef1f6; }
  .actions textarea { flex:1; min-height:40px; max-height:120px; resize:vertical; }
  .pill { display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px; background:#eef2ff; color:#3730a3; }
  .pill.ok { background:#dcfce7; color:#166534; }
  .pill.warn { background:#fff7ed; color:#9a3412; }
  .link-muted { color:#164c8d; text-decoration:none; }
  .empty { padding:16px; color:#6b7280; }
  .error { padding:16px; color:#9a3412; }
  .chip-btn { padding:6px 10px; border:1px solid #d1d5db; border-radius:999px; background:#f9fafb; cursor:pointer; }
  .chip-btn:hover { background:#eef2ff; }
  .link-muted { color:#1d4ed8; text-decoration:none; }
  .link-muted:hover { text-decoration:underline; }
  .log-table { width:100%; border-collapse:collapse; font-size:13px }
  .log-table thead { position:sticky; top:0; background:#f1f5f9; font-size:11px; text-transform:uppercase; letter-spacing:.5px; color:#475569 }
  .log-table th, .log-table td { text-align:left; padding:6px 8px; border-bottom:1px solid #e2e8f0; vertical-align:top }
  .from-cell { font-weight:600; color:#1e3a8a; font-size:12px; white-space:nowrap }
  .from-time { font-size:10px; font-weight:400; color:#64748b; margin-top:2px }
  .msg-cell { white-space:pre-wrap; word-break:break-word }
  .att-cell a { font-size:11px; text-decoration:none; display:inline-flex; gap:6px; align-items:center }
  .log-empty { padding:40px 0; text-align:center; color:#64748b; font-size:14px }
</style>
{% endblock %}

{% block content %}
<div class="rv-shell">
  <div class="rv-left">
    <div class="rv-header"><strong>Assigned for Review</strong></div>
    <div id="rvList" class="rv-list"><div class="empty">Loading…</div></div>
  </div>
  <div class="rv-right">
    <div class="rv-header"><strong id="threadTitle">Select an item</strong><span id="threadStatus"></span></div>
    <div class="chat">
      <div id="chatLog" class="chat-log">
        <div id="logScroller" style="overflow:auto; max-height: 100%">
          <table class="log-table">
            <thead>
              <tr>
                <th style="width:140px">Date</th>
                <th style="width:180px">From</th>
                <th>Message</th>
                <th style="width:120px">Attachments</th>
              </tr>
            </thead>
            <tbody id="logBody"></tbody>
          </table>
          <div id="logEmpty" class="log-empty" style="display:none">No messages yet.</div>
        </div>
      </div>
      <div class="actions">
        <textarea id="feedbackBox" placeholder="Write feedback…"></textarea>
        <button id="btnApprove" class="chip-btn">Approve</button>
        <button id="btnChanges" class="chip-btn">Send Feedback</button>
        <a id="openThread" class="chip-btn" href="#" target="_blank">Open thread</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
(function(){
  const listEl = document.getElementById('rvList');
  const chatLog = document.getElementById('chatLog');
  const logBody = document.getElementById('logBody');
  const logEmpty = document.getElementById('logEmpty');
  const logScroller = document.getElementById('logScroller');
  const feedbackBox = document.getElementById('feedbackBox');
  const btnApprove = document.getElementById('btnApprove');
  const btnChanges = document.getElementById('btnChanges');
  const threadTitle = document.getElementById('threadTitle');
  const threadStatus = document.getElementById('threadStatus');
  const openThread = document.getElementById('openThread');
  let mySubs = []; // all submissions assigned to me (flat)
  let proposals = []; // grouped by proposal
  let current = null; // current proposal object

  function esc(s){ return (s??'').toString().replace(/[&<>\"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
  function pill(status){ const cls = status==='approved'?'ok':(status==='changes_needed'?'warn':''); return `<span class=\"pill ${cls}\">${esc(status.replace('_',' '))}</span>`; }
  function dayKey(iso){ try{ const d=new Date(iso); return d.toISOString().slice(0,10); }catch{return String(iso).slice(0,10);} }
  function fmtDay(iso){ try{ const d=new Date(iso); return d.toLocaleDateString(undefined,{day:'2-digit',month:'short',year:'numeric'});}catch{return String(iso).slice(0,10);} }
  function fmtTime(iso){ try{ const d=new Date(iso); return d.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'});}catch{return '';} }

  async function loadList(){
    const r=await fetch('/api/cdl/proofread/list/?as_reviewer=true');
    const d=await r.json();
    if(!r.ok||!d.success) throw new Error(d.error||('HTTP '+r.status));
    mySubs = d.submissions||[];
    groupByProposal();
    renderList();
    if(proposals.length){ select(proposals[0].proposal_id); }
  }

  function groupByProposal(){
    const map = new Map();
    for(const s of mySubs){
      const key = s.proposal_id;
      if(!map.has(key)){
        map.set(key, { proposal_id:key, title: s.proposal_title||('Event #'+key), organization: s.organization||'', submissions: [] });
      }
      map.get(key).submissions.push(s);
    }
    proposals = Array.from(map.values()).map(p=>{
      p.submissions.sort((a,b)=> new Date(a.created_at)-new Date(b.created_at));
      p.latest = p.submissions[p.submissions.length-1];
      return p;
    });
    // Sort proposals by latest submission time desc
    proposals.sort((a,b)=> new Date(b.latest.created_at)-new Date(a.latest.created_at));
  }

  function renderList(){
    listEl.innerHTML = (proposals.map(p=>{
      const meta = [p.organization, p.latest.submitted_by||''].filter(Boolean).join(' • ');
      return `<div class='rv-item' data-prop='${p.proposal_id}'>
        <div style='flex:1;min-width:0'>
          <div class='rv-title'>${esc(p.title)}</div>
          <div class='rv-meta'>${esc(meta)}</div>
        </div>
        <div>${pill(p.latest.status)}</div>
      </div>`;
    }).join('')) || '<div class=\"empty\">No submissions assigned to you</div>';
  }

  async function select(proposalId){
    // find proposal object
    const prop = proposals.find(x=>String(x.proposal_id)===String(proposalId));
    current = prop || null;
    Array.from(listEl.querySelectorAll('.rv-item')).forEach(x=>x.classList.toggle('active', x.dataset.prop===String(proposalId)));
    threadTitle.textContent = current ? current.title : 'Select an item';
    threadStatus.innerHTML = current ? pill(current.latest.status) : '';
    openThread.href = current? `/proposal/${current.proposal_id}/proofread/` : '#';
  // show loading row
  logBody.innerHTML = '';
  logEmpty.style.display='none';
    if(!current) return;

    // Load full thread for this proposal (all submissions)
    const r=await fetch(`/api/cdl/proofread/list/?proposal_id=${encodeURIComponent(current.proposal_id)}`);
    const d=await r.json();
    if(!r.ok||!d.success){ chatLog.innerHTML = `<div class='error'>${esc(d.error||('HTTP '+r.status))}</div>`; return; }
  const subs = (d.submissions||[]).sort((a,b)=> new Date(a.created_at)-new Date(b.created_at));
  renderLog(subs);
  }

  function renderAttachmentCell(items){
    const links = (items||[]).map(it=>{
      if(it.kind==='text'){
        const url = (it.content_text||'').trim();
        if(!url) return '';
        const label = it.label || 'Link';
        return `<a href='${esc(url)}' target='_blank' rel='noopener noreferrer'><i class="fa-regular fa-paperclip"></i> ${esc(label)}</a>`;
      }
      if(it.file_missing){
        return `<span style='font-size:11px;color:#b91c1c;display:inline-flex;gap:4px;align-items:center'><i class="fa-regular fa-triangle-exclamation"></i> Missing file</span>`;
      }
      const label = it.label || 'File';
      return `<a href='${esc(it.file_url)}' target='_blank' rel='noopener noreferrer'><i class="fa-regular fa-paperclip"></i> ${esc(label)}</a>`;
    }).filter(Boolean);
    return links.join('<br>');
  }

  function renderLog(subs){
    logBody.innerHTML='';
    if(!subs.length){ logEmpty.style.display='block'; return; }
    logEmpty.style.display='none';

    // Flatten into row objects and group by day
    const rows = [];
    for(const s of subs){
      rows.push({
        day: dayKey(s.created_at),
        dayLabel: fmtDay(s.created_at),
        time: fmtTime(s.created_at),
        from: esc(s.submitted_by),
        msg: renderSubmitterMessage(s),
        att: renderAttachmentCell(s.items),
      });
      const showFaculty = (s.status !== 'pending') || (s.feedback && s.feedback.trim());
      if(showFaculty){
        const t = s.updated_at || s.created_at;
        rows.push({
          day: dayKey(t),
          dayLabel: fmtDay(t),
          time: fmtTime(t),
          from: `${esc(s.reviewer)} <span style='font-weight:400;color:#64748b'>(review)</span>`,
          msg: `<div><strong>Status:</strong> ${esc(s.status.replace('_',' '))}</div>${s.feedback? `<div style='margin-top:6px'><strong>Feedback</strong><div>${esc(s.feedback)}</div></div>`:''}`,
          att: '',
        });
      }
    }

    const groups = new Map();
    for(const r of rows){ if(!groups.has(r.day)) groups.set(r.day, {label:r.dayLabel, rows:[]}); groups.get(r.day).rows.push(r); }
    const dayKeys = Array.from(groups.keys()).sort();
    for(const dk of dayKeys){
      const g = groups.get(dk);
      const span = g.rows.length;
      g.rows.forEach((r,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          ${i===0? `<td rowspan='${span}' style='white-space:nowrap;font-size:12px;font-weight:600;color:#334155'>${g.label}</td>`:''}
          <td class='from-cell'>${r.from}<div class='from-time'>${r.time}</div></td>
          <td class='msg-cell'>${r.msg}</td>
          <td class='att-cell'>${r.att}</td>`;
        logBody.appendChild(tr);
      });
    }
    logScroller.scrollTop = logScroller.scrollHeight;
  }

  function renderSubmitterMessage(s){
    // Prefer textual labels inline; for pure link-only items we also show the link text
    const parts = [];
    for(const it of (s.items||[])){
      if(it.kind==='text'){
        const label = it.label ? `<div style='font-size:12px;color:#6b7280;margin-bottom:4px'>${esc(it.label)}</div>`: '';
        const link = it.content_text ? `<a class='link-muted' href='${esc(it.content_text)}' target='_blank' rel='noopener noreferrer'>${esc(it.content_text)}</a>` : '';
        parts.push(`<div>${label}${link}</div>`);
      }else{
        const label = it.label || 'File attached';
        parts.push(`<div>${esc(label)}</div>`);
      }
    }
    return parts.join('') || '';
  }

  listEl.addEventListener('click', e=>{
    const row = e.target.closest('.rv-item');
    if(row) select(row.dataset.prop);
  });

  async function act(action){
    if(!current) return;
    // The action targets the latest submission in the proposal thread
    const latestId = current.latest?.id;
    if(!latestId) return;
    const fd = new FormData();
    fd.append('submission_id', latestId);
    fd.append('action', action);
    if(action==='changes_needed'){
      const txt = feedbackBox.value.trim();
      if(txt) fd.append('feedback', txt);
    }
    const r=await fetch('/api/cdl/proofread/review/', { method:'POST', body: fd, headers:{'X-CSRFToken':(document.querySelector('meta[name=\"csrf-token\"]')||{}).content}});
    const d=await r.json();
    if(!r.ok||!d.success) throw new Error(d.error||('HTTP '+r.status));
    // Refresh left list and current thread
    await loadList();
    await select(current.proposal_id);
    if(action==='changes_needed') feedbackBox.value='';
  }

  btnApprove.addEventListener('click', ()=> act('approve').catch(e=>alert(e.message||'Failed')));
  btnChanges.addEventListener('click', ()=> act('changes_needed').catch(e=>alert(e.message||'Failed')));

  loadList().catch(e=>{ listEl.innerHTML = `<div class='error'>${e.message||'Failed'}</div>`; });
})();
</script>
{% endblock %}