{% extends "base.html" %}
{% load static %}

{% block title %}Academic Year Settings{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="{% static 'core/css/admin_academic_year.css' %}?v=4.0">
  <!-- FontAwesome already in base; include if not -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="ems-dashboard mdm-page ays-page"><!-- same container model as Master Data -->

  <!-- Heading (plain, left, compact) -->
  <header class="topbar">
    <div><h1>Academic Year Settings</h1></div>
  </header>

  <!-- Toolbar (tabs on left, Add on right — identical layout to Master Data controls) -->
  <div class="controls-container ays-toolbar">
    <div class="filters-left">
      <div class="tabs-in-toolbar" role="tablist" aria-label="Academic Years">
        <button class="tab-btn is-active" role="tab" aria-selected="true"
                aria-controls="panel-active" id="tab-active">
          Active <span class="count-chip">{{ active_years|length }}</span>
        </button>
        <button class="tab-btn" role="tab" aria-selected="false"
                aria-controls="panel-archived" id="tab-archived">
          Archived <span class="count-chip">{{ archived_years|length }}</span>
        </button>
      </div>
    </div>

    <div class="main-actions">
      <button class="btn btn-primary" id="btnOpenAdd">
        <i class="fas fa-plus"></i><span class="btn-label">Add New Entry</span>
      </button>
    </div>
  </div>

  <!-- ACTIVE TABLE -->
  <section id="panel-active" class="tab-panel is-active" role="region" aria-label="Active">
    {% if active_years %}
    <div class="table-wrap">
      <table class="data-table">
        <thead>
          <tr>
            <th class="th-name">Name</th>
            <th>Dates</th>
            <th class="th-status">Status</th>
            <th class="th-actions">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for year in active_years %}
          <tr>
            <td data-label="Name" class="mono">{{ year.year }}</td>
            <td data-label="Dates">
              <i class="fas fa-calendar"></i>
              {{ year.start_date|date:"M d, Y" }} – {{ year.end_date|date:"M d, Y" }}
            </td>
            <td data-label="Status">
              <span class="status-badge status-active">Active</span>
            </td>
            <td data-label="Actions" class="actions">
              <a href="?edit={{ year.id }}"
                 class="icon-text js-edit"
                 data-id="{{ year.id }}"
                 data-start="{{ year.start_date|date:'Y-m-d' }}"
                 data-end="{{ year.end_date|date:'Y-m-d' }}">
                <i class="fas fa-pen"></i> Edit
              </a>
              <form method="post" action="{% url 'academic_year_archive' year.id %}" class="inline"
                    onsubmit="return confirm('Are you sure you want to archive this academic year?')">
                {% csrf_token %}
                <button type="submit" class="icon-text warn"><i class="fas fa-box-archive"></i> Archive</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
      <div class="search-not-found"><p>No active academic years.</p></div>
    {% endif %}
  </section>

  <!-- ARCHIVED TABLE -->
  <section id="panel-archived" class="tab-panel" role="region" aria-label="Archived">
    {% if archived_years %}
    <div class="table-wrap">
      <table class="data-table">
        <thead>
          <tr>
            <th class="th-name">Name</th>
            <th>Dates</th>
            <th class="th-status">Status</th>
            <th class="th-actions">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for year in archived_years %}
          <tr class="is-archived">
            <td data-label="Name" class="mono">{{ year.year }}</td>
            <td data-label="Dates">
              <i class="fas fa-calendar"></i>
              {{ year.start_date|date:"M d, Y" }} – {{ year.end_date|date:"M d, Y" }}
            </td>
            <td data-label="Status">
              <span class="status-badge status-inactive">Archived</span>
            </td>
            <td data-label="Actions" class="actions">
              <form method="post" action="{% url 'academic_year_restore' year.id %}" class="inline"
                    onsubmit="return confirm('Are you sure you want to restore this academic year?')">
                {% csrf_token %}
                <button type="submit" class="icon-text ok"><i class="fas fa-rotate-left"></i> Restore</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
      <div class="search-not-found"><p>No archived academic years.</p></div>
    {% endif %}
  </section>

  <!-- Hide any global welcome/hero below content -->
  <div class="iqac-welcome" style="display:none"></div>
</div>

<!-- Data for client-side checks + optional edit prefill -->
<script id="activeYearsData" type="application/json">
[
  {% for y in active_years %}
    {"start":"{{ y.start_date|date:'Y-m-d' }}","end":"{{ y.end_date|date:'Y-m-d' }}"}{% if not forloop.last %},{% endif %}
  {% endfor %}
]
</script>
{% if edit_year %}
<script id="editYearData" type="application/json">
{"id":"{{ edit_year.id }}","start":"{{ edit_year.start_date|date:'Y-m-d' }}","end":"{{ edit_year.end_date|date:'Y-m-d' }}"}
</script>
{% endif %}

<!-- Add/Edit Modal (reuse the one you already have); include the same JS -->
<div class="modal" id="yearModal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal__backdrop" data-close></div>
  <div class="modal__dialog">
    <header class="modal__header">
      <h2 id="modalTitle" class="modal__title"><i class="fas fa-plus-circle"></i> Add Academic Year</h2>
      <button class="icon-btn" type="button" title="Close" data-close aria-label="Close"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal__body">
      <form method="post" id="academicYearForm" class="form" novalidate>
        {% csrf_token %}
        <input type="hidden" name="id" id="yearId">
        <div class="form-row">
          <div class="field">
            <label for="startDate" class="label"><i class="fas fa-calendar-day"></i> Start Date</label>
            <input type="date" id="startDate" name="start_date" class="input" required>
          </div>
          <div class="field">
            <label for="endDate" class="label"><i class="fas fa-calendar-day"></i> End Date</label>
            <input type="date" id="endDate" name="end_date" class="input" required>
          </div>
        </div>
        <div class="year-preview">
          <span class="preview-key">Year Label:</span>
          <span class="preview-val" id="yearLabel">—</span>
        </div>
        <div class="notices" id="formNotices" aria-live="polite"></div>
        <div class="modal__actions">
          <button type="submit" class="btn btn-primary" id="btnSubmit"><i class="fas fa-save"></i> Save</button>
          <button type="button" class="btn btn-secondary" data-close>Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
  <script src="{% static 'core/js/admin_academic_year.js' %}?v=4.0"></script>
{% endblock %}
