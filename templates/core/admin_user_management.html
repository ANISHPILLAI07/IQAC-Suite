{% extends "base.html" %}
{% load static %}

{% block head_extra %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
    rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">

<link rel="stylesheet" href="{% static 'core/css/admin_user_management.css' %}">

<style>
    .filters-section {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .filters-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .filters-header h5 {
        margin: 0;
        color: #495057;
        font-weight: 600;
    }

    .filter-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
    }

    .filter-group label {
        font-size: 0.9rem;
        font-weight: 500;
        color: #6c757d;
        margin-bottom: 5px;
    }

    .toggle-filters {
        background: none;
        border: none;
        color: #007bff;
        font-size: 0.9rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .filters-collapsed .filter-content {
        display: none;
    }

    .btn-primary,
    .dt-buttons .btn.btn-primary {
        background-color: var(--christ-blue) !important;
        border-color: var(--christ-blue) !important;
    }

    .btn-primary:hover,
    .dt-buttons .btn.btn-primary:hover {
        background-color: var(--christ-blue-dark) !important;
        border-color: var(--christ-blue-dark) !important;
    }

    .admin-users-table thead th {
        background: var(--christ-blue);
        color: var(--white);
    }

    .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice {
        background-color: var(--christ-blue);
        border-color: var(--christ-blue);
        color: #fff;
    }

    .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice__remove {
        color: #fff;
    }
</style>
{% endblock %}

{% block content %}
<div class="user-mgmt-container">
    <h1 class="mgmt-title">User Management</h1>

    <div class="filters-section" id="filtersSection">
        <div class="filters-header">
            <h5><i class="fas fa-filter"></i> Advanced Filters</h5>
            <button type="button" class="toggle-filters" id="toggleFiltersBtn">
                <span id="filterToggleText">Collapse</span>
                <i class="fas fa-chevron-up" id="filterToggleIcon"></i>
            </button>
        </div>

        <div class="filter-content">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="q">Search Users</label>
                    <input type="text" class="form-control" id="q" placeholder="Name, email, username...">
                </div>
                <div class="filter-group">
                    <label for="status">Account Status</label>
                    <select class="form-select" id="status">
                        <option value="" selected>All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="org_type">Organization Type</label>
                    <select class="form-select" id="org_type" name="org_type[]" multiple></select>
                </div>
                <div class="filter-group">
                    <label for="organization">Organization</label>
                    <select class="form-select" id="organization" name="organization[]" multiple></select>
                </div>
            </div>

            <div class="filter-row">
                <div class="filter-group">
                    <label for="role">Organization Role</label>
                    <select class="form-select" id="role" name="role[]" multiple
                        data-initial-roles='{{ initial_roles_json|safe }}'></select>
                </div>
                <div class="filter-group">
                    <div class="d-flex gap-2" style="margin-top: 32px;">
                        <button type="button" class="btn btn-primary w-100" id="applyFiltersBtn">
                            <i class="fas fa-search"></i> Apply Filters
                        </button>
                        <button type="button" class="btn btn-outline-secondary w-100" id="clearFiltersBtn">
                            <i class="fas fa-times"></i> Clear All
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table id="usersTable" class="admin-users-table table table-striped table-hover align-middle display nowrap"
            style="width:100%" data-api-url="{% url 'api_admin_search_users' %}">
            <thead>
                <tr>
                    <th>S.NO</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Roles</th>
                    <th>Organization</th>
                    <th>Date Joined</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.colVis.min.js"></script>

<script>
    $(document).ready(function () {
        class UserFilterManager {
            constructor() {
                this.table = null;
                this.apiUrl = $('#usersTable').data('api-url');
            }

            init() {
                this.initSelect2();
                this.initDataTable();
                this.initEventListeners();
            }

            initSelect2() {
                const commonOptions = {
                    theme: 'bootstrap-5',
                    allowClear: true,
                    width: '100%',
                };

                $('#org_type').select2({
                    ...commonOptions,
                    placeholder: 'All Types',
                    ajax: {
                        url: '/core-admin/api/search/org-types/',
                        dataType: 'json',
                        delay: 250,
                        data: params => ({ search: params.term }),
                        processResults: data => ({
                            results: data.org_types.map(item => ({ id: item.id, text: item.name }))
                        }),
                        cache: true
                    }
                });

                $('#organization').select2({
                    ...commonOptions,
                    placeholder: 'All Organizations',
                    ajax: {
                        url: '/core-admin/api/filter/organizations/',
                        dataType: 'json',
                        delay: 250,
                        data: params => ({
                            'org_type_ids[]': $('#org_type').val(),
                            search: params.term
                        }),
                        processResults: data => ({
                            results: data.organizations.map(item => ({ id: item.id, text: `${item.name} (${item.org_type})` }))
                        }),
                    }
                });

                $('#role').select2({
                    ...commonOptions,
                    placeholder: 'All Roles',
                    ajax: {
                        url: '/core-admin/api/filter/roles/',
                        dataType: 'json',
                        delay: 250,
                        data: params => ({
                            'organization_ids[]': $('#organization').val(),
                            search: params.term
                        }),
                        processResults: data => ({
                            results: data.roles.map(item => ({ id: item.id, text: `${item.name} (${item.organization})` }))
                        }),
                    }
                });
            }

            initDataTable() {
                this.table = $('#usersTable').DataTable({
                    processing: true,
                    serverSide: true,
                    ajax: {
                        url: this.apiUrl,
                        data: (d) => {
                            const filters = this.collectFilters();
                            d.q = filters.q;
                            d.status = filters.status;
                            d['org_type[]'] = filters.orgTypes;
                            d['organization[]'] = filters.organizations;
                            d['role[]'] = filters.roles;
                            d['role_name'] = filters.roleName; // For dashboard links
                        }
                    },
                    columns: [
                        { data: 's_no', name: 's_no', orderable: false, searchable: false },
                        { data: 'name', name: 'name' },
                        { data: 'email', name: 'email' },
                        { data: 'roles', name: 'roles', orderable: false, searchable: false },
                        { data: 'organization', name: 'organization', orderable: false, searchable: false },
                        { data: 'date_joined', name: 'date_joined' },
                        { data: 'status', name: 'status', orderable: false, searchable: false },
                        { data: 'action', name: 'action', orderable: false, searchable: false }
                    ],
                    dom: '<"dt-toolbar d-flex justify-content-between align-items-center flex-wrap mb-3"lBf>rtip',
                    responsive: true,
                    pagingType: 'simple_numbers',
                    lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]],
                    pageLength: 25,
                    order: [[5, 'desc']],
                    buttons: ['copy', 'excel', 'pdf', 'print', 'colvis'],
                    language: { search: "_INPUT_", searchPlaceholder: "Search table..." },
                    initComplete: () => {
                        // Apply filters from URL after the table is fully initialized
                        this.applyFiltersFromURL();
                    }
                });

                $.fn.dataTable.ext.errMode = 'none';
                $('#usersTable').on('error.dt', (e, settings, techNote, message) => {
                    console.error('DataTables error:', message);
                });
            }

            initEventListeners() {
                $('#applyFiltersBtn').on('click', () => this.applyFilters(true));
                $('#clearFiltersBtn').on('click', () => this.clearFilters());
                $('#toggleFiltersBtn').on('click', () => this.toggleFilterVisibility());

                $('#org_type').on('change', () => {
                    $('#organization').val(null).trigger('change');
                });
                $('#organization').on('change', () => {
                    $('#role').val(null).trigger('change');
                });
                // Trigger Apply Filters on Enter key in any filter input
                const filterInputs = [
                    '#q',
                    '#status',
                    '#org_type',
                    '#organization',
                    '#role'
                ];
                filterInputs.forEach(selector => {
                    $(selector).on('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            this.applyFilters(true);
                        }
                    });
                });
            }
            

            collectFilters() {
                const params = new URLSearchParams(window.location.search);
                return {
                    q: $('#q').val(),
                    status: $('#status').val(),
                    orgTypes: $('#org_type').val() || [],
                    organizations: $('#organization').val() || [],
                    roles: $('#role').val() || [],
                    roleName: params.get('role')
                };
            }

            applyFilters(updateUrl = false) {
                this.table.ajax.reload();
                if (updateUrl) {
                    this.updateURL();
                }
            }

            clearFilters() {
                const currentUrl = new URL(window.location);
                currentUrl.search = ''; // Clear all query parameters
                history.pushState(null, '', currentUrl.toString());

                $('#q, #status').val('');
                $('#org_type, #organization, #role').val(null).trigger('change');
                this.table.ajax.reload();
            }

            updateURL() {
                const filters = this.collectFilters();
                const params = new URLSearchParams();

                if (filters.q) params.set('q', filters.q);
                if (filters.status) params.set('status', filters.status);

                // Do not persist the 'role' name param once a specific ID is chosen
                if (filters.roleName && (!filters.roles || filters.roles.length === 0)) {
                    params.set('role', filters.roleName);
                }

                filters.orgTypes.forEach(id => params.append('org_type[]', id));
                filters.organizations.forEach(id => params.append('organization[]', id));
                filters.roles.forEach(id => params.append('role[]', id));

                const newUrl = `${window.location.pathname}?${params.toString()}`;
                history.pushState(null, '', newUrl);
            }

            applyFiltersFromURL() {
                const params = new URLSearchParams(window.location.search);
                $('#q').val(params.get('q') || '');
                $('#status').val(params.get('status') || '');

                // Handle initial role from dashboard redirect
                const initialRolesData = $('#role').data('initial-roles');
                if (initialRolesData && initialRolesData.length > 0) {
                    const selectRole = $('#role');
                    selectRole.empty(); // Clear existing options
                    initialRolesData.forEach(role => {
                        // Create a new option and select it
                        const option = new Option(role.text, role.id, true, true);
                        selectRole.append(option);
                    });
                    selectRole.trigger('change'); // Notify Select2
                } else {
                    // Handle manual filters if no initial role
                    this.prepopulateSelect2FromURL('role', params.getAll('role[]'), '/core-admin/api/filter/roles/', 'roles');
                }

                // Pre-populate other filters
                this.prepopulateSelect2FromURL('org_type', params.getAll('org_type[]'), '/core-admin/api/search/org-types/', 'org_types');
                this.prepopulateSelect2FromURL('organization', params.getAll('organization[]'), '/core-admin/api/filter/organizations/', 'organizations');
            }

            prepopulateSelect2FromURL(elementId, values, ajaxUrl, dataKey) {
                if (!values || values.length === 0) return;

                const select = $(`#${elementId}`);
                if (select.val() && select.val().length > 0) return;

                const fetchPromises = values.map(id => $.ajax({
                    url: ajaxUrl,
                    data: { 'id': id } // Assuming API can fetch by a single ID
                }));

                Promise.all(fetchPromises).then(responses => {
                    responses.forEach((response, index) => {
                        const items = response[dataKey] || [];
                        const item = items.find(d => d.id == values[index]);
                        if (item) {
                            const text = item.org_type ? `${item.name} (${item.org_type})` :
                                item.organization ? `${item.name} (${item.organization})` :
                                    item.name;
                            const option = new Option(text, item.id, true, true);
                            select.append(option);
                        }
                    });
                    select.trigger('change');
                });
            }

            toggleFilterVisibility() {
                $('#filtersSection').toggleClass('filters-collapsed');
                const isCollapsed = $('#filtersSection').hasClass('filters-collapsed');
                $('#filterToggleIcon').toggleClass('fa-chevron-up fa-chevron-down');
                $('#filterToggleText').text(isCollapsed ? 'Expand' : 'Collapse');
            }
        }

        const manager = new UserFilterManager();
        manager.init();
    });
</script>
{% endblock %}