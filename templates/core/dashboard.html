{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard — Event Management Suite{% endblock %}

{% block head_extra %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<link rel="stylesheet" href="{% static 'core/css/dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="ems-dashboard">
  <header class="topbar">
    <div>
      <h1>Welcome back, {{ user.first_name|default:user.username }}</h1>
      <span class="topbar-date">{% now "F j, Y · l" %}</span>
    </div>
  </header>

  <!-- TOP ROW -->
  <section class="kpi-row">
    <button class="kpi-card" id="kpiStudents" type="button" aria-label="Students KPI">
      <div class="kpi-icon bg-indigo" aria-hidden="true"><i class="fa-solid fa-user-graduate" aria-hidden="true"></i></div>
      <div class="kpi-content">
        <span class="kpi-title">Students</span>
        <span class="kpi-value">{{ mentee_count|default:0 }}</span>
        <span class="kpi-bar" style="--pct:60%"></span>
      </div>
    </button>

    <button class="kpi-card" id="kpiClasses" type="button" aria-label="Classes KPI">
      <div class="kpi-icon bg-sky" aria-hidden="true"><i class="fa-solid fa-chalkboard-user" aria-hidden="true"></i></div>
      <div class="kpi-content">
        <span class="kpi-title">Classes</span>
        <span class="kpi-value">{{ classes_count|default:0 }}</span>
        <span class="kpi-bar" style="--pct:55%"></span>
      </div>
    </button>

    <button class="kpi-card" id="kpiOrgEvents" type="button" aria-label="Organized events KPI">
      <div class="kpi-icon bg-orange" aria-hidden="true"><i class="fa-solid fa-calendar-check" aria-hidden="true"></i></div>
      <div class="kpi-content">
        <span class="kpi-title">Organized Events</span>
        <span class="kpi-value">{{ organized_events_count|default:0 }}</span>
        <span class="kpi-bar" style="--pct:45%"></span>
      </div>
    </button>

    <button class="kpi-card" id="kpiPartEvents" type="button" aria-label="Participated events KPI">
      <div class="kpi-icon bg-emerald" aria-hidden="true"><i class="fa-solid fa-people-group" aria-hidden="true"></i></div>
      <div class="kpi-content">
        <span class="kpi-title">Participated Events</span>
        <span class="kpi-value">{{ participated_events_count|default:0 }}</span>
        <span class="kpi-bar" style="--pct:65%"></span>
      </div>
    </button>

    <!-- Profile section: Admin vs Non-Admin -->
    {% if is_admin_user %}
      {# Admin users: show a compact admin profile summary; admin dashboard may also have its own template #}
      <div class="profile-kpi card" style="padding: 24px 28px; display:grid; grid-template-columns: 120px 1fr; gap: 28px; align-items: center; min-height: 170px;">
        <div class="pkp-avatar" style="width: 110px; height: 110px; border-radius: 18px; background: #e5e7eb; overflow: hidden; display: flex; align-items: center; justify-content: center;">
          {% if user.profile and user.profile.photo %}
            <img src="{{ user.profile.photo.url }}" alt="{{ user.get_full_name|default:user.username }}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 18px;">
          {% else %}
            <span class="pkp-initials" aria-hidden="true" style="font-size: 38px; font-weight: 900; color: var(--primary);">
              {% if user.first_name %}{{ user.first_name.0|upper }}{% if user.last_name %}{{ user.last_name.0|upper }}{% endif %}{% else %}{{ user.username.0|upper }}{% endif %}
            </span>
          {% endif %}
        </div>
        <div class="pkp-body" style="display: flex; flex-direction: column; gap: 10px; min-width: 0;">
          <h1 class="pkp-name" style="font-size: 24px; font-weight: 800; margin: 0; color: var(--ink); line-height: 1.1;">{{ user.get_full_name|default:user.username }}</h1>
          <h2 class="pkp-sub" style="font-size: 15px; font-weight: 600; color: var(--muted); margin: 0;">{{ user.email }}</h2>
          <h3 class="pkp-meta" style="margin: 8px 0 0; display: flex; gap: 24px; font-size: 13px; font-weight: 600; color: var(--muted);">
            <span>Role: <strong style="color: var(--ink); font-weight: 800;">Admin</strong></span>
            <span>Access: <strong style="color: var(--ink); font-weight: 800;">Full</strong></span>
          </h3>
          <div class="pkp-actions" style="display: flex; gap: 12px; margin-top: 10px;">
            <a href="{% url 'admin_dashboard' %}" class="btn btn-profile-primary" style="padding: 8px 18px; border-radius: 6px; background: var(--primary); color: #fff; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; font-size: 14px;">
              <i class="fas fa-gauge"></i> <span>Admin Dashboard</span>
            </a>
            <a href="{% url 'my_profile' %}" class="btn btn-profile-secondary" style="padding: 8px 18px; border-radius: 6px; background: #fff; color: var(--ink); font-weight: 600; border: 1px solid var(--border); display: inline-flex; align-items: center; gap: 6px; font-size: 14px;">
              <i class="fas fa-user-cog"></i> <span>My Profile</span>
            </a>
          </div>
        </div>
      </div>
    {% else %}
      {# Non-admin users (faculty, student, etc.): show unified non-admin profile UI #}
      <div class="profile-kpi card" style="padding: 24px 28px; display:grid; grid-template-columns: 120px 1fr; gap: 28px; align-items: center; min-height: 170px;">
        <div class="pkp-avatar" style="width: 110px; height: 110px; border-radius: 18px; background: #e5e7eb; overflow: hidden; display: flex; align-items: center; justify-content: center;">
          {% if user.profile and user.profile.photo %}
            <img src="{{ user.profile.photo.url }}" alt="{{ user.get_full_name|default:user.username }}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 18px;">
          {% else %}
            <span class="pkp-initials" aria-hidden="true" style="font-size: 38px; font-weight: 900; color: var(--primary);">
              {% if user.first_name %}{{ user.first_name.0|upper }}{% if user.last_name %}{{ user.last_name.0|upper }}{% endif %}{% else %}{{ user.username.0|upper }}{% endif %}
            </span>
          {% endif %}
        </div>
        <div class="pkp-body" style="display: flex; flex-direction: column; gap: 10px; min-width: 0;">
          <h1 class="pkp-name" style="font-size: 24px; font-weight: 800; margin: 0; color: var(--ink); line-height: 1.1;">{{ user.get_full_name|default:user.username }}</h1>
          <h2 class="pkp-sub" style="font-size: 15px; font-weight: 600; color: var(--muted); margin: 0;">{{ user.email }}</h2>
          <h3 class="pkp-meta" style="margin: 8px 0 0; display: flex; gap: 24px; font-size: 13px; font-weight: 600; color: var(--muted);">
            {% if is_student %}
              {# Student meta: Department/Year (from context when available) #}
              <span>Department: <strong style="color: var(--ink); font-weight: 800;">{{ student_department|default:"—" }}</strong></span>
              <span>Year: <strong style="color: var(--ink); font-weight: 800;">{{ student_year|default:"—" }}</strong></span>
            {% else %}
              {# Faculty/other meta: Rank/Classes #}
              <span>Rank: <strong style="color: var(--ink); font-weight: 800;">{{ user.rank|default:"—" }}</strong></span>
              <span>Classes: <strong style="color: var(--ink); font-weight: 800;">{{ classes_count|default:0 }}</strong></span>
            {% endif %}
          </h3>
          <div class="pkp-actions" style="display: flex; gap: 12px; margin-top: 10px;">
            <a href="{% url 'my_profile' %}" class="btn btn-profile-primary" style="padding: 8px 18px; border-radius: 6px; background: var(--primary); color: #fff; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; font-size: 14px;">
              <i class="fas fa-user-cog"></i> <span>View Profile</span>
            </a>
            <a href="{% url 'my_profile' %}?tab=edit" class="btn btn-profile-secondary" style="padding: 8px 18px; border-radius: 6px; background: #fff; color: var(--ink); font-weight: 600; border: 1px solid var(--border); display: inline-flex; align-items: center; gap: 6px; font-size: 14px;">
              <i class="fas fa-edit"></i> <span>Edit Profile</span>
            </a>
          </div>
        </div>
      </div>
    {% endif %}
  </section>

  <!-- MAIN GRID -->
  <main class="grid-3">
    <!-- Actions (col 1) -->
    <section class="card eq" id="cardActions">
      <div class="card-header">
        <h3><i class="fa-solid fa-inbox" aria-hidden="true"></i> Actions &amp; Proposals</h3>
        <a class="link-muted" href="#" data-go-tab="events" aria-label="View all proposals">View all</a>
      </div>
      <div class="list" id="actionsList">
        <!-- Dynamic: populated by /api/user/proposals -->
        <div class="proposal-tracker-section" id="proposalTracker">
          <h4><i class="fa-solid fa-file-lines" aria-hidden="true"></i> My Proposals</h4>
          <div id="proposalsList"><div class="empty">Loading…</div></div>
        </div>
      </div>
    </section>

    <!-- Performance (col 2) -->
    <section class="card eq" id="cardPerformance">
      <div class="card-header">
        <h3><i class="fa-solid fa-chart-pie" aria-hidden="true"></i> <span id="perfTitle">Student Performance</span></h3>
        <div class="header-actions">
          <div class="seg" role="tablist" aria-label="Performance views">
            <button class="seg-btn active" data-view="performance" type="button" role="tab" aria-selected="true">Performance</button>
            <button class="seg-btn" data-view="contribution" type="button" role="tab" aria-selected="false">Contribution</button>
          </div>
        </div>
      </div>
      <div class="chart-wrap donut" id="chartContainer" style="cursor: pointer;">
        <canvas id="donutChart" aria-label="Performance donut chart" role="img"></canvas>
        <div class="chart-legend" id="donutLegend" aria-live="polite"></div>
        <div class="chart-click-hint" style="text-align:center;font-size:12px;color:#666;margin-top:10px;">
          <i class="fa-solid fa-hand-pointer" aria-hidden="true"></i> Click to view proposal tracking
        </div>
      </div>
    </section>

    <!-- Calendar (col 3, row 1) -->
    <section class="card eq" id="cardCalendar">
      <div class="card-header">
        <h3><i class="fa-regular fa-calendar" aria-hidden="true"></i> Calendar</h3>
        <div class="header-actions">
          <label for="visibilitySelect" class="visually-hidden">Visibility</label>
          <a href="/suite/submit/?via=dashboard" class="chip-btn" id="addEventBtn" aria-label="Create a new event"><i class="fa-solid fa-plus" aria-hidden="true"></i> New Event</a>
        </div>
      </div>
      <div class="mini-cal" id="miniCalendar" aria-live="polite">
        <div class="cal-head">
          <button class="cal-nav" id="calPrev" aria-label="Previous month"><i class="fa-solid fa-chevron-left" aria-hidden="true"></i></button>
          <div id="calTitle" aria-live="polite">Month YYYY</div>
          <button class="cal-nav" id="calNext" aria-label="Next month"><i class="fa-solid fa-chevron-right" aria-hidden="true"></i></button>
        </div>
        <div class="cal-weekdays" aria-hidden="true">
          <span>S</span><span>M</span><span>T</span><span>W</span><span>T</span><span>F</span><span>S</span>
        </div>
        <div class="cal-grid" id="calGrid" role="grid" aria-label="Monthly calendar"></div>
      </div>
      <!-- Removed per request: hide the small scrollable event list under the calendar -->
      <!-- <div id="upcomingWrap" class="upcoming" aria-live="polite"></div> -->
    </section>

    <!-- Contribution (span same width as Actions + Performance) -->
    <section class="card" id="cardContribution">
      <div class="card-header"><h3><i class="fa-solid fa-fire" aria-hidden="true"></i> Yearly Contribution</h3></div>
      <div id="heatmapContainer" class="heatmap" role="img" aria-label="Contribution heatmap"></div>
    </section>

    <!-- Event Details Viewer (col 3, row 2) -->
    <section class="card eq" id="cardEventDetails">
      <div class="card-header">
        <h3><i class="fa-regular fa-calendar-days" aria-hidden="true"></i> Event Details</h3>
        <button class="chip-btn" id="clearEventDetails" type="button" style="display: none;">
          <i class="fa-solid fa-times" aria-hidden="true"></i> Clear
        </button>
      </div>
      <div id="eventDetailsContent" class="event-details-content">
        <div class="empty">Click an event in the calendar to view details</div>
      </div>
    </section>
  </main>

  {{ calendar_events|json_script:"calendarEventsJson" }}
  <script>
    try {
      window.DASHBOARD_EVENTS = JSON.parse(document.getElementById('calendarEventsJson').textContent);
    } catch {
      window.DASHBOARD_EVENTS = [];
    }
  </script>

  <!-- Confirmation Modal -->
  <div id="confirmationModal" class="modal-overlay" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="modal-content">
      <h3 id="confirmTitle"><i class="fa-solid fa-question-circle" aria-hidden="true"></i> Open in Google Calendar?</h3>
      <p>Do you want to open this event in Google Calendar?</p>
      <div class="modal-actions">
        <button class="btn-secondary" id="cancelConfirm" type="button">No, stay here</button>
        <button class="btn-primary" id="confirmOpen" type="button">Yes, open Google Calendar</button>
      </div>
    </div>
  </div>

  <!-- Faculty Meeting Form Modal -->
  <div id="facultyMeetingModal" class="modal-overlay" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="facultyModalTitle">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h3 id="facultyModalTitle"><i class="fa-solid fa-calendar-plus" aria-hidden="true"></i> Schedule Faculty Meeting</h3>
        <button class="modal-close" id="closeFacultyModal" type="button" aria-label="Close">&times;</button>
      </div>
      <form id="facultyMeetingForm" method="post" novalidate>
        {% csrf_token %}
        <div class="form-group">
          <label for="meetingTitle">Meeting title *</label>
          <input type="text" id="meetingTitle" required aria-required="true" placeholder="Enter meeting title">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="meetingDate">Date *</label>
            <input type="date" id="meetingDate" required aria-required="true">
          </div>
          <div class="form-group">
            <label for="meetingTime">Time *</label>
            <input type="time" id="meetingTime" required aria-required="true" value="09:00">
          </div>
        </div>

        <div class="form-group">
          <label for="meetingPlace">Place/Venue</label>
          <select id="meetingPlace">
            <option value="">Select venue…</option>
          </select>
        </div>

        <div class="form-group">
          <label for="meetingParticipants">Participants</label>
          <select id="meetingParticipants" multiple aria-describedby="participantsHelp">
            <option value="">Loading participants…</option>
          </select>
          <small id="participantsHelp">Hold Ctrl (Windows) or Cmd (macOS) to select multiple participants.</small>
        </div>

        <div class="form-group">
          <label for="meetingNotes">Additional notes</label>
          <textarea id="meetingNotes" rows="3" placeholder="Add agenda or notes…"></textarea>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-secondary" id="cancelMeeting">Cancel</button>
          <button type="submit" class="btn-primary">
            <i class="fa-solid fa-calendar-plus" aria-hidden="true"></i> Schedule meeting
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Event Creation Modal -->
  <div id="eventCreationModal" class="modal-overlay" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="eventModalTitle">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h3 id="eventModalTitle"><i class="fa-solid fa-calendar-plus" aria-hidden="true"></i> Create New Event</h3>
        <button class="modal-close" id="closeEventModal" type="button" aria-label="Close">&times;</button>
      </div>
      <form id="eventCreationForm" novalidate>
        <div class="form-group">
          <label for="eventTitle">Event title *</label>
          <input type="text" id="eventTitle" required aria-required="true" placeholder="Enter event title">
        </div>

        <div class="form-group">
          <label for="eventDescription">Description</label>
          <textarea id="eventDescription" rows="3" placeholder="Add a short description…"></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="eventDate">Date *</label>
            <input type="date" id="eventDate" required aria-required="true">
          </div>
          <div class="form-group">
            <label for="eventTime">Time *</label>
            <input type="time" id="eventTime" required aria-required="true">
          </div>
        </div>

        <div class="form-group">
          <label for="eventVenue">Venue</label>
          <select id="eventVenue">
            <option value="">Select venue…</option>
          </select>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-secondary" id="cancelEvent">Cancel</button>
          <button type="submit" class="btn-primary">
            <i class="fa-solid fa-calendar-plus" aria-hidden="true"></i> Create event
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script src="{% static 'core/js/calendar.js' %}"></script>
<script src="{% static 'core/js/dashboard.js' %}"></script>
{% endblock %}
