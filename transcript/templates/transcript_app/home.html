{% extends 'base.html' %}
{% load static %}

{% block title %}Transcript Generator{% endblock %}

{% block head_extra %}
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{% static 'core/css/dashboard.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root{
  --primary:#1e60b1; --primary-dark:#164c8d;
  --ink:#0f172a; --muted:#64748b; --border:#e5e7eb;
  --surf:#ffffff; --subtle:#f8fafc;
  --shadow:0 8px 24px rgba(2,6,23,.06);
  --shadow-lg:0 12px 40px rgba(2,6,23,.10);
  --shadow-sm:0 4px 12px rgba(2,6,23,.04);
}

/* Typography baseline */
body, .dashboard-container, .transcript-form-card, .student-table{
  font-family:"Open Sans",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
  color:var(--ink);
}

/* PAGE: white from top-left, full width (override dashboard.css centering/max-width) */
.dashboard-container{
  width:100% !important; max-width:none !important; margin:0 !important;
  min-height:100vh; background:#fff; padding:16px;
  display:flex; flex-direction:column; gap:12px; align-items:stretch !important;
}
.dashboard-container > *{ max-width:none !important; }

/* Top-left heading (outside any box) */
.page-header{ width:100%; }
.page-header h1{
  margin:0 0 4px; font-size:clamp(20px,2.2vw,28px); font-weight:800; letter-spacing:-.01em; color:var(--ink);
}
.page-header p{ margin:0; color:var(--muted); font-size:13px; font-weight:600; }

/* Main card */
.transcript-form-card{
  width:100% !important; max-width:none !important; margin:0 !important;
  background:#fff; border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow);
  padding:12px;
}
/* Hide legacy in-card title block */
.transcript-form-header, .transcript-form-title, .transcript-form-subtitle{ display:none !important; }

/* Controls row */
.form-inline{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:flex-start; margin:0; }
.form-inline select, .form-inline button{ min-width:200px; padding:10px 14px; border-radius:10px; font-size:14px; transition:.18s ease; }
.form-inline select{
  border:1px solid var(--border); background:#fff; position:relative; z-index:1;
}
.form-inline select:focus{ border-color:var(--primary); outline:none; box-shadow:0 0 0 3px rgba(30,96,177,.12); }
.form-inline select:disabled{ opacity:.6; cursor:not-allowed; }
.form-inline button{
  background:linear-gradient(135deg,var(--primary),var(--primary-dark));
  color:#fff; font-weight:800; border:1px solid var(--primary);
  display:inline-flex; align-items:center; gap:8px;
}
.form-inline button:hover{ transform:translateY(-2px); box-shadow:var(--shadow); filter:brightness(1.05); }
.form-inline button:disabled{ background:#9aa3ae; border-color:#9aa3ae; cursor:not-allowed; transform:none; box-shadow:none; }

/* Students block */
.student-list-container{ margin-top:10px; display:flex; flex-direction:column; gap:10px; }
.student-list-header{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; padding-bottom:8px; border-bottom:1px solid var(--border); }
.student-list-title{ font-size:16px; font-weight:800; color:var(--ink); display:flex; align-items:center; gap:8px; }
.student-list-title i{ color:var(--primary); }
.student-header-right{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
.student-count{
  font-size:12px; color:var(--ink); background:#eef2ff; padding:6px 10px; border-radius:999px;
  font-weight:800; border:1px solid #e0e7ff;
}

/* Primary action buttons */
.btn-download-all{
  background:linear-gradient(135deg,var(--primary),var(--primary-dark));
  color:#fff; padding:10px 14px; font-size:13px; font-weight:800; border-radius:10px; border:1px solid var(--primary);
  display:inline-flex; align-items:center; gap:8px; transition:.18s ease; box-shadow:var(--shadow-sm);
}
.btn-download-all:hover{ transform:translateY(-2px); box-shadow:var(--shadow); filter:brightness(1.05); }

/* Search chip */
.search-bar-wrapper{ display:flex; align-items:center; gap:8px; background:#fff; border-radius:999px; border:1px solid var(--border); padding:8px 12px; max-width:400px; margin-left:auto; }
.search-bar-wrapper input{ border:none; outline:none; background:transparent; font-size:14px; flex:1; }
.search-bar-wrapper i{ color:var(--primary); font-size:14px; }

/* TABLE */
.student-table-wrapper{ overflow-x:auto; }
.student-table{
  width:100%; border-collapse:collapse; background:#fff;
  border:1px solid var(--border); border-radius:12px; overflow:hidden;
  font-size:13px; box-shadow:var(--shadow-sm);
}
.student-table thead{
  background:linear-gradient(135deg,var(--primary),var(--primary-dark)); color:#fff;
}
.student-table th, .student-table td{ padding:10px 12px; text-align:left; border-bottom:1px solid var(--border); }
.student-table th{ font-size:12px; text-transform:uppercase; letter-spacing:.5px; font-weight:800; color:#fff; }
/* Keep header blue on hover/click */
.student-table thead tr:hover{ background:inherit; }
.student-table tbody tr{ transition:background .15s ease; }
.student-table tbody tr:hover{ background:#f8fafc; }
.student-table td:last-child{ white-space:nowrap; }

/* Status chips + row buttons */
.status-badge{ padding:4px 10px; border-radius:999px; font-weight:800; font-size:12px; border:1px solid transparent; }
.status-active{ background:#ecfdf5; color:#16a34a; border-color:#a7f3d0; }
.status-inactive{ background:#fffbeb; color:#b45309; border-color:#fde68a; }
.action-btn{
  padding:8px 12px; font-size:13px; border-radius:10px; border:1px solid var(--border);
  text-decoration:none; display:inline-flex; align-items:center; gap:6px; font-weight:800; transition:.15s ease;
}
.btn-view, .btn-download{ background:#fff; color:var(--ink); }
.btn-view:hover, .btn-download:hover{ transform:translateY(-1px); box-shadow:var(--shadow-sm); border-color:var(--primary); color:var(--primary); }

/* Empty */
.empty-state{ text-align:center; color:var(--muted); font-size:14px; margin:16px 0; padding:20px 0; }

/* Responsive */
@media (max-width:768px){
  .dashboard-container{ padding:12px; }
  .form-inline{ flex-direction:column; align-items:stretch; }
  .form-inline select, .form-inline button{ width:100%; min-width:auto; }
  .student-header-right{ width:100%; justify-content:space-between; }
  .search-bar-wrapper{ max-width:100%; margin-left:0; }
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
  <div class="page-header">
    <h1>Transcript Generator</h1>
    <p>View and manage student character strength transcripts</p>
  </div>

  <div class="transcript-form-card">
    <form id="transcriptForm">
      <div class="form-inline">
        <select id="academicYearSelect" required aria-label="Select Academic Year">
          <option value="">Select Academic Year</option>
          {% for year in years %}
            <option value="{{ year.year }}">{{ year.year }}</option>
          {% endfor %}
        </select>

        <select id="schoolSelect" required disabled aria-label="Select School">
          <option value="">Select School</option>
        </select>

        <select id="courseSelect" required disabled aria-label="Select Course">
          <option value="">Select Course</option>
        </select>

        <button type="submit" id="showStudentsBtn" disabled>
          <i class="fa-solid fa-users"></i> Show Students
        </button>
      </div>
    </form>

    <div class="student-list-container" id="studentListContainer">
      <div class="student-list-header">
        <div class="student-list-title"><i class="fa-solid fa-users"></i> Students</div>
        <div class="student-header-right">
          <div class="student-count" id="studentCount">0 students</div>
          <button id="downloadAllPDFBtn" class="btn-download-all"><i class="fa-solid fa-download"></i> Download Combined PDF</button>
          <button id="downloadAllZIPBtn" class="btn-download-all"><i class="fa-solid fa-file-zipper"></i> Download All (ZIP)</button>
        </div>
      </div>

      <div class="search-bar-wrapper">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input type="text" id="studentSearchInput" placeholder="Search students by name or roll no..." oninput="filterStudentList()">
      </div>

      <div class="student-table-wrapper">
        <table class="student-table" id="studentListTable">
          <thead>
            <tr><th>Name</th><th>Roll No</th><th>Status</th><th>Actions</th></tr>
          </thead>
          <tbody id="studentListTableBody"></tbody>
        </table>
      </div>

      <div class="empty-state" id="emptyState" style="display:none;">No students found for this filter.</div>
    </div>
  </div>
</div>

<!-- Spinner Overlay -->
<div id="downloadSpinner" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.4); z-index:9999; justify-content:center; align-items:center;">
  <div class="loader"></div>
</div>
<iframe id="downloadIframe" style="display:none;"></iframe>
{% endblock %}

{% block scripts %}
<script>
  /* ----- DOM refs ----- */
  const transcriptForm       = document.getElementById('transcriptForm');
  const academicYearSelect   = document.getElementById('academicYearSelect');
  const schoolSelect         = document.getElementById('schoolSelect');
  const courseSelect         = document.getElementById('courseSelect');
  const showStudentsBtn      = document.getElementById('showStudentsBtn');
  const studentListContainer = document.getElementById('studentListContainer');
  const studentCount         = document.getElementById('studentCount');
  const downloadAllPDFBtn    = document.getElementById('downloadAllPDFBtn');
  const downloadAllZIPBtn    = document.getElementById('downloadAllZIPBtn');
  const studentSearchInput   = document.getElementById('studentSearchInput');
  const iframe               = document.getElementById('downloadIframe');
  const emptyState           = document.getElementById('emptyState');

  /* ----- Data ----- */
  const studentRawData = JSON.parse(`{{ student_data|escapejs }}`);
  const studentData    = studentRawData;
  let originalStudentList = [];
  let currentStudents      = [];

  /* ----- Helpers ----- */
  const resetDropdown = (dropdown, placeholder) => {
    dropdown.innerHTML = `<option value="">${placeholder}</option>`;
    dropdown.disabled = true;
  };

  const populateDropdown = (dropdown, options) => {
    const ph = dropdown.querySelector('option[value=""]').textContent;
    dropdown.innerHTML = `<option value="">${ph}</option>`;
    options.forEach(opt => {
      const o = document.createElement('option');
      o.value = opt; o.textContent = opt;
      dropdown.appendChild(o);
    });
  };

  const displayStudents = (students) => {
    const tbody = document.getElementById("studentListTableBody");
    tbody.innerHTML = "";
    studentCount.textContent = `${students.length} students`;

    if (!students.length) {
      emptyState.style.display = '';
      studentListContainer.classList.add('show');
      return;
    }
    emptyState.style.display = 'none';

    students.forEach(s => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${s.name}</td>
        <td>${s.roll_no}</td>
        <td>
          <span class="status-badge ${s.active === false ? 'status-inactive' : 'status-active'}">
            ${s.active === false ? 'Inactive' : 'Active'}
          </span>
        </td>
        <td>
          <a href="/transcript/${s.roll_no}/" class="action-btn btn-view"><i class="fa-solid fa-eye"></i> View</a>
          <a href="/transcript/${s.roll_no}/pdf/" class="action-btn btn-download"><i class="fa-solid fa-download"></i> PDF</a>
        </td>`;
      tbody.appendChild(tr);
    });
    studentListContainer.classList.add('show');
  };

  function filterStudentList() {
    const q = studentSearchInput.value.toLowerCase().trim();
    if (!q) { displayStudents(originalStudentList); return; }
    const filtered = originalStudentList.filter(s => s.name.toLowerCase().includes(q) || s.roll_no.toLowerCase().includes(q));
    displayStudents(filtered);
  }

  function downloadAll(type='pdf') {
    const year = academicYearSelect.value, school = schoolSelect.value, course = courseSelect.value;
    if (!year || !school || !course) { alert("Please select year, school, and course first."); return; }
    const url = `/transcript/pdf/all/?year=${encodeURIComponent(year)}&school=${encodeURIComponent(school)}&course=${encodeURIComponent(course)}&type=${type}`;
    document.getElementById('downloadSpinner').style.display = 'flex';
    iframe.src = url;
    setTimeout(() => { document.getElementById('downloadSpinner').style.display = 'none'; }, 15000);
  }

  /* ----- Event wiring ----- */
  academicYearSelect.addEventListener('change', function () {
    const yearKey = this.value;

    resetDropdown(schoolSelect, 'Select School');
    resetDropdown(courseSelect, 'Select Course');
    studentListContainer.classList.remove('show');
    showStudentsBtn.disabled = true;

    const yearObj = studentData && studentData[yearKey];
    if (yearObj && Object.keys(yearObj).length) {
      populateDropdown(schoolSelect, Object.keys(yearObj));
      schoolSelect.disabled = false;
      schoolSelect.style.pointerEvents = 'auto';
      schoolSelect.focus({ preventScroll:true });
    }
  });

  schoolSelect.addEventListener('change', function () {
    const yearKey = academicYearSelect.value;
    const schoolKey = this.value;

    resetDropdown(courseSelect, 'Select Course');
    studentListContainer.classList.remove('show');
    showStudentsBtn.disabled = true;

    if (yearKey && schoolKey && studentData[yearKey][schoolKey]) {
      populateDropdown(courseSelect, Object.keys(studentData[yearKey][schoolKey]));
      courseSelect.disabled = false;
      courseSelect.style.pointerEvents = 'auto';
    }
  });

  courseSelect.addEventListener('change', function () {
    showStudentsBtn.disabled = !this.value;
    studentListContainer.classList.remove('show');
  });

  transcriptForm.addEventListener('submit', function (e) {
    e.preventDefault();
    const year = academicYearSelect.value, school = schoolSelect.value, course = courseSelect.value;
    if (!year || !school || !course) return;

    showStudentsBtn.innerHTML = '<span class="skeleton" style="width:80px;height:20px;"></span>';
    showStudentsBtn.disabled = true;

    const students = studentData[year][school][course]
      .slice()
      .sort((a,b) => a.roll_no.localeCompare(b.roll_no, undefined, { numeric:true, sensitivity:'base' }));

    originalStudentList = students;
    currentStudents = students;

    setTimeout(() => {
      displayStudents(students);
      showStudentsBtn.innerHTML = '<i class="fa-solid fa-users"></i> Show Students';
      showStudentsBtn.disabled = false;
    }, 350);
  });

  downloadAllPDFBtn.addEventListener("click", e => { e.preventDefault(); downloadAll('pdf'); });
  downloadAllZIPBtn.addEventListener("click", e => { e.preventDefault(); downloadAll('zip'); });
</script>
{% endblock %}
