{% with cat=form.initial.category|default:form.instance.category|default:form.fields.category.initial|default:'photo' %}
<div class="evidence-card" data-category="{{ cat }}" data-form-prefix="{{ prefix }}">
    {% for hidden in form.hidden_fields %}
        {{ hidden }}
    {% endfor %}
    <div class="evidence-card-frame">
        <div class="evidence-card-header">
            <button type="button" class="evidence-drag-handle" aria-label="Reorder attachment" title="Drag to reorder">
                <span class="drag-grip" aria-hidden="true"></span>
            </button>
            <button type="button" class="evidence-remove" title="Remove attachment">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="evidence-preview" data-preview
             {% if file_url %}data-file-url="{{ file_url }}"{% endif %}
             data-preview-type="{{ preview_type }}"
             data-category="{{ cat }}">
            {% if file_url %}
                {% if preview_type == 'image' %}
                    <img src="{{ file_url }}" alt="Attachment preview image">
                {% else %}
                    <div class="evidence-file">
                        <span class="file-name">{{ file_name|default:"Attachment" }}</span>
                        <span class="file-note">Images will be extracted</span>
                    </div>
                {% endif %}
            {% else %}
                <div class="evidence-placeholder">
                    <span class="placeholder-icon">+</span>
                    <span class="placeholder-text">Add file</span>
                </div>
            {% endif %}
        </div>
        {{ form.file }}
        <div class="evidence-meta">
            <label for="{{ prefix }}-caption">Caption <span class="meta-optional">(optional)</span></label>
            {{ form.caption.as_widget(attrs={
                'id': prefix|add:'-caption',
                'autocomplete': 'off',
            }) }}
            <p class="evidence-note" data-pdf-note {% if preview_type != 'file' %}hidden{% endif %}>
                Images will be extracted from PDFs or other files for the final report.
            </p>
        </div>
    </div>
    <div class="evidence-card-errors" aria-live="polite">
        {% if form.errors.file %}
            <div class="field-error">{{ form.errors.file.0 }}</div>
        {% endif %}
        {% if form.errors.caption %}
            <div class="field-error">{{ form.errors.caption.0 }}</div>
        {% endif %}
        {% if form.non_field_errors %}
            <div class="field-error">
                {% for error in form.non_field_errors %}
                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                {% endfor %}
            </div>
        {% endif %}
    </div>
    <div class="visually-hidden">
        {% if form.DELETE %}{{ form.DELETE }}{% endif %}
    </div>
</div>
{% endwith %}
