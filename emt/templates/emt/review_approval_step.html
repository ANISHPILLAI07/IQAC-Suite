{% extends "base.html" %}
{% load static %}

{% block title %}Review Proposal{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'emt/css/proposal_status_detail.css' %}">
<link rel="stylesheet" href="{% static 'emt/css/review_proposal.css' %}">

<div class="detail-container review-grid">

  <!-- LEFT COLUMN: Event Info Card -->
  <aside class="timeline-column review-side">
    <div class="info-card event-details-card">
      <h2>Event Information</h2>
      <table>
        <tr><th>Organization</th><td>{{ proposal.organization.name|default:"—" }}</td></tr>
        <tr>
          <th>Committees &amp; Collaborations</th>
          <td>
            {% if proposal.committees_collaborations %}
              {{ proposal.committees_collaborations }}
            {% elif proposal.committees %}
              {{ proposal.committees }}
            {% else %}
              —
            {% endif %}
          </td>
        </tr>
        <tr><th>Event Title</th><td>{{ proposal.event_title }}</td></tr>
        <tr><th>No. of Activities</th><td>{{ proposal.num_activities|default:"—" }}</td></tr>
        <tr>
          <th>Start Date</th>
          <td>
            {% if proposal.event_start_date %}
              {{ proposal.event_start_date|date:"d M Y" }}
            {% elif proposal.event_datetime %}
              {{ proposal.event_datetime|date:"d M Y" }}
            {% else %}
              —
            {% endif %}
          </td>
        </tr>
        <tr>
          <th>End Date</th>
          <td>
            {% if proposal.event_end_date %}
              {{ proposal.event_end_date|date:"d M Y" }}
            {% elif proposal.event_datetime %}
              {{ proposal.event_datetime|date:"d M Y" }}
            {% else %}
              —
            {% endif %}
          </td>
        </tr>
        <tr><th>Venue</th><td>{{ proposal.venue|default:"—" }}</td></tr>
        <tr><th>Academic Year</th><td>{{ proposal.academic_year|default:"—" }}</td></tr>
        <tr><th>Target Audience</th><td>{{ proposal.target_audience|default:"—" }}</td></tr>
        <tr><th>POS &amp; PSO</th><td>{{ proposal.pos_pso|default:"—" }}</td></tr>
        <tr>
          <th>SDG Goals</th>
          <td>
            {% with goals=proposal.sdg_goals.all %}
              {% if goals %}
                {% for goal in goals %}
                  {{ goal.name }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
              {% else %}
                —
              {% endif %}
            {% endwith %}
          </td>
        </tr>
        <tr>
          <th>Faculty Incharges</th>
          <td>
            {% with facs=proposal.faculty_incharges.all %}
              {% if facs %}
                {% for fac in facs %}
                  {{ fac.get_full_name|default:fac.username }} ({{ fac.email }}){% if not forloop.last %}, {% endif %}
                {% endfor %}
              {% else %}
                —
              {% endif %}
            {% endwith %}
          </td>
        </tr>
        <tr><th>Student Coordinators</th><td>{{ proposal.student_coordinators|default:"—" }}</td></tr>
        <tr><th>Type (Focus)</th><td>{{ proposal.event_focus_type|default:"—" }}</td></tr>
      </table>
    </div>
  </aside>

  <!-- RIGHT COLUMN: All Proposal Details -->
  <main class="details-column review-main">
    <header class="review-header overview-card">
      <nav class="review-nav" aria-label="Review navigation">
        <a href="{% url 'emt:my_approvals' %}" aria-label="Back to approvals"><i class="fas fa-arrow-left"></i></a>
      </nav>
      <div class="review-heading">
        <h1 class="review-title">Event Proposal Review</h1>
        <span class="status-badge status-{{ proposal.status }}">{{ proposal.get_status_display }}</span>
        <span class="meta">{{ proposal.event_title }} &middot; Submitted by {{ proposal.submitted_by.get_full_name }}</span>
      </div>
    </header>

    {% include "emt/partials/review_section.html" with title="Need Analysis" body=need_analysis.content %}

    {% include "emt/partials/review_section.html" with title="Objectives" body=objectives.content %}

    {% include "emt/partials/review_section.html" with title="Expected Outcomes" body=outcomes.content %}

    {% include "emt/partials/review_section.html" with title="Tentative Flow" body=flow.content %}

    <div class="event-details-card">
      <h3>Speaker Profile</h3>
      {% if speakers %}
        {% for sp in speakers %}
          <div class="speaker-profile-block">
            <div>
              <b>{{ sp.full_name }}</b> <span class="profile-aff">{{ sp.designation }}, {{ sp.affiliation }}</span>
              {% if sp.photo %}
                <img src="{{ sp.photo.url }}" class="speaker-photo" alt="Speaker Photo">
              {% endif %}
              <div class="profile-meta">
                <span>{{ sp.contact_email }}</span> &bull; <span>{{ sp.contact_number }}</span>
              </div>
              <div class="profile-desc">{{ sp.detailed_profile|default:"—" }}</div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="detail-block">—</div>
      {% endif %}
    </div>

    <div class="event-details-card">
      <div class="fin-row">
        <div class="fin-half">
          <h3>Income</h3>
          <table class="finance-table">
            <thead>
              <tr>
                <th>Sl.No</th>
                <th>Particulars</th>
                <th>No. Participants</th>
                <th>Rate</th>
                <th>Amount</th>
              </tr>
            </thead>
            <tbody>
              {% if income %}
                {% for inc in income %}
                  <tr>
                    <td>{{ inc.sl_no }}</td>
                    <td>{{ inc.particulars }}</td>
                    <td>{{ inc.participants|default:"—" }}</td>
                    <td>{{ inc.rate|default:"—" }}</td>
                    <td>{{ inc.amount }}</td>
                  </tr>
                {% endfor %}
              {% else %}
                {% if proposal.fest_fee_participants or proposal.fest_fee_rate or proposal.fest_fee_amount %}
                  <tr>
                    <td>1</td>
                    <td>Participation Fee [Fest]</td>
                    <td>{{ proposal.fest_fee_participants|default:"—" }}</td>
                    <td>{{ proposal.fest_fee_rate|default:"—" }}</td>
                    <td>{{ proposal.fest_fee_amount|default:"—" }}</td>
                  </tr>
                  <tr>
                    <td>2</td>
                    <td>Sponsorship [Fest]</td>
                    <td>—</td><td>—</td>
                    <td>{{ proposal.fest_sponsorship_amount|default:"—" }}</td>
                  </tr>
                {% endif %}
                {% if proposal.conf_fee_participants or proposal.conf_fee_rate or proposal.conf_fee_amount %}
                  <tr>
                    <td>3</td>
                    <td>Participation Fee [Conference]</td>
                    <td>{{ proposal.conf_fee_participants|default:"—" }}</td>
                    <td>{{ proposal.conf_fee_rate|default:"—" }}</td>
                    <td>{{ proposal.conf_fee_amount|default:"—" }}</td>
                  </tr>
                  <tr>
                    <td>4</td>
                    <td>Sponsorship [Conference]</td>
                    <td>—</td><td>—</td>
                    <td>{{ proposal.conf_sponsorship_amount|default:"—" }}</td>
                  </tr>
                {% endif %}
                {% if not (proposal.fest_fee_participants or proposal.fest_fee_rate or proposal.fest_fee_amount or proposal.fest_sponsorship_amount or proposal.conf_fee_participants or proposal.conf_fee_rate or proposal.conf_fee_amount or proposal.conf_sponsorship_amount) %}
                  <tr>
                    <td colspan="5">—</td>
                  </tr>
                {% endif %}
              {% endif %}
            </tbody>
          </table>
        </div>
        <div class="fin-half">
          <h3>Expenses</h3>
          <table class="finance-table">
            <thead>
              <tr>
                <th>Sl.No</th>
                <th>Particulars</th>
                <th>Amount</th>
              </tr>
            </thead>
            <tbody>
              {% for exp in expenses %}
                <tr>
                  <td>{{ exp.sl_no }}</td>
                  <td>{{ exp.particulars }}</td>
                  <td>{{ exp.amount }}</td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="3">—</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="event-details-card approval-card">
      <h3>Approval History</h3>
      <div class="approval-history-ul">
        <ul>
          {% for hist in history_steps %}
            <li>
              <span class="history-role">{{ hist.get_role_required_display }}</span>
              <span class="history-person">{{ hist.assigned_to.get_full_name }}</span>
              <span class="history-status {{ hist.status }}">
                {{ hist.get_status_display }}
              </span>
              {% if hist.comment %}
                <span class="history-comment">({{ hist.comment }})</span>
              {% endif %}
              {% if hist.updated_at %}
                <span class="history-date">[{{ hist.updated_at|date:"d M Y, H:i" }}]</span>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <div class="event-details-card review-form-card">
      {% if step.status == 'pending' %}
        <form method="post" class="review-form-ultra" aria-label="Approval actions">
          {% csrf_token %}
          <div class="form-group">
            <label>Comment / Remarks: <small class="text-muted">(required when rejecting)</small></label>
            <textarea name="comment" class="form-control"></textarea>
          </div>
          {% if show_optional_picker %}
          <div class="card">
            <label class="h2">Forward to optional approver(s)?</label>
            <label class="checkbox">
              <input type="checkbox" name="forward_to_optionals" value="1" id="forwardBox"
                     onchange="document.getElementById('optionalBlock').style.display=this.checked?'block':'none'">
              Yes, forward
            </label>
            <div id="optionalBlock" style="display:none; margin-top:8px;">
              <p>Select optional approver(s):</p>
              {% for s in optional_candidates %}
                <label class="checkbox">
                  <input type="checkbox" name="optional_step_ids" value="{{ s.id }}">
                  {{ s.assigned_to.get_full_name|default:s.assigned_to.username }}
                </label>
              {% endfor %}
            </div>
          </div>
          {% endif %}
          <div class="review-actions">
            <button type="submit" name="action" value="approve" class="btn-ultra btn-success-ultra" aria-label="Approve">
              <i class="fas fa-check"></i> Approve
            </button>
            <button type="submit" name="action" value="reject" class="btn-ultra btn-danger-ultra" aria-label="Reject">
              <i class="fas fa-times"></i> Reject
            </button>
          </div>
        </form>
      {% else %}
        <div class="info-glass status-complete">
          This step is <strong>{{ step.get_status_display }}</strong>.
        </div>
      {% endif %}
    </div>

  </main>
</div>
<script src="{% static 'emt/js/review_approval_step.js' %}"></script>
{% endblock %}

