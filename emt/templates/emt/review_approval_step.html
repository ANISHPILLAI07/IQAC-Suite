{% extends "base.html" %}
{% load static %}

{% block title %}Review Proposal{% endblock %}

{% block content %}
<div class="container">
  <h1>Review Proposal</h1>

  <div class="proposal-info mb-4">
    <h3>{{ step.proposal.event_title }}</h3>
    <p><strong>Submitted by:</strong> {{ step.proposal.submitted_by.get_full_name }}</p>
    <p><strong>Type:</strong> {{ step.proposal.get_org_type_display }}</p>
    <p><strong>Description:</strong> {{ step.proposal.description|linebreaks }}</p>
    {% if step.proposal.finance_required %}
      <span class="badge badge-warning">Finance Required</span>
    {% endif %}
  </div>

  <div class="approval-history mb-4">
    <h4>Approval History</h4>
    <ul>
      {% for hist in step.proposal.approval_steps.all|dictsort:"step_order" %}
        <li>
          <strong>{{ hist.get_role_required_display }}</strong> -
          {{ hist.assigned_to.get_full_name }}:
          <span class="{{ hist.status }}">
            {{ hist.get_status_display }}
          </span>
          {% if hist.comment %}
            <em>({{ hist.comment }})</em>
          {% endif %}
          {% if hist.updated_at %}
            <span class="text-muted">[{{ hist.updated_at|date:"d M Y, H:i" }}]</span>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  </div>

  {% if step.status == 'pending' %}
    <form method="post" class="review-form">
      {% csrf_token %}
      <div class="form-group">
        <label>Comment:</label>
        <textarea name="comment" class="form-control"></textarea>
      </div>

      {# Gatekeeper logic: HOD, uni_iqac, university_club_head, center_head, cell_head #}
      {% if step.role_required in GATEKEEPER_ROLES %}
        <div class="form-group">
          <label>
            <input type="checkbox" name="needs_academic_coord_approval"> Escalate to Academic Coordinator
          </label><br>
          <label>
            <input type="checkbox" name="needs_dean_approval"> Escalate to Dean
          </label>
        </div>
      {% endif %}

      {# Academic Coordinator logic #}
      {% if step.role_required == "academic_coordinator" %}
        <div class="form-group">
          <label>
            <input type="checkbox" name="needs_dean_approval"> Escalate to Dean
          </label>
        </div>
      {% endif %}

      <button type="submit" name="action" value="approve" class="btn btn-success">Approve</button>
      <button type="submit" name="action" value="reject" class="btn btn-danger">Reject</button>
    </form>
  {% else %}
    <p>This step is <strong>{{ step.get_status_display }}</strong>.</p>
  {% endif %}
</div>
{% endblock %}
