{% extends "base.html" %}
{% load static %}

{% block title %}Review Proposal{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'emt/css/proposal_status_detail.css' %}">
<link rel="stylesheet" href="{% static 'emt/css/review_proposal.css' %}">

<div class="detail-container review-grid">
  <!-- LEFT COLUMN: Event Info Card -->
  <aside class="timeline-column review-side">
    <div class="info-card event-details-card">
      <h2>Event Information</h2>
      <table>
        <tr><th>Organization</th><td>{{ proposal.organization.name|default:"—" }}</td></tr>
        <tr>
          <th>Committees &amp; Collaborations</th>
          <td>
            {% if proposal.committees_collaborations %}
              {{ proposal.committees_collaborations }}
            {% elif proposal.committees %}
              {{ proposal.committees }}
            {% else %}
              —
            {% endif %}
          </td>
        </tr>
        <tr><th>Event Title</th><td>{{ proposal.event_title }}</td></tr>
        <tr><th>No. of Activities</th><td>{{ proposal.num_activities|default:"—" }}</td></tr>
        <tr>
          <th>Start Date</th>
          <td>
            {% if proposal.event_start_date %}
              {{ proposal.event_start_date|date:"d M Y" }}
            {% elif proposal.event_datetime %}
              {{ proposal.event_datetime|date:"d M Y" }}
            {% else %}
              —
            {% endif %}
          </td>
        </tr>
        <tr>
          <th>End Date</th>
          <td>
            {% if proposal.event_end_date %}
              {{ proposal.event_end_date|date:"d M Y" }}
            {% elif proposal.event_datetime %}
              {{ proposal.event_datetime|date:"d M Y" }}
            {% else %}
              —
            {% endif %}
          </td>
        </tr>
        <tr><th>Venue</th><td>{{ proposal.venue|default:"—" }}</td></tr>
        <tr><th>Academic Year</th><td>{{ proposal.academic_year|default:"—" }}</td></tr>
        <tr><th>Target Audience</th><td>{{ proposal.target_audience|default:"—" }}</td></tr>
        <tr><th>POS &amp; PSO</th><td>{{ proposal.pos_pso|default:"—" }}</td></tr>
        <tr>
          <th>SDG Goals</th>
          <td>
            {% with goals=proposal.sdg_goals.all %}
              {% if goals %}
                {% for goal in goals %}
                  {{ goal.name }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
              {% else %}
                —
              {% endif %}
            {% endwith %}
          </td>
        </tr>
        <tr>
          <th>Faculty Incharges</th>
          <td>
            {% with facs=proposal.faculty_incharges.all %}
              {% if facs %}
                {% for fac in facs %}
                  {{ fac.get_full_name|default:fac.username }} ({{ fac.email }}){% if not forloop.last %}, {% endif %}
                {% endfor %}
              {% else %}
                —
              {% endif %}
            {% endwith %}
          </td>
        </tr>
        <tr><th>Student Coordinators</th><td>{{ proposal.student_coordinators|default:"—" }}</td></tr>
        <tr><th>Type (Focus)</th><td>{{ proposal.event_focus_type|default:"—" }}</td></tr>
      </table>
    </div>
  </aside>

  <!-- RIGHT COLUMN: Proposal Details -->
  <main class="details-column review-main">
    <header class="review-header overview-card">
      <div class="review-heading">
        <h1 class="review-title">Review Proposal</h1>
        <span class="meta">{{ proposal.event_title }}</span>
      </div>
      <div class="review-actions">
        <a href="{% url 'emt:submit_proposal_with_pk' proposal.id %}" class="btn-save-section">Edit</a>
        <form method="post" style="display:inline;">
          {% csrf_token %}
          <button type="submit" name="final_submit" class="btn-submit">Confirm Submit</button>
        </form>
      </div>
    </header>
    {% url 'emt:submit_need_analysis' proposal.id as need_edit %}
    {% url 'emt:submit_objectives' proposal.id as obj_edit %}
    {% url 'emt:submit_expected_outcomes' proposal.id as out_edit %}
    {% url 'emt:submit_tentative_flow' proposal.id as flow_edit %}
    {% url 'emt:submit_speaker_profile' proposal.id as speaker_edit %}
    {% url 'emt:submit_expense_details' proposal.id as expense_edit %}
    {% url 'emt:submit_cdl_support' proposal.id as cdl_edit %}

    {% include "emt/partials/review_section.html" with title="Need Analysis" body=need_analysis.content edit_url=need_edit %}
    {% include "emt/partials/review_section.html" with title="Objectives" body=objectives.content edit_url=obj_edit %}
    {% include "emt/partials/review_section.html" with title="Expected Outcomes" body=outcomes.content edit_url=out_edit %}
    {% include "emt/partials/review_section.html" with title="Tentative Flow" body=flow.content edit_url=flow_edit %}

    <div class="event-details-card">
      <div class="review-section-header">
        <h3>Speaker Profile</h3>
        <a href="{{ speaker_edit }}" class="section-edit-link">Edit</a>
      </div>
      {% if speakers %}
        <ul class="speaker-profile-list">
          {% for sp in speakers %}
            <li>
              <strong>{{ sp.full_name }}</strong>{% if sp.designation %} - {{ sp.designation }}{% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="detail-block">—</div>
      {% endif %}
    </div>

    <div class="event-details-card">
      <div class="review-section-header">
        <h3>Expense Details</h3>
        <a href="{{ expense_edit }}" class="section-edit-link">Edit</a>
      </div>
      {% if expenses %}
        <table class="review-table">
          <thead>
            <tr><th>Sl. No.</th><th>Particulars</th><th>Amount</th></tr>
          </thead>
          <tbody>
          {% for e in expenses %}
            <tr>
              <td>{{ e.sl_no }}</td>
              <td>{{ e.particulars }}</td>
              <td>{{ e.amount }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="detail-block">—</div>
      {% endif %}
    </div>

    <div class="event-details-card">
      <div class="review-section-header">
        <h3>Income Details</h3>
        <a href="{{ expense_edit }}" class="section-edit-link">Edit</a>
      </div>
      {% if income %}
        <table class="review-table">
          <tr><th>Sl. No.</th><th>Particulars</th><th>Participants</th><th>Rate</th><th>Amount</th></tr>
          {% for i in income %}
            <tr><td>{{ i.sl_no }}</td><td>{{ i.particulars }}</td><td>{{ i.participants }}</td><td>{{ i.rate }}</td><td>{{ i.amount }}</td></tr>
          {% endfor %}
        </table>
      {% else %}
        <div class="detail-block">—</div>
      {% endif %}
    </div>

    {% if cdl_support %}
    <div class="event-details-card">
      <div class="review-section-header">
        <h3>CDL Support</h3>
        <a href="{{ cdl_edit }}" class="section-edit-link">Edit</a>
      </div>
      <table class="review-table">
        <tr><th>Needs Support</th><td>{{ cdl_support.needs_support|yesno:"Yes,No" }}</td></tr>
        {% if cdl_support.poster_required %}
        <tr><th>Poster</th><td>{{ cdl_support.get_poster_choice_display }}</td></tr>
        {% if cdl_support.organization_name %}<tr><th>Organization</th><td>{{ cdl_support.organization_name }}</td></tr>{% endif %}
        {% if cdl_support.poster_event_title %}<tr><th>Poster Title</th><td>{{ cdl_support.poster_event_title }}</td></tr>{% endif %}
        {% if cdl_support.poster_date %}<tr><th>Poster Date</th><td>{{ cdl_support.poster_date }}</td></tr>{% endif %}
        {% if cdl_support.poster_time %}<tr><th>Poster Time</th><td>{{ cdl_support.poster_time }}</td></tr>{% endif %}
        {% if cdl_support.poster_venue %}<tr><th>Poster Venue</th><td>{{ cdl_support.poster_venue }}</td></tr>{% endif %}
        {% if cdl_support.resource_person_name %}
        <tr><th>Resource Person</th><td>{{ cdl_support.resource_person_name }}{% if cdl_support.resource_person_designation %} ({{ cdl_support.resource_person_designation }}){% endif %}</td></tr>
        {% endif %}
        {% if cdl_support.poster_summary %}<tr><th>Poster Summary</th><td>{{ cdl_support.poster_summary|linebreaksbr }}</td></tr>{% endif %}
        {% if cdl_support.poster_design_link %}<tr><th>Poster Design Link</th><td><a href="{{ cdl_support.poster_design_link }}">{{ cdl_support.poster_design_link }}</a></td></tr>{% endif %}
        {% endif %}
        {% if cdl_support.certificates_required %}
        <tr><th>Certificates</th><td>{{ cdl_support.get_certificate_choice_display }}</td></tr>
        {% if cdl_support.certificate_help %}<tr><th>Certificate Help</th><td>Yes</td></tr>{% endif %}
        {% if cdl_support.certificate_design_link %}<tr><th>Certificate Design Link</th><td><a href="{{ cdl_support.certificate_design_link }}">{{ cdl_support.certificate_design_link }}</a></td></tr>{% endif %}
        {% endif %}
        {% if cdl_support.other_services %}
        <tr><th>Other Services</th><td>{{ cdl_support.other_services|join:", " }}</td></tr>
        {% endif %}
        {% if cdl_support.blog_content %}
        <tr><th>Blog Content</th><td>{{ cdl_support.blog_content|linebreaksbr }}</td></tr>
        {% endif %}
      </table>
    </div>
    {% endif %}
  </main>
</div>
{% endblock %}
