{% extends "base.html" %}
{% load static %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'emt/css/styles.css' %}">
<link rel="stylesheet" href="{% static 'emt/css/ai_report_progress.css' %}">
{% endblock %}

{% block content %}
<div class="ai-layout">
  <main class="proposal-content">
    <section class="section-card" style="margin-top: .75rem;">
      <div class="section-header">
        <div>
          <div class="section-title">Internal Quality Assurance Cell (IQAC) â€” Event Report</div>
          <div class="ai-subtitle">AI is generating your report in real time...</div>
        </div>
      </div>
      <div class="divider"></div>

      <div class="section-title" style="font-size:1rem; margin-bottom:.5rem;">1. Event Information</div>
      <table class="ai-table">
        <tr><th>Event Title</th><td id="f_event_title" class="ai-field-blank">...</td></tr>
        <tr><th>Date &amp; Time</th><td id="f_date_time" class="ai-field-blank">...</td></tr>
        <tr><th>Venue</th><td id="f_venue" class="ai-field-blank">...</td></tr>
        <tr><th>Academic Year</th><td id="f_academic_year" class="ai-field-blank">...</td></tr>
        <tr><th>Focus / Objective</th><td id="f_focus_objective" class="ai-field-blank">...</td></tr>
        <tr><th>Target Audience</th><td id="f_target_audience" class="ai-field-blank">...</td></tr>
        <tr><th>Organization</th><td id="f_organizing_dept" class="ai-field-blank">...</td></tr>
        <tr><th>No. of Participants</th><td id="f_no_participants" class="ai-field-blank">...</td></tr>
      </table>

      <div class="section-title" style="font-size:1rem; margin:1rem 0 .5rem;">2. Event Summary</div>
      <div id="f_summary" class="ai-field-blank" style="margin-bottom:12px;">...</div>

      <div class="section-title" style="font-size:1rem; margin:1rem 0 .5rem;">3. Outcomes</div>
      <div id="f_outcomes" class="ai-field-blank" style="margin-bottom:12px;">...</div>

      <div class="section-title" style="font-size:1rem; margin:1rem 0 .5rem;">4. Feedback &amp; Suggestions</div>
      <div id="f_feedback" class="ai-field-blank" style="margin-bottom:12px;">...</div>

      <div class="section-title" style="font-size:1rem; margin:1rem 0 .5rem;">5. Recommendations</div>
      <div id="f_recommendations" class="ai-field-blank" style="margin-bottom:12px;">...</div>

      <div class="section-title" style="font-size:1rem; margin:1rem 0 .5rem;">6. Attachments</div>
      <div id="f_attachments" class="ai-field-blank" style="margin-bottom:12px;">...</div>

      <div class="actions-bar">
        <button type="button" class="btn-secondary" id="editBtn">Edit Report</button>
        <button type="button" class="btn-primary" id="submitBtn">Submit</button>
      </div>
      <div id="ai_status" class="ai-field-blank" hidden>AI has filled your report!</div>
    </section>
  </main>
</div>

<script>
// 1. Field mapping (AI label to DOM element ID, lowercased)
const aiFieldMap = {
  'event title': 'f_event_title',
  'date & time': 'f_date_time',
  'venue': 'f_venue',
  'academic year': 'f_academic_year',
  'focus/objective': 'f_focus_objective',
  'focus / objective': 'f_focus_objective',
  'target audience': 'f_target_audience',
  'organizing department': 'f_organizing_dept',
  'organizing department/committee': 'f_organizing_dept',
  'no. of participants': 'f_no_participants',
  'number of participants': 'f_no_participants',
  'event summary': 'f_summary',
  'summary': 'f_summary',
  'outcomes': 'f_outcomes',
  'feedback': 'f_feedback',
  'feedback & suggestions': 'f_feedback',
  'recommendations': 'f_recommendations',
  'attachments': 'f_attachments',
  'prepared by': 'f_prepared_by',
  'date of submission': 'f_date_sub',
  'approved by': 'f_approved_by',
};

// 2. Typing animation for a field
function animateFieldFill(id, text) {
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.remove('ai-field-blank');
  el.classList.add('ai-fill-anim');
  // Typing effect
  let i = 0;
  function type() {
    if (i <= text.length) {
      el.innerHTML = text.slice(0, i) + '<span class="ai-cursor">|</span>';
      i++;
      setTimeout(type, 9 + Math.random() * 22);
    } else {
      el.innerHTML = text;
      el.classList.remove('ai-fill-anim');
    }
  }
  type();
}

// 3. Parse "Field: Value" lines (robust, trims, ignores case, ignores blank lines)
function parseReportFields(reportText) {
    // Remove markdown stars, underscores, etc. and trim
    let txt = reportText.replace(/[*_]+/g, '').replace(/\r/g, '');
    // For debug: see raw AI
    console.log("RAW AI:\n" + txt);
    let fields = {};
    let lines = txt.split('\n');
    for (let i = 0; i < lines.length; ++i) {
      let line = lines[i].trim();
      if (!line) continue;
      let idx = line.indexOf(':');
      if (idx > 0) {
        let key = line.slice(0, idx).trim().toLowerCase();
        let val = line.slice(idx + 1).trim();
        if (key && val !== undefined) fields[key] = val;
      }
    }
    return fields;
}

// 4. Streaming fetch logic (Gemini or simulate for dev)
fetch("{% url 'emt:generate_ai_report_stream' proposal.id %}", { method: "GET" })
  .then(response => {
    const reader = response.body.getReader();
    let buffer = '';
    function pump() {
      return reader.read().then(({ value, done }) => {
        if (done) {
          // Final fill for any remaining blanks
          const fields = parseReportFields(buffer);
          Object.entries(aiFieldMap).forEach(([k, v]) => {
            if (fields[k] && document.getElementById(v).textContent === '...') {
              animateFieldFill(v, fields[k]);
            }
          });
          document.getElementById('ai_status').hidden = false;
          document.getElementById('editBtn').style.display = "inline-block";
          return;
        }
        buffer += new TextDecoder("utf-8").decode(value);
        // Live update
        const fields = parseReportFields(buffer);
        Object.entries(aiFieldMap).forEach(([k, v]) => {
          if (fields[k] && (document.getElementById(v).textContent === '...' || document.getElementById(v).classList.contains('ai-field-blank'))) {
            animateFieldFill(v, fields[k]);
          }
        });
        return pump();
      });
    }
    return pump();
  })
  .catch(err => {
    // If Gemini/stream fails, show an error
    alert("AI report generation failed! Please try again.\n" + (err && err.message ? err.message : ""));
  });

document.getElementById('editBtn').onclick = function() {
  window.location.href = "{% url 'emt:ai_report_edit' proposal.id %}";
};
document.getElementById('submitBtn').onclick = function() {
  window.location.href = "{% url 'emt:ai_report_submit' proposal.id %}";
};
</script>
{% endblock %}
