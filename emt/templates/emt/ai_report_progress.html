{% extends "base.html" %}
{% load static %}

{% block title %}IQAC Event Report Preview{% endblock %}

{% block head_extra %}
<style>
  /* ===== Paper constants ===== */
  :root { --ink:#000; --grid:#000; --hair:0.6pt; --pad:8px; }
  * { box-sizing: border-box; }
  body { background:#f3f4f6; }

  /* A4 canvas */
  .wrap { width:210mm; margin:24px auto 60px; }
  @page { size: A4 portrait; margin:20mm 18mm 22mm; }

  .sheet{
    background:#fff; color:var(--ink);
    font-family:"Times New Roman", Times, serif;
    font-size:12pt; line-height:1.45;
    counter-reset: page;
    box-shadow:0 6px 20px rgba(0,0,0,.12);
  }

  /* Header (paper) */
  .hdr{ text-align:center; padding:22mm 18mm 8mm; border-bottom:var(--hair) solid var(--grid); }
  .u{ text-transform:uppercase; letter-spacing:.06em; }
  .hdr .univ{ font-weight:700; font-size:15pt; margin-bottom:2mm; }
  .hdr .campus{ font-style:italic; font-size:11.5pt; margin-bottom:2mm; }
  .hdr .iqac{ font-size:11pt; margin-bottom:4mm; }
  .hdr .title{ font-weight:700; font-size:16pt; margin-top:6mm; }
  .hdr .subtitle{ font-weight:600; letter-spacing:.18em; margin-top:2mm; }

  /* Body */
  .body{ padding:10mm 18mm 12mm; }
  .sec{ font-weight:700; text-transform:uppercase; letter-spacing:.08em; font-size:12.5pt; margin:6mm 0 2mm; }

  /* Pair table (label/value | label/value) */
  table.grid{ width:100%; border-collapse:collapse; table-layout:fixed; }
  /* exact column widths ensure perfect vertical alignment across rows */
  table.grid col.c-lab { width:27%; }
  table.grid col.c-val { width:23%; }

  table.grid th, table.grid td{ border:var(--hair) solid var(--grid); padding:var(--pad) 9px; vertical-align:top; }
  table.grid th{ background:#fff; font-weight:700; text-transform:uppercase; font-size:10.5pt; }

  /* Full-width two-row grid */
  .full col.c-lab{ width:35%; } .full col.c-val{ width:65%; }

  /* Lists/paragraphs inside cells – normalize spacing */
  .cell-ul{ margin:0; padding-left:18px; }
  .cell-ul li{ margin:2px 0; }
  .cell-para{ margin:0; white-space:pre-wrap; text-align:justify; text-justify:inter-word; }

  /* Boxed narrative areas (like the sample) */
  .para-box{
    border:var(--hair) solid var(--grid); padding:10px 12px;
    min-height:28mm; text-align:justify; text-justify:inter-word;
  }
  .pane{ border:var(--hair) solid var(--grid); padding:8px 12px; }

  .analysis-box{ min-height:35mm; }
  .analysis-box .cell-ul{ padding-left:16px; }
  .analysis-box .cell-ul li{ margin:3px 0; }
  .lbl{ font-weight:700; text-transform:uppercase; letter-spacing:.06em; font-size:10.5pt; margin-bottom:3px; }

  /* Signatures */
  .signs{ display:flex; gap:18mm; margin-top:10mm; }
  .sign{ flex:1; text-align:center; }
  .line{ height:0; border-top:var(--hair) solid var(--grid); margin:20mm 0 2mm; }
  .cap{ font-size:10pt; text-transform:uppercase; letter-spacing:.06em; }

  /* Annexures */
  .break{ break-before:page; }
  .ann{ font-weight:700; text-transform:uppercase; letter-spacing:.08em; margin:2mm 0 2mm; }
  .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:6mm; }
  .annexure-grid{ margin-bottom:6mm; }
  figure.card{ border:var(--hair) solid var(--grid); background:#fff; }
  figure.card.single-asset{ width:100%; }
  figure.card img{ width:100%; height:100%; object-fit:contain; }
  .ph{ height:52mm; background:#f2f2f2; display:flex; align-items:center; justify-content:center; font-size:10pt; color:#555; text-align:center; padding:6px; }
  figcaption{ border-top:var(--hair) solid var(--grid); padding:6px 8px; font-size:10.5pt; }
  figure.card.needs-extract .ph{ background:#f8f2e0; color:#7a5d00; font-style:italic; }
  .extract-note{ border-top:var(--hair) solid var(--grid); padding:4px 8px; font-size:10pt; font-style:italic; background:#fafafa; }

  /* Footer – show numbers only in print (avoid Page 0 of 0 on screen) */
  .ftr{ padding:6mm 18mm 10mm; border-top:var(--hair) solid var(--grid); font-size:10pt; display:flex; justify-content:space-between; }
  .pg{ visibility:hidden; }
  @media print {
    body{ background:#fff; }
    .wrap{ width:auto; margin:0; }
    .sheet{ box-shadow:none; }
    .ctrl{ display:none !important; }
    .pg{ visibility:visible; }
    .pg::after{ content:"Page " counter(page) " of " counter(pages); }
  }

  /* Screen controls */
  .ctrl{ position:sticky; top:14px; width:210mm; margin:10px auto; display:flex; gap:10px; justify-content:flex-end; z-index:2; }
  .btn{ border:1px solid #111; background:#fff; padding:6px 14px; font-family:inherit; font-size:12px; cursor:pointer; }
  .btn.p{ background:#111; color:#fff; }
</style>
{% endblock %}

{% block content %}
<div class="ctrl">
  <button id="toggle-edit" class="btn">Edit</button>
  <button id="print-btn" class="btn p">Print / Save PDF</button>
</div>

<div class="wrap">
  <article class="sheet">
    <!-- HEADER -->
    <header class="hdr">
      <div class="univ u">CHRIST (DEEMED TO BE UNIVERSITY)</div>
      <div class="campus">Pune Lavasa Campus – “The Hub of Analytics”</div>
      <div class="iqac u">Internal Quality Assurance Cell (IQAC)</div>
      <div class="title u" data-field="event_info.title">{{ proposal.event_title|default:"—" }}</div>
      <div class="subtitle u">Activity Report</div>
    </header>

    <div class="body">
      <!-- 1. EVENT INFORMATION -->
      <h2 class="sec">Event Information</h2>
      <table class="grid">
        <colgroup>
          <col class="c-lab"><col class="c-val"><col class="c-lab"><col class="c-val">
        </colgroup>
        <tbody>
          <tr>
            <th>Department</th><td data-field="event_info.department">—</td>
            <th>Location</th><td data-field="event_info.location">—</td>
          </tr>
          <tr>
            <th>Event Title</th><td data-field="event_info.title">—</td>
            <th>No. of Activities</th><td data-field="event_info.activities_count">—</td>
          </tr>
          <tr>
            <th>Date &amp; Time</th><td data-field="event_info.datetime">—</td>
            <th>Venue</th><td data-field="event_info.venue">—</td>
          </tr>
          <tr>
            <th>Academic Year</th><td data-field="event_info.academic_year">—</td>
            <th>Event Type (Focus)</th><td data-field="event_info.focus">—</td>
          </tr>
        </tbody>
      </table>

      <!-- 2. PARTICIPANTS -->
      <h2 class="sec">Participants Information</h2>
      <table class="grid">
        <colgroup>
          <col class="c-lab"><col class="c-val"><col class="c-lab"><col class="c-val">
        </colgroup>
        <tbody>
          <tr>
            <th>Target Audience</th><td data-field="participants.target_audience">—</td>
            <th>External Agencies / Speakers / Guests</th><td data-field="participants.external_agencies">—</td>
          </tr>
          <tr>
            <th>Website / Contact of External Members</th><td data-field="participants.external_contacts">—</td>
            <th>Organising Committee</th>
            <td>
              <ul class="cell-ul" data-list="participants.organising_committee"><li>—</li></ul>
            </td>
          </tr>
          <tr>
            <th>No. of Student Volunteers</th><td data-field="participants.student_volunteers">—</td>
            <th>No. of Attendees / Participants</th><td data-field="participants.participants_count">—</td>
          </tr>
        </tbody>
      </table>

      <!-- 3. SUMMARY -->
      <h2 class="sec">Summary of the Overall Event</h2>
      <div class="para-box" data-field="summary" data-multiline="true">—</div>

      <div style="height:4mm"></div>
      <div class="lbl">Activities</div>
      <div class="pane">
        <ul class="cell-ul" data-list="activities"><li>—</li></ul>
      </div>

      <!-- 4. OUTCOMES -->
      <h2 class="sec">Outcomes of the Event</h2>
      <div class="pane">
        <ul class="cell-ul" data-list="outcomes"><li>—</li></ul>
      </div>

      <!-- 5. ANALYSIS -->
      <h2 class="sec">Analysis</h2>
      <div class="pane analysis-box">
        <ul class="cell-ul" data-list="analysis.points"><li>—</li></ul>
      </div>

      <!-- 6. RELEVANCE -->
      <h2 class="sec">Relevance of the Event</h2>
      <table class="grid full relevance-grid">
        <colgroup>
          <col class="c-lab"><col class="c-val">
        </colgroup>
        <tbody>
          <tr>
            <th>Institutional Alignment</th>
            <td><p class="cell-para" data-field="relevance.institutional_alignment" data-multiline="true">—</p></td>
          </tr>
          <tr>
            <th>Graduate Attributes &amp; SDGs</th>
            <td><p class="cell-para" data-field="relevance.graduate_attributes" data-multiline="true">—</p></td>
          </tr>
        </tbody>
      </table>

      <!-- 8. SUGGESTIONS -->
      <h2 class="sec">Suggestions for Improvement / Feedback from IQAC</h2>
      <div class="pane"><ul class="cell-ul" data-list="suggestions"><li>—</li></ul></div>
      <div style="margin-top:5mm;">Date: <span data-field="suggestions_date">—</span></div>

      <div class="signs">
        <div class="sign"><div class="line"></div><div class="cap">Head / Coordinator</div></div>
        <div class="sign"><div class="line"></div><div class="cap">Faculty Coordinator / Organiser</div></div>
        <div class="sign"><div class="line"></div><div class="cap">IQAC</div></div>
      </div>

      <!-- 9. ANNEXURES -->
      <div class="break"></div>
      <h2 class="sec">Attachments (Annexures)</h2>

      <div class="ann">Annexure A. Photographs</div>
      <div class="grid-2 annexure-grid" data-grid="annexures.photos">
        <figure class="card"><div class="ph">Awaiting attachment</div><figcaption>—</figcaption></figure>
      </div>

      <div class="break"></div>
      <div class="ann">Annexure B. Brochure Pages</div>
      <div class="grid-2 annexure-grid" data-grid="annexures.brochure_pages">
        <figure class="card"><div class="ph">Awaiting attachment</div><figcaption>—</figcaption></figure>
      </div>

      <div class="break"></div>
      <div class="ann">Annexure C. Communication</div>
      <div class="grid-2 annexure-grid" data-grid="annexures.communication.files">
        <figure class="card"><div class="ph">Awaiting attachment</div><figcaption>—</figcaption></figure>
      </div>

      <div class="break"></div>
      <div class="ann">Annexure D. Worksheets / Activities</div>
      <div class="grid-2 annexure-grid" data-grid="annexures.worksheets">
        <figure class="card"><div class="ph">Awaiting attachment</div><figcaption>—</figcaption></figure>
      </div>

      <div class="break"></div>
      <div class="ann">Annexure E. Evaluation Sheet</div>
      <figure class="card single-asset" data-single="annexures.evaluation_sheet"><div class="ph">Awaiting attachment</div><figcaption>—</figcaption></figure>

      <div class="break"></div>
      <div class="ann">Annexure F. Feedback Form</div>
      <figure class="card single-asset" data-single="annexures.feedback_form"><div class="ph">Awaiting attachment</div><figcaption>—</figcaption></figure>

    </div>

    <footer class="ftr">
      <div>CHRIST (Deemed to be University), Pune Lavasa Campus — 30 Valor Court, Pune 412112, Maharashtra</div>
      <div class="pg"></div>
    </footer>
  </article>
</div>

<script type="application/json" id="initial-report-data">{{ initial_report_data|default:"{}"|safe }}</script>

<script>
  /* ---------- Hydration ---------- */
  function hydrateReport(data = {}) {
    const root = document.querySelector('.sheet'); if (!root) return;
    const txt = (sel, v) => {
      const el = root.querySelector(sel);
      if (el) {
        const value = (v ?? '—') === '' ? '—' : v;
        el.textContent = value === undefined ? '—' : value;
      }
    };
    const list = (sel, arr) => {
      const ul = root.querySelector(sel);
      if (!ul) return;
      const items = Array.isArray(arr) ? arr.filter(x => x !== undefined && x !== null && String(x).trim() !== '') : [];
      ul.innerHTML = '';
      (items.length ? items : ['—']).forEach(x => {
        const li = document.createElement('li');
        li.textContent = x;
        ul.appendChild(li);
      });
    };

    const AWAITING = 'Awaiting attachment';

    const makeFigure = () => {
      const figure = document.createElement('figure');
      figure.className = 'card';
      const ph = document.createElement('div');
      ph.className = 'ph';
      ph.textContent = AWAITING;
      const cap = document.createElement('figcaption');
      cap.textContent = '—';
      figure.appendChild(ph);
      figure.appendChild(cap);
      return figure;
    };

    const renderAsset = (figure, item) => {
      if (!figure) return;
      const ph = figure.querySelector('.ph');
      const cap = figure.querySelector('figcaption');
      figure.classList.remove('needs-extract');
      figure.querySelectorAll('.extract-note').forEach(note => note.remove());

      const hasItem = item && (item.src || item.file || item.caption || item.requires_extraction);
      if (!hasItem) {
        if (ph) {
          ph.innerHTML = '';
          ph.textContent = AWAITING;
        }
        if (cap) cap.textContent = '—';
        return;
      }

      const src = item.src || item.file || '';
      if (ph) {
        ph.innerHTML = '';
        if (src) {
          const img = document.createElement('img');
          img.src = src;
          img.alt = item.caption || 'Attachment image';
          img.style.maxWidth = '100%';
          img.style.maxHeight = '100%';
          ph.appendChild(img);
        } else {
          ph.textContent = item.requires_extraction ? 'Images will be extracted' : AWAITING;
        }
      }
      if (cap) {
        cap.textContent = item.caption && item.caption.trim() ? item.caption : '—';
      }
      if (item.requires_extraction) {
        figure.classList.add('needs-extract');
        const note = document.createElement('div');
        note.className = 'extract-note';
        note.textContent = 'Images will be extracted from this file.';
        figure.appendChild(note);
      }
    };

    const grid = (sel, items) => {
      const wrap = root.querySelector(sel);
      if (!wrap) return;
      wrap.innerHTML = '';
      const listItems = Array.isArray(items) ? items : [];
      if (!listItems.length) {
        const fallback = makeFigure();
        renderAsset(fallback, null);
        wrap.appendChild(fallback);
        return;
      }
      listItems.forEach(entry => {
        const fig = makeFigure();
        renderAsset(fig, entry);
        wrap.appendChild(fig);
      });
    };

    const single = (sel, item) => {
      const fig = root.querySelector(sel);
      if (!fig) return;
      renderAsset(fig, item || null);
    };

    /* Map all fields */
    txt('[data-field="event_info.title"]', data?.event_info?.title);
    txt('[data-field="event_info.department"]', data?.event_info?.department);
    txt('[data-field="event_info.location"]', data?.event_info?.location);
    txt('[data-field="event_info.activities_count"]', data?.event_info?.activities_count);
    txt('[data-field="event_info.datetime"]', data?.event_info?.datetime);
    txt('[data-field="event_info.venue"]', data?.event_info?.venue);
    txt('[data-field="event_info.academic_year"]', data?.event_info?.academic_year);
    txt('[data-field="event_info.focus"]', data?.event_info?.focus);

    txt('[data-field="participants.target_audience"]', data?.participants?.target_audience);
    txt('[data-field="participants.external_agencies"]', data?.participants?.external_agencies);
    txt('[data-field="participants.external_contacts"]', data?.participants?.external_contacts);
    list('[data-list="participants.organising_committee"]', data?.participants?.organising_committee);
    txt('[data-field="participants.student_volunteers"]', data?.participants?.student_volunteers);
    txt('[data-field="participants.participants_count"]', data?.participants?.participants_count);

    txt('[data-field="summary"]', data?.summary);
    list('[data-list="activities"]', data?.activities);
    list('[data-list="outcomes"]', data?.outcomes);

    const analysisItems = Array.isArray(data?.analysis?.points)
      ? data.analysis.points.filter(x => x && String(x).trim() !== '')
      : [];
    const analysisFallback = data?.analysis?.text && String(data.analysis.text).trim()
      ? [data.analysis.text]
      : [];
    list('[data-list="analysis.points"]', analysisItems.length ? analysisItems : analysisFallback);

    txt('[data-field="relevance.institutional_alignment"]', data?.relevance?.institutional_alignment);
    txt('[data-field="relevance.graduate_attributes"]', data?.relevance?.graduate_attributes);

    list('[data-list="suggestions"]', data?.suggestions);
    txt('[data-field="suggestions_date"]', data?.suggestions_date);

    grid('[data-grid="annexures.photos"]', data?.annexures?.photos);
    grid('[data-grid="annexures.brochure_pages"]', data?.annexures?.brochure_pages);
    grid('[data-grid="annexures.communication.files"]', data?.annexures?.communication?.files);
    grid('[data-grid="annexures.worksheets"]', data?.annexures?.worksheets);
    single('[data-single="annexures.evaluation_sheet"]', data?.annexures?.evaluation_sheet);
    single('[data-single="annexures.feedback_form"]', data?.annexures?.feedback_form);
  }

  (function init(){
    /* hydrate from server JSON if present */
    const raw=document.getElementById('initial-report-data');
    if(raw && raw.textContent.trim()){
      try{ hydrateReport(JSON.parse(raw.textContent)); }catch(_){}
    }
    document.getElementById('print-btn')?.addEventListener('click', ()=>window.print());

    /* lightweight edit/preview (paper look preserved) */
    let editing=false;
    document.getElementById('toggle-edit')?.addEventListener('click', ()=>{
      editing=!editing; const btn=document.getElementById('toggle-edit'); btn.textContent=editing?'Preview':'Edit';

      const toInputs=()=>{
        document.querySelectorAll('[data-field]').forEach(el=>{
          if(el.querySelector('input,textarea')) return;
          const multi=el.getAttribute('data-multiline')==='true';
          const v=el.textContent.trim()==='—'?'':el.textContent.trim();
          const tag=multi?'textarea':'input'; const c=document.createElement(tag);
          c.value=v; c.style.width='100%'; c.style.border='none'; c.style.outline='none'; c.style.font='inherit'; c.style.lineHeight='inherit'; c.style.padding='0';
          if(multi) c.rows=5; el.innerHTML=''; el.appendChild(c);
        });
        document.querySelectorAll('[data-list]').forEach(ul=>{
          const vals=Array.from(ul.querySelectorAll('li')).map(li=>li.textContent.trim()).filter(Boolean);
          const ta=document.createElement('textarea'); ta.rows=4; ta.style.width='100%'; ta.style.border='none'; ta.style.outline='none'; ta.style.font='inherit';
          ta.value=vals.join('\n'); ul.innerHTML=''; ul.appendChild(ta);
        });
      };
      const toText=()=>{
        document.querySelectorAll('[data-field]').forEach(el=>{
          const c=el.querySelector('input,textarea'); if(!c) return; const v=c.value.trim(); el.innerHTML=v||'—';
        });
        document.querySelectorAll('[data-list]').forEach(ul=>{
          const ta=ul.querySelector('textarea'); if(!ta) return;
          const items=ta.value.split('\n').map(x=>x.trim()).filter(Boolean);
          ul.innerHTML=''; (items.length?items:['—']).forEach(x=>{ const li=document.createElement('li'); li.textContent=x; ul.appendChild(li); });
        });
      };

      if(editing) toInputs(); else toText();
    });
  })();
</script>
{% endblock %}
