{% extends "base.html" %}
{% load static %}

{% block title %}IQAC Event Report Preview{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'emt/css/styles.css' %}">
<style>
  :root {
    color-scheme: only light;
  }

  * {
    box-sizing: border-box;
  }

  body.command-center-layout {
    background: #f2f4f7;
    font-family: "Calibri", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
    font-size: 11pt;
    line-height: 1.5;
    counter-reset: page;
  }

  @page {
    size: A4 portrait;
    margin: 20mm;
  }

  @page {
    @top-center {
      content: element(report-header);
    }
    @bottom-center {
      content: element(report-footer);
    }
  }

  .iqac-report-page {
    padding: 24px 16px 64px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
  }

  .screen-controls {
    position: sticky;
    top: 16px;
    z-index: 60;
    display: flex;
    gap: 8px;
    align-self: flex-end;
  }

  .screen-controls .btn {
    font-size: 0.85rem;
    padding: 6px 14px;
    border-radius: 999px;
    border: 1px solid #9aa6b2;
    background: #fff;
    color: #1f2933;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 6px 16px rgba(15, 23, 42, 0.05);
  }

  .screen-controls .btn-primary {
    background: #12497c;
    color: #fff;
    border-color: #0f3a62;
  }

  .screen-controls .btn:hover,
  .screen-controls .btn:focus {
    filter: brightness(0.95);
    outline: none;
  }

  .ai-progress-banner {
    background: rgba(18, 73, 124, 0.08);
    color: #0f3a62;
    border: 1px solid rgba(18, 73, 124, 0.25);
    border-radius: 12px;
    padding: 10px 16px;
    font-size: 0.9rem;
    max-width: 720px;
    width: 100%;
    text-align: center;
  }

  .report-wrapper {
    max-width: 210mm;
    width: 100%;
  }

  .report-sheet {
    background: #fff;
    border: 1px solid #dcdcdc;
    box-shadow: 0 18px 35px rgba(15, 23, 42, 0.08);
    padding: 24mm 18mm 24mm 18mm;
    position: relative;
    overflow: hidden;
  }

  .report-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 24px;
    border-bottom: 2px solid #d3d7db;
    padding-bottom: 18px;
    margin-bottom: 24px;
    position: running(report-header);
  }

  .report-header .brand {
    display: flex;
    align-items: center;
    gap: 18px;
  }

  .logo-placeholder {
    width: 90px;
    height: 90px;
    border: 2px solid #9aa6b2;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    color: #607080;
    font-size: 0.8rem;
  }

  .report-header .institution {
    display: flex;
    flex-direction: column;
    gap: 4px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    font-size: 0.9rem;
    color: #1e3a5f;
  }

  .report-header .iqac-title {
    text-align: right;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-weight: 600;
    color: #0f3a62;
  }

  .report-body {
    display: flex;
    flex-direction: column;
    gap: 28px;
  }

  .report-section {
    page-break-inside: avoid;
  }

  .section-heading {
    margin-bottom: 12px;
  }

  .section-heading .kicker {
    display: block;
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.18em;
    font-weight: 700;
    color: #7a8795;
  }

  .section-heading h2 {
    margin: 4px 0 0 0;
    font-size: 16pt;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-weight: 700;
    color: #1e3a5f;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11pt;
  }

  .grid-table th,
  .grid-table td {
    border: 1px solid #cfd3d7;
    padding: 8px 10px;
    vertical-align: top;
  }

  .grid-table th {
    width: 17%;
    font-weight: 600;
    background: #eef2f7;
    text-transform: uppercase;
    font-size: 0.7rem;
    letter-spacing: 0.08em;
    color: #3b4a5a;
  }

  .grid-table td {
    width: 33%;
    background: #fff;
  }

  .grid-table.full-width th {
    width: 35%;
  }

  .grid-table.full-width td {
    width: 65%;
  }

  .paper-box {
    border: 1px solid #cfd3d7;
    background: #fff;
    padding: 6px 8px;
    min-height: 34px;
    border-radius: 4px;
  }

  .paper-box.bullet-list {
    list-style: disc;
    padding-left: 20px;
  }

  .paper-box.list-commas {
    list-style: none;
    padding-left: 12px;
  }

  .paper-box.list-commas li {
    display: inline;
  }

  .paper-box.list-commas li::after {
    content: ", ";
  }

  .paper-box.list-commas li:last-child::after {
    content: "";
  }

  .paper-box p,
  .paper-box li {
    margin: 0;
  }

  [data-multiline="true"] {
    white-space: pre-wrap;
  }

  .paragraph-box {
    text-align: justify;
    text-justify: inter-word;
    min-height: 120px;
    orphans: 3;
    widows: 3;
  }

  p {
    orphans: 3;
    widows: 3;
  }

  .muted {
    color: #8a97a5;
    font-style: italic;
    text-align: center;
    padding: 12px;
  }

  .analysis-grid {
    display: grid;
    gap: 18px;
  }

  .analysis-item {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .analysis-item .sub-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-weight: 600;
    color: #3b4a5a;
  }

  .analysis-grid .paper-box {
    min-height: 80px;
  }

  @media screen and (min-width: 992px), print {
    .analysis-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  .signature-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-top: 18px;
  }

  .signature-block {
    text-align: center;
  }

  .signature-line {
    border: 1px solid #cfd3d7;
    height: 70px;
    border-radius: 6px;
    margin-bottom: 8px;
    background: #fafbfc;
  }

  .signature-label {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #3b4a5a;
    font-weight: 600;
  }

  .annex-title {
    font-size: 13pt;
    font-weight: 700;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    margin-bottom: 12px;
    color: #1e3a5f;
  }

  .annex-grid {
    display: grid;
    gap: 16px;
  }

  .annex-grid.two-col {
    grid-template-columns: repeat(2, 1fr);
  }

  .annex-grid.four-col {
    grid-template-columns: repeat(4, 1fr);
  }

  .annex-card {
    border: 1px solid #cfd3d7;
    border-radius: 6px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    background: #fff;
    min-height: 160px;
  }

  .annex-thumb {
    width: 100%;
    background: #eceff2;
    border-bottom: 1px solid #cfd3d7;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  .annex-card .annex-thumb {
    height: 140px;
  }

  .single-attachment .annex-thumb {
    height: 220px;
  }

  .annex-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .annex-card figcaption,
  .single-attachment figcaption {
    padding: 8px 10px;
    font-size: 0.85rem;
    background: #f8fafc;
    border-top: 1px solid #cfd3d7;
    min-height: 44px;
  }

  .img-ph {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: repeating-linear-gradient(45deg, #e2e7ec, #e2e7ec 8px, #f5f7fa 8px, #f5f7fa 16px);
    color: #6b7785;
    font-weight: 600;
    font-size: 0.85rem;
    text-transform: uppercase;
  }

  .single-attachment {
    border: 1px solid #cfd3d7;
    border-radius: 6px;
    overflow: hidden;
    max-width: 360px;
  }

  .volunteer-table thead th {
    background: #eef2f7;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 0.7rem;
    color: #3b4a5a;
  }

  .volunteer-table th,
  .volunteer-table td {
    border: 1px solid #cfd3d7;
    padding: 8px 10px;
    font-size: 0.85rem;
  }

  .volunteer-table td {
    min-height: 38px;
  }

  .report-footer {
    border-top: 2px solid #d3d7db;
    margin-top: 36px;
    padding-top: 12px;
    font-size: 0.8rem;
    color: #516070;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: running(report-footer);
  }

  .report-footer .page-num::after {
    content: "Page " counter(page) " of " counter(pages);
  }

  .date-field {
    text-align: right;
    margin-top: 16px;
  }

  .page-break {
    break-before: page;
  }

  .paper-input {
    width: 100%;
    border: none;
    border-radius: 4px;
    padding: 6px 8px;
    font: inherit;
    background: transparent;
    resize: vertical;
    min-height: 34px;
  }

  .paper-input:focus {
    outline: none;
    box-shadow: inset 0 0 0 2px rgba(17, 94, 168, 0.25);
  }

  .mode-edit .paper-box {
    padding: 0;
    background: #fff;
  }

  .mode-edit .paper-box.list-commas,
  .mode-edit .paper-box.bullet-list {
    padding-left: 0;
  }

  .mode-edit .paper-box.bullet-list li::marker,
  .mode-edit .paper-box.list-commas li::after {
    content: "";
  }

  .report-actions {
    display: flex;
    gap: 12px;
    margin-top: 12px;
    align-self: flex-end;
  }

  .report-actions .btn {
    min-width: 140px;
    border-radius: 999px;
  }

  @media screen and (max-width: 960px) {
    body.command-center-layout {
      font-size: 10.5pt;
    }
    .iqac-report-page {
      padding: 16px;
    }
    .report-sheet {
      padding: 18mm 12mm;
    }
    .report-header {
      flex-direction: column;
      align-items: flex-start;
    }
    .report-header .iqac-title {
      text-align: left;
    }
    .annex-grid.four-col {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media print {
    body.command-center-layout {
      background: #fff;
      padding: 0;
    }
    .screen-controls,
    .report-actions,
    .ai-progress-banner {
      display: none !important;
    }
    .iqac-report-page {
      padding: 0;
    }
    .report-sheet {
      border: none;
      box-shadow: none;
      padding: 0;
    }
    .report-header,
    .report-footer {
      display: block;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="iqac-report-page" id="iqac-report-page">
  <div class="screen-controls">
    <button type="button" id="toggle-edit" class="btn btn-outline-secondary">Edit</button>
    <button type="button" id="print-report" class="btn btn-primary">Print / Save PDF</button>
  </div>

  <div class="ai-progress-banner" id="ai_status">AI is generating your report in real time...</div>

  <div class="report-wrapper">
    <article class="report-sheet">
      <header class="report-header">
        <div class="brand">
          <div class="logo-placeholder">Logo</div>
          <div class="institution">
            <span>CHRIST (Deemed to be University) — Pune Lavasa Campus</span>
            <span>School of Sciences</span>
          </div>
        </div>
        <div class="iqac-title">Internal Quality Assurance Cell (IQAC) — Event Report</div>
      </header>

      <main class="report-body">
        <section class="report-section" id="section-1">
          <div class="section-heading">
            <span class="kicker">Section 1.</span>
            <h2>Event Information</h2>
          </div>
          <table class="grid-table">
            <tbody>
              <tr>
                <th>Department</th>
                <td class="paper-box" data-field="event_info.department">—</td>
                <th>Location</th>
                <td class="paper-box" data-field="event_info.location">—</td>
              </tr>
              <tr>
                <th>Event Title</th>
                <td class="paper-box" data-field="event_info.title">—</td>
                <th>No. of Activities</th>
                <td class="paper-box" data-field="event_info.activities_count">—</td>
              </tr>
              <tr>
                <th>Date &amp; Time</th>
                <td class="paper-box" data-field="event_info.datetime">—</td>
                <th>Venue</th>
                <td class="paper-box" data-field="event_info.venue">—</td>
              </tr>
              <tr>
                <th>Academic Year</th>
                <td class="paper-box" data-field="event_info.academic_year">—</td>
                <th>Event Type (Focus)</th>
                <td class="paper-box" data-field="event_info.focus">—</td>
              </tr>
            </tbody>
          </table>
        </section>

        <section class="report-section" id="section-2">
          <div class="section-heading">
            <span class="kicker">Section 2.</span>
            <h2>Participants Information</h2>
          </div>
          <table class="grid-table">
            <tbody>
              <tr>
                <th>Target Audience</th>
                <td class="paper-box" data-field="participants.target_audience">—</td>
                <th>External Agencies / Speakers / Guests</th>
                <td class="paper-box" data-field="participants.external_agencies">—</td>
              </tr>
              <tr>
                <th>Website / Contact of External Members</th>
                <td class="paper-box" data-field="participants.external_contacts">—</td>
                <th>Organising Committee</th>
                <td>
                  <ul class="paper-box list-commas" data-list="participants.organising_committee" data-rows="4">
                    <li>—</li>
                  </ul>
                </td>
              </tr>
              <tr>
                <th>No. of Student Volunteers</th>
                <td class="paper-box" data-field="participants.student_volunteers">—</td>
                <th>No. of Attendees / Participants</th>
                <td class="paper-box" data-field="participants.participants_count">—</td>
              </tr>
            </tbody>
          </table>
        </section>

        <section class="report-section" id="section-3">
          <div class="section-heading">
            <span class="kicker">Section 3.</span>
            <h2>Summary of the Overall Event</h2>
          </div>
          <div class="paper-box paragraph-box" data-field="summary" data-multiline="true" data-rows="8">—</div>
          <h3 class="annex-title" style="font-size: 12pt; margin-top: 18px;">Activities</h3>
          <ul class="paper-box bullet-list" data-list="activities" data-rows="5">
            <li>—</li>
          </ul>
        </section>

        <section class="report-section" id="section-4">
          <div class="section-heading">
            <span class="kicker">Section 4.</span>
            <h2>Social Relevance</h2>
          </div>
          <ul class="paper-box bullet-list" data-list="social_relevance" data-rows="4">
            <li>—</li>
          </ul>
        </section>

        <section class="report-section" id="section-5">
          <div class="section-heading">
            <span class="kicker">Section 5.</span>
            <h2>Outcomes of the Event</h2>
          </div>
          <ul class="paper-box bullet-list" data-list="outcomes" data-rows="4">
            <li>—</li>
          </ul>
        </section>

        <section class="report-section" id="section-6">
          <div class="section-heading">
            <span class="kicker">Section 6.</span>
            <h2>Analysis</h2>
          </div>
          <div class="analysis-grid">
            <div class="analysis-item">
              <div class="sub-label">Impact on Attendees</div>
              <div class="paper-box" data-field="analysis.attendees" data-multiline="true" data-rows="4">—</div>
            </div>
            <div class="analysis-item">
              <div class="sub-label">Impact on Schools</div>
              <div class="paper-box" data-field="analysis.schools" data-multiline="true" data-rows="4">—</div>
            </div>
            <div class="analysis-item">
              <div class="sub-label">Impact on Volunteers</div>
              <div class="paper-box" data-field="analysis.volunteers" data-multiline="true" data-rows="4">—</div>
            </div>
          </div>
        </section>

        <section class="report-section" id="section-7">
          <div class="section-heading">
            <span class="kicker">Section 7.</span>
            <h2>Relevance of the Event</h2>
          </div>
          <table class="grid-table full-width">
            <tbody>
              <tr>
                <th>With reference to Graduate Attributes</th>
                <td class="paper-box" data-field="relevance.graduate_attributes" data-multiline="true" data-rows="3">—</td>
              </tr>
              <tr>
                <th>Support to Value Systems / SDGs</th>
                <td class="paper-box" data-field="relevance.sdg" data-multiline="true" data-rows="3">—</td>
              </tr>
            </tbody>
          </table>
        </section>

        <section class="report-section" id="section-8">
          <div class="section-heading">
            <span class="kicker">Section 8.</span>
            <h2>Suggestions for Improvement / Feedback from IQAC</h2>
          </div>
          <ul class="paper-box bullet-list" data-list="suggestions" data-rows="5">
            <li>—</li>
          </ul>
          <div class="date-field">
            <span>Date:&nbsp;</span>
            <span class="paper-box" style="display: inline-block; min-width: 160px;" data-field="suggestions_date">—</span>
          </div>
          <div class="signature-row">
            <div class="signature-block">
              <div class="signature-line"></div>
              <div class="signature-label">Head / Coordinator</div>
            </div>
            <div class="signature-block">
              <div class="signature-line"></div>
              <div class="signature-label">Faculty Coordinator / Organiser</div>
            </div>
            <div class="signature-block">
              <div class="signature-line"></div>
              <div class="signature-label">IQAC</div>
            </div>
          </div>
        </section>

        <section class="report-section page-break" id="section-9">
          <div class="section-heading">
            <span class="kicker">Section 9.</span>
            <h2>Attachments (Annexures)</h2>
          </div>
          <div class="annex-title">Annexure A. Photographs</div>
          <div class="annex-grid two-col" data-grid="annexures.photos">
            <div class="muted">—</div>
          </div>
        </section>

        <section class="report-section page-break" id="annexure-b">
          <div class="annex-title">Annexure B. Brochure (4 pages)</div>
          <div class="annex-grid four-col" data-grid="annexures.brochure_pages">
            <div class="muted">—</div>
          </div>
        </section>

        <section class="report-section page-break" id="annexure-c">
          <div class="annex-title">Annexure C. Communication with Institution</div>
          <table class="grid-table full-width" style="margin-bottom: 16px;">
            <tbody>
              <tr>
                <th>Subject</th>
                <td class="paper-box" data-field="annexures.communication.subject">—</td>
              </tr>
              <tr>
                <th>Date</th>
                <td class="paper-box" data-field="annexures.communication.date">—</td>
              </tr>
            </tbody>
          </table>
          <table class="volunteer-table">
            <thead>
              <tr>
                <th>Sl No</th>
                <th>Reg No</th>
                <th>Name</th>
                <th>Class</th>
                <th>Role</th>
              </tr>
            </thead>
            <tbody data-rows="annexures.communication.volunteer_list">
              <tr>
                <td colspan="5" class="text-center text-muted">—</td>
              </tr>
            </tbody>
          </table>
        </section>

        <section class="report-section page-break" id="annexure-d">
          <div class="annex-title">Annexure D. Worksheets / Activities</div>
          <div class="annex-grid two-col" data-grid="annexures.worksheets">
            <div class="muted">—</div>
          </div>
        </section>

        <section class="report-section page-break" id="annexure-e">
          <div class="annex-title">Annexure E. Evaluation Sheet</div>
          <figure class="single-attachment" data-src="annexures.evaluation_sheet">
            <div class="annex-thumb">
              <div class="img-ph">Image</div>
            </div>
            <figcaption>—</figcaption>
          </figure>
        </section>

        <section class="report-section page-break" id="annexure-f">
          <div class="annex-title">Annexure F. Feedback Form</div>
          <figure class="single-attachment" data-src="annexures.feedback_form">
            <div class="annex-thumb">
              <div class="img-ph">Image</div>
            </div>
            <figcaption>—</figcaption>
          </figure>
        </section>
      </main>

      <footer class="report-footer">
        <div>CHRIST (Deemed to be University), Pune Lavasa Campus, 30 Valor Street, Lavasa, Pune 412112, Maharashtra, India</div>
        <div class="page-num"></div>
      </footer>
    </article>
  </div>

  <div class="report-actions">
    <button type="button" class="btn btn-outline-secondary" id="ai-edit-report">Refine with AI</button>
    <button type="button" class="btn btn-primary" id="ai-submit-report">Submit Report</button>
  </div>
</div>

<script type="application/json" id="initial-report-data">{{ initial_report_data|safe }}</script>

<script>
  function hydrateReport(data = {}) {
    const root = document.getElementById('iqac-report-page');
    if (!root) return;

    const setText = (sel, val) => {
      const el = root.querySelector(sel);
      if (!el) return;
      const value = val ?? '—';
      el.textContent = value === '' ? '—' : value;
    };

    const setList = (sel, arr) => {
      const el = root.querySelector(sel);
      if (!el) return;
      const items = (arr && arr.length) ? arr : ['—'];
      el.innerHTML = '';
      items.forEach((item) => {
        const li = document.createElement('li');
        li.textContent = item;
        el.appendChild(li);
      });
    };

    const setGrid = (sel, items) => {
      const wrap = root.querySelector(sel);
      if (!wrap) return;
      wrap.innerHTML = '';
      if (!items || !items.length) {
        wrap.innerHTML = '<div class="muted">—</div>';
        return;
      }
      items.forEach((it) => {
        const card = document.createElement('figure');
        card.className = 'annex-card';
        const thumb = document.createElement('div');
        thumb.className = 'annex-thumb';
        const captionText = (it && it.caption !== undefined && it.caption !== null && it.caption !== '') ? it.caption : '—';
        if (it && it.src) {
          const img = document.createElement('img');
          img.src = it.src;
          img.alt = captionText === '—' ? 'Image' : captionText;
          thumb.appendChild(img);
        } else {
          const placeholder = document.createElement('div');
          placeholder.className = 'img-ph';
          placeholder.textContent = 'Image';
          thumb.appendChild(placeholder);
        }
        const cap = document.createElement('figcaption');
        cap.textContent = captionText;
        card.appendChild(thumb);
        card.appendChild(cap);
        wrap.appendChild(card);
      });
    };

    const setRows = (sel, rows) => {
      const tb = root.querySelector(sel);
      if (!tb) return;
      tb.innerHTML = '';
      if (!rows || !rows.length) {
        tb.innerHTML = '<tr><td colspan="5" class="text-center text-muted">—</td></tr>';
        return;
      }
      rows.forEach((r, index) => {
        const tr = document.createElement('tr');
        ['sl', 'reg', 'name', 'class_', 'role'].forEach((k) => {
          const td = document.createElement('td');
          if (k === 'sl') {
            const sl = r && r[k];
            td.textContent = (sl === undefined || sl === null || sl === '') ? String(index + 1) : sl;
          } else {
            td.textContent = (r && r[k] !== undefined && r[k] !== null && r[k] !== '') ? r[k] : '—';
          }
          tr.appendChild(td);
        });
        tb.appendChild(tr);
      });
    };

    const setSingle = (sel, item) => {
      const el = root.querySelector(sel);
      if (!el) return;
      const thumb = el.querySelector('.annex-thumb');
      const cap = el.querySelector('figcaption');
      const value = (typeof item === 'string') ? { src: item, caption: null } : (item || {});
      const caption = value.caption;
      const displayCaption = (caption === undefined || caption === null || caption === '') ? '—' : caption;
      if (thumb) {
        thumb.innerHTML = '';
        if (value.src) {
          const img = document.createElement('img');
          img.src = value.src;
          img.alt = displayCaption === '—' ? 'Image' : displayCaption;
          thumb.appendChild(img);
        } else {
          const placeholder = document.createElement('div');
          placeholder.className = 'img-ph';
          placeholder.textContent = 'Image';
          thumb.appendChild(placeholder);
        }
      }
      if (cap) {
        cap.textContent = displayCaption;
      }
    };

    setText('[data-field="event_info.department"]', data?.event_info?.department);
    setText('[data-field="event_info.location"]', data?.event_info?.location);
    setText('[data-field="event_info.title"]', data?.event_info?.title);
    setText('[data-field="event_info.activities_count"]', data?.event_info?.activities_count);
    setText('[data-field="event_info.datetime"]', data?.event_info?.datetime);
    setText('[data-field="event_info.venue"]', data?.event_info?.venue);
    setText('[data-field="event_info.academic_year"]', data?.event_info?.academic_year);
    setText('[data-field="event_info.focus"]', data?.event_info?.focus);

    setText('[data-field="participants.target_audience"]', data?.participants?.target_audience);
    setText('[data-field="participants.external_agencies"]', data?.participants?.external_agencies);
    setText('[data-field="participants.external_contacts"]', data?.participants?.external_contacts);
    setList('[data-list="participants.organising_committee"]', data?.participants?.organising_committee);
    setText('[data-field="participants.student_volunteers"]', data?.participants?.student_volunteers);
    setText('[data-field="participants.participants_count"]', data?.participants?.participants_count);

    setText('[data-field="summary"]', data?.summary);
    setList('[data-list="activities"]', data?.activities);
    setList('[data-list="social_relevance"]', data?.social_relevance);
    setList('[data-list="outcomes"]', data?.outcomes);

    setText('[data-field="analysis.attendees"]', data?.analysis?.attendees);
    setText('[data-field="analysis.schools"]', data?.analysis?.schools);
    setText('[data-field="analysis.volunteers"]', data?.analysis?.volunteers);

    setText('[data-field="relevance.graduate_attributes"]', data?.relevance?.graduate_attributes);
    setText('[data-field="relevance.sdg"]', data?.relevance?.sdg);

    setList('[data-list="suggestions"]', data?.suggestions);
    setText('[data-field="suggestions_date"]', data?.suggestions_date);

    setGrid('[data-grid="annexures.photos"]', data?.annexures?.photos);
    setGrid('[data-grid="annexures.brochure_pages"]', data?.annexures?.brochure_pages);
    setText('[data-field="annexures.communication.subject"]', data?.annexures?.communication?.subject);
    setText('[data-field="annexures.communication.date"]', data?.annexures?.communication?.date);
    setRows('[data-rows="annexures.communication.volunteer_list"]', data?.annexures?.communication?.volunteer_list);
    setGrid('[data-grid="annexures.worksheets"]', data?.annexures?.worksheets);
    setSingle('[data-src="annexures.evaluation_sheet"]', data?.annexures?.evaluation_sheet);
    setSingle('[data-src="annexures.feedback_form"]', data?.annexures?.feedback_form);
  }

  (function initPage() {
    const root = document.getElementById('iqac-report-page');
    if (!root) return;

    const initialDataEl = document.getElementById('initial-report-data');
    let initialData = {};
    if (initialDataEl && initialDataEl.textContent.trim()) {
      try {
        initialData = JSON.parse(initialDataEl.textContent);
      } catch (err) {
        console.error('Failed to parse initial data', err);
      }
    }

    const clone = (obj) => JSON.parse(JSON.stringify(obj || {}));
    let reportData = clone(initialData);
    hydrateReport(reportData);

    const toListFromText = (text) => {
      if (!text) return [];
      if (Array.isArray(text)) return text;
      const normalized = String(text).replace(/\r/g, '');
      const cleaned = normalized
        .replace(/^\s*[-*•\u2022]+\s+/gm, '')
        .replace(/[,;]+/g, '\n')
        .replace(/\u2022+/g, '\n');
      return cleaned
        .split(/\n+/)
        .map((item) => item.trim())
        .filter(Boolean);
    };

    const setNested = (obj, path, value) => {
      if (!path || !path.length) return;
      let cursor = obj;
      path.slice(0, -1).forEach((key) => {
        if (!cursor[key] || typeof cursor[key] !== 'object') {
          cursor[key] = {};
        }
        cursor = cursor[key];
      });
      cursor[path[path.length - 1]] = value;
    };

    const fieldMap = {
      'department': { path: ['event_info', 'department'] },
      'event title': { path: ['event_info', 'title'] },
      'date & time': { path: ['event_info', 'datetime'] },
      'event date': { path: ['event_info', 'datetime'] },
      'venue': { path: ['event_info', 'venue'] },
      'academic year': { path: ['event_info', 'academic_year'] },
      'focus/objective': { path: ['event_info', 'focus'] },
      'focus / objective': { path: ['event_info', 'focus'] },
      'event type (focus)': { path: ['event_info', 'focus'] },
      'target audience': { path: ['participants', 'target_audience'] },
      'external agencies': { path: ['participants', 'external_agencies'] },
      'external agencies/speakers/guests': { path: ['participants', 'external_agencies'] },
      'speakers': { path: ['participants', 'external_agencies'] },
      'website/contact of external members': { path: ['participants', 'external_contacts'] },
      'organizing committee': { path: ['participants', 'organising_committee'], type: 'list' },
      'organising committee': { path: ['participants', 'organising_committee'], type: 'list' },
      'no. of student volunteers': { path: ['participants', 'student_volunteers'] },
      'number of student volunteers': { path: ['participants', 'student_volunteers'] },
      'no. of attendees/participants': { path: ['participants', 'participants_count'] },
      'no. of participants': { path: ['participants', 'participants_count'] },
      'summary': { path: ['summary'] },
      'event summary': { path: ['summary'] },
      'activities': { path: ['activities'], type: 'list' },
      'social relevance': { path: ['social_relevance'], type: 'list' },
      'outcomes': { path: ['outcomes'], type: 'list' },
      'feedback': { path: ['suggestions'], type: 'list' },
      'feedback & suggestions': { path: ['suggestions'], type: 'list' },
      'recommendations': { path: ['suggestions'], type: 'list' },
      'impact on attendees': { path: ['analysis', 'attendees'] },
      'impact on schools': { path: ['analysis', 'schools'] },
      'impact on volunteers': { path: ['analysis', 'volunteers'] },
      'graduate attributes': { path: ['relevance', 'graduate_attributes'] },
      'support to value systems / sdgs': { path: ['relevance', 'sdg'] },
      'date': { path: ['suggestions_date'] },
    };

    const applyFieldValue = (key, rawValue) => {
      const mapKey = key.trim().toLowerCase();
      const entry = fieldMap[mapKey];
      if (!entry) return;
      if (entry.type === 'list') {
        const listValues = toListFromText(rawValue);
        setNested(reportData, entry.path, listValues);
      } else {
        setNested(reportData, entry.path, rawValue.trim());
      }
    };

    const parseColonFields = (reportText) => {
      const cleaned = reportText.replace(/[\r]+/g, '');
      const lines = cleaned.split('\n');
      const fields = {};
      lines.forEach((line) => {
        const idx = line.indexOf(':');
        if (idx > 0) {
          const key = line.slice(0, idx).trim().toLowerCase();
          const value = line.slice(idx + 1).trim();
          if (key && value !== undefined) {
            fields[key] = value;
          }
        }
      });
      return fields;
    };

    const parseMarkdownSections = (text) => {
      const result = {};
      const titleMatch = text.match(/^#\s*([^\n]+)/m);
      if (titleMatch && titleMatch[1]) {
        const title = titleMatch[1].replace(/^event report[:\-\s]*/i, '').trim();
        if (title) {
          result.title = title;
        }
      }
      const blocks = text.split(/\n(?=##\s+)/);
      blocks.forEach((block) => {
        const match = block.match(/^##\s*([^\n]+)/);
        if (!match) return;
        const heading = match[1].trim().toLowerCase();
        const body = block.replace(/^##\s*[^\n]+\n?/, '').trim();
        if (!body) return;
        if (heading.startsWith('summary')) {
          result.summary = body;
        } else if (heading.startsWith('outcome')) {
          result.outcomes = body;
        } else if (heading.startsWith('recommend')) {
          result.recommendations = body;
        } else if (heading.startsWith('activity')) {
          result.activities = body;
        }
      });
      return result;
    };

    const mergeMarkdownSections = (sections) => {
      if (sections.title) {
        setNested(reportData, ['event_info', 'title'], sections.title);
      }
      if (sections.summary) {
        setNested(reportData, ['summary'], sections.summary.trim());
      }
      if (sections.outcomes) {
        setNested(reportData, ['outcomes'], toListFromText(sections.outcomes));
      }
      if (sections.recommendations) {
        setNested(reportData, ['suggestions'], toListFromText(sections.recommendations));
      }
      if (sections.activities) {
        setNested(reportData, ['activities'], toListFromText(sections.activities));
      }
    };

    const updateDom = () => {
      hydrateReport(reportData);
    };

    const statusEl = document.getElementById('ai_status');

    fetch("{% url 'emt:generate_ai_report_stream' proposal.id %}", { method: 'GET' })
      .then((response) => {
        const reader = response.body.getReader();
        let buffer = '';
        const pump = () => reader.read().then(({ value, done }) => {
          if (value) {
            buffer += new TextDecoder('utf-8').decode(value);
            const fields = parseColonFields(buffer);
            Object.entries(fields).forEach(([key, val]) => applyFieldValue(key, val));
            const sections = parseMarkdownSections(buffer);
            mergeMarkdownSections(sections);
            updateDom();
          }
          if (done) {
            if (statusEl) {
              statusEl.textContent = 'AI has filled your report!';
            }
            return;
          }
          return pump();
        });
        return pump();
      })
      .catch((err) => {
        console.error('AI stream failed', err);
        if (statusEl) {
          statusEl.textContent = 'AI report generation failed. You can continue editing manually.';
        }
      });

    const editBtn = document.getElementById('toggle-edit');
    const printBtn = document.getElementById('print-report');
    const refineBtn = document.getElementById('ai-edit-report');
    const submitBtn = document.getElementById('ai-submit-report');

    const captureFromDom = () => {
      const nextData = {};
      root.querySelectorAll('[data-field]').forEach((el) => {
        const key = el.getAttribute('data-field');
        if (!key) return;
        const path = key.split('.');
        const value = el.textContent.trim();
        setNested(nextData, path, value === '—' ? '' : value);
      });
      root.querySelectorAll('[data-list]').forEach((el) => {
        const key = el.getAttribute('data-list');
        if (!key) return;
        const path = key.split('.');
        const items = Array.from(el.querySelectorAll('li')).map((li) => li.textContent.trim()).filter(Boolean);
        setNested(nextData, path, items.length ? items : []);
      });
      return nextData;
    };

    if (printBtn) {
      printBtn.addEventListener('click', () => window.print());
    }

    if (refineBtn) {
      refineBtn.addEventListener('click', () => {
        window.location.href = "{% url 'emt:ai_report_edit' proposal.id %}";
      });
    }

    if (submitBtn) {
      submitBtn.addEventListener('click', () => {
        window.location.href = "{% url 'emt:ai_report_submit' proposal.id %}";
      });
    }

    if (editBtn) {
      let edit = false;
      const toEdit = () => {
        root.querySelectorAll('[data-field]').forEach((el) => {
          if (el.querySelector('input, textarea')) return;
          const isMulti = el.dataset.multiline === 'true';
          const tag = isMulti ? 'textarea' : 'input';
          const control = document.createElement(tag);
          control.className = 'paper-input';
          if (!isMulti) control.type = 'text';
          const rows = parseInt(el.dataset.rows || '3', 10);
          if (isMulti) control.rows = rows;
          const currentText = el.textContent.trim();
          control.value = currentText === '—' ? '' : currentText;
          el.innerHTML = '';
          el.appendChild(control);
        });
        root.querySelectorAll('[data-list]').forEach((el) => {
          const textarea = document.createElement('textarea');
          textarea.className = 'paper-input';
          const rows = parseInt(el.dataset.rows || '4', 10);
          textarea.rows = rows;
          const values = Array.from(el.querySelectorAll('li'))
            .map((li) => li.textContent.trim())
            .filter((txt) => txt && txt !== '—');
          textarea.value = values.join('\n');
          el.innerHTML = '';
          el.appendChild(textarea);
        });
      };

      const toPreview = () => {
        root.querySelectorAll('[data-field]').forEach((el) => {
          const control = el.querySelector('input, textarea');
          if (!control) return;
          const value = control.value.trim();
          el.innerHTML = value === '' ? '—' : value;
        });
        root.querySelectorAll('[data-list]').forEach((el) => {
          const textarea = el.querySelector('textarea');
          if (!textarea) return;
          const raw = textarea.value.split('\n').map((line) => line.trim()).filter(Boolean);
          const items = raw.length ? raw : ['—'];
          el.innerHTML = '';
          items.forEach((item) => {
            const li = document.createElement('li');
            li.textContent = item;
            el.appendChild(li);
          });
        });
        reportData = Object.assign(clone(reportData), captureFromDom());
        updateDom();
      };

      editBtn.addEventListener('click', () => {
        edit = !edit;
        root.classList.toggle('mode-edit', edit);
        editBtn.textContent = edit ? 'Preview' : 'Edit';
        if (edit) {
          toEdit();
        } else {
          toPreview();
        }
      });
    }
  })();
</script>
{% endblock %}
