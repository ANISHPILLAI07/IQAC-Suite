{% extends "base.html" %}
{% load static %}

{% block title %}Preview Event Report{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'emt/css/report_preview.css' %}">
{% endblock %}

{% block content %}
<div class="preview-layout">
  <div class="proposal-content">
    <div class="content-header">
      <h1 class="content-title">{{ proposal.event_title|default:"Event Report Preview" }}</h1>
      <p class="content-subtitle">Review the captured event details before starting AI report generation.</p>
      {% if overview_highlights %}
        <div class="meta-chips">
          {% for item in overview_highlights %}
            <span class="chip">{{ item.label }}: {{ item.value }}</span>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    {% if preview_nav %}
      <div class="top-toolbar">
        <div class="pill-nav">
          {% for item in preview_nav %}
            <a href="#{{ item.id }}">{{ item.title }}</a>
          {% endfor %}
        </div>
        <div class="toolbar">
          <a href="{% url 'emt:submit_event_report' proposal.id %}" class="btn-ghost">Edit Report</a>
          <button type="button" class="btn-ghost" id="print-preview">Print / Save PDF</button>
        </div>
      </div>
    {% endif %}

    {% if not form_is_valid %}
      <section class="section-card" role="alert">
        <div class="section-title">Some sections still need attention</div>
        <p class="content-subtitle">
          Please resolve the validation messages on the report form before triggering AI generation.
        </p>
      </section>
    {% endif %}

    {% for section in preview_sections %}
      <section id="{{ section.id }}" class="section-card">
        <div class="section-header">
          <h2 class="section-title">{{ section.title }}</h2>
        </div>

        {% if section.fields %}
          <div class="preview-fields">
            {% for field in section.fields %}
              <div class="field-row">
                <div class="field-label">{{ field.label }}</div>
                <div class="field-value{% if field.muted %} muted{% endif %}">
                  {{ field.value|default:"—" }}
                </div>
              </div>
            {% endfor %}
          </div>
        {% endif %}

        {% if section.lists %}
          {% for list in section.lists %}
            <div class="divider"></div>
            <div class="field-label">{{ list.label }}</div>
            <ul class="preview-list">
              {% if list.items %}
                {% for item in list.items %}
                  <li>{{ item }}</li>
                {% endfor %}
              {% else %}
                <li class="muted">—</li>
              {% endif %}
            </ul>
          {% endfor %}
        {% endif %}

        {% if section.chips %}
          <div class="meta-chips">
            {% for chip in section.chips %}
              <span class="chip">{{ chip }}</span>
            {% endfor %}
          </div>
        {% endif %}
      </section>
    {% empty %}
      <section class="section-card">
        <p class="content-subtitle muted">Preview information is not available for this report.</p>
      </section>
    {% endfor %}

    <div class="sticky-actions">
      <div class="actions-bar">
        <a href="{% url 'emt:submit_event_report' proposal.id %}" class="btn-secondary">Back to Editing</a>
        <form id="generate-ai-form" class="generate-ai-form" method="post" action="{% url 'emt:submit_event_report' proposal.id %}">
          {% csrf_token %}
          {% for key, values in post_data_items %}
            {% if key != 'csrfmiddlewaretoken' and key != 'generate_ai' %}
              {% for value in values %}
                <input type="hidden" name="{{ key }}" value="{{ value }}">
              {% endfor %}
            {% endif %}
          {% endfor %}
          <input type="hidden" name="generate_ai" value="1">
          <button type="submit" class="btn-primary" id="generate-ai-report"{% if not form_is_valid %} disabled aria-disabled="true" data-disabled="true" title="Resolve required fields before generating the AI report."{% endif %}>
            Generate Report
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var printBtn = document.getElementById('print-preview');
    if (printBtn) {
      printBtn.addEventListener('click', function () {
        window.print();
      });
    }

    var generateBtn = document.getElementById('generate-ai-report');
    if (generateBtn && generateBtn.dataset.disabled === 'true') {
      generateBtn.addEventListener('click', function (event) {
        event.preventDefault();
        event.stopPropagation();
        alert('Please resolve required fields before generating the AI report.');
      });
    }
  });
</script>
<script type="application/json" id="initial-report-data">{{ initial_report_data|default:"{}"|safe }}</script>
{% endblock %}
