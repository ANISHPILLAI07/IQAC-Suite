{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<style>
  @page {
    size: A4;
    margin: 20mm 18mm 22mm;
  }

  body.command-center-layout {
    background: #f4f4f4;
    font-family: "Times New Roman", Times, serif;
    font-size: 12pt;
    line-height: 1.45;
    color: #000;
  }

  body.command-center-layout.iqac-report-preview {
    background: #f4f4f4;
  }

  .preview-shell {
    display: flex;
    flex-direction: column;
    gap: 12px;
    align-items: center;
    padding: 24px;
  }

  .control-row {
    width: 210mm;
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 8px;
  }

  .controls {
    display: flex;
    gap: 8px;
  }

  .status-pill {
    margin-left: auto;
    padding: 4px 10px;
    border: 0.6pt solid #000;
    border-radius: 12px;
    font-size: 11pt;
    background: #f0f0f0;
  }

  .controls button {
    font-family: "Times New Roman", Times, serif;
    font-size: 12pt;
    padding: 4px 16px;
    border: 0.6pt solid #000;
    background: #fafafa;
    cursor: pointer;
  }

  .controls button:focus {
    outline: 1pt dotted #000;
    outline-offset: 2px;
  }

  main#report,
  .paper {
    width: 210mm;
    min-height: 297mm;
    background: #fff;
    padding: 20mm 18mm 22mm;
    box-shadow: 0 4px 18px rgba(0, 0, 0, 0.12);
  }

  main#report {
    min-height: 297mm;
  }

  .report-header {
    text-align: center;
  }

  .hdr-line {
    margin: 0;
  }

  .hdr-upper {
    text-transform: uppercase;
    font-weight: 700;
    letter-spacing: 0.04em;
  }

  .hdr-italic {
    font-style: italic;
  }

  .hdr-event,
  .hdr-title {
    text-transform: uppercase;
    font-weight: 700;
    letter-spacing: 0.04em;
  }

  .header-rule {
    border: none;
    border-top: 0.6pt solid #000;
    margin: 8mm 0 6mm;
  }

  .section-block {
    margin-bottom: 8mm;
  }

  .section-title {
    text-transform: uppercase;
    font-weight: 700;
    letter-spacing: 0.08em;
    margin: 0 0 3mm;
  }

  .grid-table,
  .checklist {
    width: 100%;
    border: 0.6pt solid #000;
    border-collapse: collapse;
    table-layout: fixed;
  }

  .grid-table.four-col col.col-label {
    width: 27%;
  }

  .grid-table.four-col col.col-value {
    width: 23%;
  }

  .grid-table.two-col col.col-label {
    width: 35%;
  }

  .grid-table.two-col col.col-value {
    width: 65%;
  }

  .grid-table th,
  .grid-table td,
  .checklist th,
  .checklist td {
    border: 0.6pt solid #000;
    padding: 3mm 2.4mm;
    vertical-align: top;
  }

  .grid-table th {
    text-transform: uppercase;
    font-weight: 700;
    letter-spacing: 0.03em;
  }

  .cell-para {
    margin: 0;
    white-space: pre-wrap;
    text-align: justify;
    text-justify: inter-word;
  }

  .summary-box {
    border: 0.6pt solid #000;
    padding: 3mm;
    min-height: 32mm;
  }

  .cell-ul {
    margin: 0;
    padding-left: 18px;
  }

  ul[data-empty="true"] {
    list-style: none;
    padding-left: 0;
  }

  .analysis-grid {
    display: flex;
    gap: 4mm;
  }

  .analysis-box {
    flex: 1;
    border: 0.6pt solid #000;
    padding: 3mm;
    min-height: 42mm;
  }

  .analysis-label {
    text-transform: uppercase;
    font-weight: 700;
    letter-spacing: 0.04em;
    margin-bottom: 2mm;
  }

  .sdg-row {
    display: flex;
    gap: 4mm;
    border: 0.6pt solid #000;
    padding: 3mm;
    margin-top: 4mm;
  }

  .sdg-label {
    width: 35%;
    text-transform: uppercase;
    font-weight: 700;
    letter-spacing: 0.04em;
  }

  .sdg-values {
    flex: 1;
  }

  .sdg-list {
    margin: 0;
    padding-left: 18px;
  }

  .sdg-list li {
    display: inline-block;
    margin-right: 6px;
  }

  .course-table col.col-code {
    width: 18%;
  }

  .course-table col.col-name {
    width: 36%;
  }

  .course-table col.col-type {
    width: 22%;
  }

  .course-table col.col-note {
    width: 24%;
  }

  .chips {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .chip {
    border: 0.6pt solid #000;
    padding: 2px 6px;
    font-size: 10.5pt;
    border-radius: 2px;
  }

  .review-date {
    margin-top: 3mm;
    font-weight: 700;
  }

  .checklist col.c-tick {
    width: 8mm;
  }

  .checklist td:first-child {
    text-align: center;
  }

  .tick {
    font-size: 12pt;
  }

  .signatures {
    display: flex;
    gap: 6mm;
    margin-top: 12mm;
  }

  .signature-block {
    flex: 1;
    text-align: center;
  }

  .signature-line {
    border-top: 0.6pt solid #000;
    min-height: 28mm;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    padding: 3mm;
  }

  .sign-caption {
    margin-top: 2mm;
    text-transform: uppercase;
    font-weight: 700;
    letter-spacing: 0.05em;
  }

  .annexure-host {
    width: 210mm;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
  }

  .paper {
    width: 210mm;
  }

  .annexure-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 6mm;
  }

  .annexure-card {
    border: 0.6pt solid #000;
    padding: 3mm;
    display: flex;
    flex-direction: column;
    gap: 3mm;
  }

  .media-frame {
    border: 0.6pt solid #000;
    min-height: 48mm;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 3mm;
  }

  .media-frame img {
    max-width: 100%;
    max-height: 100%;
    display: block;
  }

  .volunteer-table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
  }

  .volunteer-table th,
  .volunteer-table td {
    border: 0.6pt solid #000;
    padding: 2.4mm 2mm;
    vertical-align: top;
  }

  .volunteer-table th {
    text-transform: uppercase;
    font-weight: 700;
    letter-spacing: 0.03em;
  }

  .page-break {
    break-before: page;
  }

  .hidden {
    display: none !important;
  }

  .edit-input,
  .edit-textarea {
    width: 100%;
    box-sizing: border-box;
    font-family: "Times New Roman", Times, serif;
    font-size: 12pt;
    line-height: 1.45;
    border: 0.6pt solid #7a7a7a;
    padding: 2mm;
  }

  .edit-textarea {
    min-height: 24mm;
    resize: vertical;
  }

  @media print {
    body.command-center-layout {
      background: #fff;
    }

    .top-utility-bar,
    .left-control-panel {
      display: none !important;
    }

    .control-row,
    .status-pill,
    .controls,
    .preview-shell > .control-row {
      display: none !important;
    }

    main#report,
    .paper {
      box-shadow: none;
      margin: 0;
    }

    .print-footer {
      position: fixed;
      left: 18mm;
      right: 18mm;
      bottom: 10mm;
      display: flex;
      justify-content: space-between;
      font-size: 10pt;
    }

    .print-footer .page-count::after {
      content: "Page " counter(page) " of " counter(pages);
    }
  }

  @media screen {
    .print-footer {
      display: none;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="preview-shell">
  <div class="control-row">
    <span class="status-pill" id="status-pill">Preparing content…</span>
    <div class="controls">
      <button type="button" id="edit-toggle" data-mode="preview">Edit</button>
      <button type="button" id="print-btn">Print / Save PDF</button>
    </div>
  </div>

  <main id="report" class="paper">
    <header class="report-header">
      <p class="hdr-line hdr-upper">CHRIST (DEEMED TO BE UNIVERSITY)</p>
      <p class="hdr-line hdr-italic">Pune Lavasa Campus – 'The Hub of Analytics'</p>
      <p class="hdr-line hdr-upper">Internal Quality Assurance Cell (IQAC)</p>
      <p class="hdr-line hdr-event" data-field="event.title">—</p>
      <p class="hdr-line hdr-title">Activity Report</p>
    </header>

    <hr class="header-rule">

    <section class="section-block">
      <h2 class="section-title">Event Information</h2>
      <table class="grid-table four-col">
        <colgroup>
          <col class="col-label">
          <col class="col-value">
          <col class="col-label">
          <col class="col-value">
        </colgroup>
        <tbody>
          <tr>
            <th>Department</th>
            <td data-field="event.department">—</td>
            <th>Location</th>
            <td data-field="event.location">—</td>
          </tr>
          <tr>
            <th>Event Title</th>
            <td data-field="event.title">—</td>
            <th>No. of Activities</th>
            <td data-field="event.no_of_activities">—</td>
          </tr>
          <tr>
            <th>Date</th>
            <td data-field="event.date">—</td>
            <th>Time Window</th>
            <td data-field="event.time_window">—</td>
          </tr>
          <tr>
            <th>Venue</th>
            <td data-field="event.venue">—</td>
            <th>Academic Year</th>
            <td data-field="event.academic_year">—</td>
          </tr>
          <tr>
            <th>Event Type &amp; Focus</th>
            <td data-field="event.event_type_focus">—</td>
            <th>Blog Link</th>
            <td><a data-field="event.blog_link" data-kind="link">—</a></td>
          </tr>
        </tbody>
      </table>
    </section>

    <section class="section-block">
      <h2 class="section-title">Participants Information</h2>
      <table class="grid-table four-col">
        <colgroup>
          <col class="col-label">
          <col class="col-value">
          <col class="col-label">
          <col class="col-value">
        </colgroup>
        <tbody>
          <tr>
            <th>Target Audience</th>
            <td data-field="participants.target_audience">—</td>
            <th>External Agencies / Speakers</th>
            <td data-field="participants.external_agencies_speakers">—</td>
          </tr>
          <tr>
            <th>External Contacts</th>
            <td data-field="participants.external_contacts">—</td>
            <th>Student Volunteers Count</th>
            <td data-field="participants.organising_committee.student_volunteers_count">—</td>
          </tr>
          <tr>
            <th>Attendees Count</th>
            <td data-field="participants.attendees_count">—</td>
            <th>Event Coordinators</th>
            <td>
              <ul class="cell-ul" data-list="participants.organising_committee.event_coordinators"></ul>
            </td>
          </tr>
        </tbody>
      </table>
    </section>

    <section class="section-block">
      <h2 class="section-title">Summary of the Overall Event</h2>
      <div class="summary-box cell-para" data-field="narrative.summary_overall_event" data-edit="textarea">—</div>
    </section>

    <section id="dynamic-sections"></section>

    <section class="signatures">
      <div class="signature-block">
        <div class="signature-line"><span data-field="iqac.sign_head_coordinator">—</span></div>
        <div class="sign-caption">Head / Coordinator</div>
      </div>
      <div class="signature-block">
        <div class="signature-line"><span data-field="iqac.sign_faculty_coordinator">—</span></div>
        <div class="sign-caption">Faculty Coordinator / Organiser</div>
      </div>
      <div class="signature-block">
        <div class="signature-line"><span data-field="iqac.sign_iqac">—</span></div>
        <div class="sign-caption">IQAC</div>
      </div>
    </section>
  </main>

  <div id="annexures" class="annexure-host"></div>

  <footer class="print-footer">
    <div>CHRIST (Deemed to be University), Pune Lavasa Campus – 30 Valor Court, Pune 412112, Maharashtra</div>
    <div class="page-count"></div>
  </footer>
</div>

<script type="application/json" id="initial-report-data">{{ initial_report_data|default:"{}"|safe }}</script>
<script>
  (function () {
    const state = {
      data: {},
      mode: 'preview'
    };

    const editState = {
      fields: [],
      lists: []
    };

    const CHECKLIST_LABELS = {
      facing_sheet_present: 'Facing Sheet',
      summary_outcomes_sheet_present: 'Summary & Outcomes Sheet',
      suggestions_sheet_present: 'Suggestions Sheet',
      department_seal_sign_each_page: 'Department Seal & Signature on Each Page',
      detailed_report_or_blog_printout_present: 'Detailed Report / Blog Printout',
      participant_list_present: 'Participant List',
      feedback_forms_present: 'Feedback Forms',
      photos_present: 'Photographs'
    };

    const CHECKLIST_ORDER = [
      'facing_sheet_present',
      'summary_outcomes_sheet_present',
      'suggestions_sheet_present',
      'department_seal_sign_each_page',
      'detailed_report_or_blog_printout_present',
      'participant_list_present',
      'feedback_forms_present',
      'photos_present'
    ];

    function isBlank(value) {
      if (value === null || value === undefined) return true;
      if (Array.isArray(value)) return value.every(isBlank);
      const str = String(value).trim();
      return str.length === 0;
    }

    function toArray(value) {
      if (!value && value !== 0) return [];
      if (Array.isArray(value)) {
        return value
          .map(item => (typeof item === 'string' ? item.trim() : item))
          .filter(item => !isBlank(item));
      }
      if (typeof value === 'string') {
        return value
          .split(/[\n;,]+/)
          .map(item => item.trim())
          .filter(item => item);
      }
      return [];
    }

    function getValue(obj, path) {
      if (!obj || !path) return undefined;
      return path.split('.').reduce((acc, key) => {
        if (acc === null || acc === undefined) return undefined;
        return acc[key];
      }, obj);
    }

    function setValue(obj, path, value) {
      if (!path) return;
      const parts = path.split('.');
      let ref = obj;
      parts.forEach((part, index) => {
        if (index === parts.length - 1) {
          ref[part] = value;
        } else {
          if (typeof ref[part] !== 'object' || ref[part] === null) {
            ref[part] = {};
          }
          ref = ref[part];
        }
      });
    }

    function resolveNodes(selectorOrNodes) {
      if (!selectorOrNodes) return [];
      if (typeof selectorOrNodes === 'string') {
        return Array.from(document.querySelectorAll(selectorOrNodes));
      }
      if (selectorOrNodes instanceof Node) {
        return [selectorOrNodes];
      }
      if (selectorOrNodes instanceof NodeList || Array.isArray(selectorOrNodes)) {
        return Array.from(selectorOrNodes);
      }
      return [];
    }

    function displayValue(value) {
      if (value === null || value === undefined) return '—';
      const str = String(value).trim();
      return str === '' ? '—' : str;
    }

    function setText(selector, value) {
      const nodes = resolveNodes(selector);
      if (!nodes.length) return;
      const content = displayValue(value);
      nodes.forEach(node => {
        if (node.dataset && node.dataset.kind === 'link' && node.tagName === 'A') {
          node.textContent = content;
          if (content === '—') {
            node.removeAttribute('href');
          } else {
            node.setAttribute('href', String(value));
            node.setAttribute('target', '_blank');
            node.setAttribute('rel', 'noopener');
          }
        } else {
          node.textContent = content;
        }
      });
    }

    function setList(selector, arr) {
      const nodes = resolveNodes(selector);
      const values = toArray(arr);
      nodes.forEach(node => {
        node.innerHTML = '';
        if (!values.length) {
          if (node.tagName === 'UL' || node.tagName === 'OL') {
            node.dataset.empty = 'true';
            const li = document.createElement('li');
            li.textContent = '—';
            node.appendChild(li);
          } else {
            node.textContent = '—';
          }
          return;
        }
        if (node.tagName === 'UL' || node.tagName === 'OL') {
          delete node.dataset.empty;
          values.forEach(item => {
            const li = document.createElement('li');
            li.textContent = String(item);
            node.appendChild(li);
          });
        } else {
          node.textContent = values.join(', ');
        }
      });
    }

    function setChips(selector, arr) {
      const nodes = resolveNodes(selector);
      const values = toArray(arr);
      nodes.forEach(node => {
        if (!values.length) {
          const section = node.closest('.section-block');
          if (section) section.remove();
          return;
        }
        node.innerHTML = '';
        values.forEach(item => {
          const span = document.createElement('span');
          span.className = 'chip';
          span.textContent = String(item);
          node.appendChild(span);
        });
      });
    }

    function normalizeMediaItem(item) {
      if (!item) return null;
      if (typeof item === 'string') {
        return { src: item, caption: '' };
      }
      if (typeof item === 'object') {
        return {
          src: item.src || item.url || '',
          caption: item.caption || item.title || ''
        };
      }
      return null;
    }

    function setGrid(selector, items) {
      const nodes = resolveNodes(selector);
      const list = Array.isArray(items)
        ? items.map(normalizeMediaItem).filter(entry => entry && !isBlank(entry.src))
        : [];
      nodes.forEach(node => {
        node.innerHTML = '';
        if (!list.length) return;
        list.forEach(entry => {
          const figure = document.createElement('figure');
          figure.className = 'annexure-card';
          const frame = document.createElement('div');
          frame.className = 'media-frame';
          const img = document.createElement('img');
          img.src = entry.src;
          img.alt = entry.caption || 'Annexure Image';
          frame.appendChild(img);
          const caption = document.createElement('figcaption');
          caption.textContent = displayValue(entry.caption);
          figure.appendChild(frame);
          figure.appendChild(caption);
          node.appendChild(figure);
        });
      });
    }

    function setRows(selector, rows) {
      const nodes = resolveNodes(selector);
      nodes.forEach(node => {
        const type = node.getAttribute('data-row-type') || '';
        node.innerHTML = '';
        if (!Array.isArray(rows) || !rows.length) {
          const table = node.closest('table');
          const colCount = table ? (table.querySelectorAll('col').length || table.querySelectorAll('th').length || 1) : 1;
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = colCount;
          td.textContent = '—';
          td.style.textAlign = 'center';
          tr.appendChild(td);
          node.appendChild(tr);
          return;
        }
        if (type === 'volunteers') {
          rows.forEach((row, index) => {
            const tr = document.createElement('tr');
            const sl = row.sl ?? row.sl_no ?? row.serial ?? row.index ?? index + 1;
            const reg = row.reg ?? row.reg_no ?? row.registration_number ?? row.id ?? '';
            const name = row.name ?? row.full_name ?? row.participant ?? '';
            const className = row.class ?? row.class_ ?? row.program ?? row.section ?? '';
            const role = row.role ?? row.responsibility ?? row.duty ?? '';
            [sl, reg, name, className, role].forEach(value => {
              const td = document.createElement('td');
              td.textContent = displayValue(value);
              tr.appendChild(td);
            });
            node.appendChild(tr);
          });
        } else if (type === 'courses') {
          rows.forEach(row => {
            const tr = document.createElement('tr');
            const code = row.course_code ?? row.code ?? '';
            const name = row.course_name ?? row.name ?? '';
            const mappingType = row.mapping_type ?? row.type ?? '';
            const note = row.note ?? row.remark ?? row.remarks ?? '';
            [code, name, mappingType, note].forEach(value => {
              const td = document.createElement('td');
              td.textContent = displayValue(value);
              tr.appendChild(td);
            });
            node.appendChild(tr);
          });
        } else {
          rows.forEach(row => {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.textContent = displayValue(row);
            tr.appendChild(td);
            node.appendChild(tr);
          });
        }
      });
    }

    function setSingle(selector, item) {
      const nodes = resolveNodes(selector);
      const entry = normalizeMediaItem(item);
      nodes.forEach(node => {
        const frame = node.querySelector('.media-frame');
        const caption = node.querySelector('figcaption');
        if (!frame) return;
        frame.innerHTML = '';
        if (entry && entry.src) {
          const img = document.createElement('img');
          img.src = entry.src;
          img.alt = entry.caption || 'Annexure Image';
          frame.appendChild(img);
        }
        if (caption) {
          caption.textContent = displayValue(entry && entry.caption ? entry.caption : '');
        }
      });
    }

    function resolveTarget(target) {
      if (!target) return document.getElementById('dynamic-sections');
      if (typeof target === 'string') {
        return document.querySelector(target);
      }
      return target;
    }

    function addSection(title, html, opts) {
      const options = opts || {};
      const container = resolveTarget(options.target);
      if (!container) return null;
      const section = document.createElement('section');
      section.className = 'section-block';
      if (options.classes) {
        options.classes.split(/\s+/).filter(Boolean).forEach(cls => section.classList.add(cls));
      }
      if (options.pageBreak) {
        section.classList.add('page-break');
      }
      const heading = document.createElement('h2');
      heading.className = 'section-title';
      heading.textContent = title;
      section.appendChild(heading);
      if (html instanceof Node) {
        section.appendChild(html);
      } else if (html) {
        const template = document.createElement('template');
        template.innerHTML = html;
        section.appendChild(template.content.cloneNode(true));
      }
      container.appendChild(section);
      return section;
    }

    function renderChecklist(data) {
      if (!data || typeof data !== 'object') return null;
      const keys = [];
      CHECKLIST_ORDER.forEach(key => {
        if (Object.prototype.hasOwnProperty.call(data, key)) {
          keys.push(key);
        }
      });
      Object.keys(data).forEach(key => {
        if (!keys.includes(key)) keys.push(key);
      });
      if (!keys.length) return null;
      const table = document.createElement('table');
      table.className = 'checklist';
      const colgroup = document.createElement('colgroup');
      const colTick = document.createElement('col');
      colTick.className = 'c-tick';
      const colLabel = document.createElement('col');
      colgroup.appendChild(colTick);
      colgroup.appendChild(colLabel);
      table.appendChild(colgroup);
      const tbody = document.createElement('tbody');
      keys.forEach(key => {
        const tr = document.createElement('tr');
        const tickCell = document.createElement('td');
        const tick = document.createElement('span');
        tick.className = 'tick';
        tick.textContent = data[key] ? '☑' : '▢';
        tickCell.appendChild(tick);
        const labelCell = document.createElement('td');
        const label = CHECKLIST_LABELS[key] || key.replace(/[_-]+/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        labelCell.textContent = label;
        tr.appendChild(tickCell);
        tr.appendChild(labelCell);
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      return table;
    }

    function createAnnexureArticle() {
      const host = document.getElementById('annexures');
      if (!host) return null;
      const article = document.createElement('article');
      article.className = 'paper page-break';
      host.appendChild(article);
      return article;
    }

    function generateDynamicSections(data) {
      const dynamic = document.getElementById('dynamic-sections');
      const annexureHost = document.getElementById('annexures');
      if (dynamic) dynamic.innerHTML = '';
      if (annexureHost) annexureHost.innerHTML = '';
      if (!dynamic) return;

      const outcomes = toArray(getValue(data, 'narrative.outcomes'));
      if (outcomes.length) {
        addSection('Outcomes', '<ul class="cell-ul" data-list="narrative.outcomes"></ul>');
        setList('#dynamic-sections [data-list="narrative.outcomes"]', outcomes);
      }

      const analysisItems = [
        { key: 'analysis.impact_attendees', label: 'Impact on Attendees', value: getValue(data, 'analysis.impact_attendees') },
        { key: 'analysis.impact_schools', label: 'Impact on Schools', value: getValue(data, 'analysis.impact_schools') },
        { key: 'analysis.impact_volunteers', label: 'Impact on Volunteers', value: getValue(data, 'analysis.impact_volunteers') }
      ].filter(item => !isBlank(item.value));

      if (analysisItems.length) {
        const html = '<div class="analysis-grid">' + analysisItems.map(item => (
          '<div class="analysis-box">' +
            '<div class="analysis-label">' + item.label + '</div>' +
            '<p class="cell-para" data-field="' + item.key + '" data-edit="textarea">—</p>' +
          '</div>'
        )).join('') + '</div>';
        addSection('Analysis', html);
        analysisItems.forEach(item => setText('[data-field="' + item.key + '"]', item.value));
      }

      const mappingEntries = [
        { key: 'mapping.pos_psos', label: 'POS / PSOs', value: getValue(data, 'mapping.pos_psos') },
        { key: 'mapping.graduate_attributes_or_needs', label: 'Graduate Attributes / Needs', value: getValue(data, 'mapping.graduate_attributes_or_needs') },
        { key: 'mapping.contemporary_requirements', label: 'Contemporary Requirements', value: getValue(data, 'mapping.contemporary_requirements') },
        { key: 'mapping.value_systems', label: 'Value Systems', value: getValue(data, 'mapping.value_systems') }
      ].filter(item => !isBlank(item.value));
      const sdgNumbers = toArray(getValue(data, 'mapping.sdg_goal_numbers'));
      const coursesRaw = getValue(data, 'mapping.courses');
      const courseRows = Array.isArray(coursesRaw) ? coursesRaw.filter(Boolean) : [];

      if (mappingEntries.length || sdgNumbers.length || courseRows.length) {
        let html = '';
        if (mappingEntries.length) {
          html += '<table class="grid-table two-col"><colgroup><col class="col-label"><col class="col-value"></colgroup><tbody>';
          html += mappingEntries.map(item => (
            '<tr><th>' + item.label + '</th><td><p class="cell-para" data-field="' + item.key + '" data-edit="textarea">—</p></td></tr>'
          )).join('');
          html += '</tbody></table>';
        }
        if (sdgNumbers.length) {
          html += '<div class="sdg-row"><div class="sdg-label">SDG Goal Numbers</div><div class="sdg-values"><ul class="cell-ul sdg-list" data-list="mapping.sdg_goal_numbers"></ul></div></div>';
        }
        if (courseRows.length) {
          html += '<table class="grid-table course-table" style="margin-top:4mm;"><colgroup><col class="col-code"><col class="col-name"><col class="col-type"><col class="col-note"></colgroup><thead><tr><th>Course Code</th><th>Course Name</th><th>Mapping Type</th><th>Note</th></tr></thead><tbody data-rows="mapping.courses" data-row-type="courses"></tbody></table>';
        }
        addSection('Relevance / Academic Mapping', html);
        mappingEntries.forEach(item => setText('[data-field="' + item.key + '"]', item.value));
        if (sdgNumbers.length) setList('#dynamic-sections [data-list="mapping.sdg_goal_numbers"]', sdgNumbers);
        if (courseRows.length) setRows('#dynamic-sections [data-rows="mapping.courses"]', courseRows);
      }

      const metrics = toArray(getValue(data, 'metrics'));
      if (metrics.length) {
        addSection('NAAC Metrics Tags', '<div class="chips" data-chips="metrics"></div>');
        setChips('#dynamic-sections [data-chips="metrics"]', metrics);
      }

      const suggestions = toArray(getValue(data, 'iqac.iqac_suggestions'));
      const reviewDate = getValue(data, 'iqac.iqac_review_date');
      if (suggestions.length || !isBlank(reviewDate)) {
        let html = '<ul class="cell-ul" data-list="iqac.iqac_suggestions"></ul>';
        if (!isBlank(reviewDate)) {
          html += '<div class="review-date">Review Date: <span data-field="iqac.iqac_review_date">—</span></div>';
        }
        addSection('Suggestions for Improvement / Feedback from IQAC', html);
        setList('#dynamic-sections [data-list="iqac.iqac_suggestions"]', suggestions);
        if (!isBlank(reviewDate)) setText('#dynamic-sections [data-field="iqac.iqac_review_date"]', reviewDate);
      }

      const checklistData = getValue(data, 'attachments.checklist');
      if (checklistData && typeof checklistData === 'object' && Object.keys(checklistData).length) {
        const table = renderChecklist(checklistData);
        if (table) {
          addSection('Attachments Checklist', table);
        }
      }

      const annexures = data.annexures || {};
      const photos = Array.isArray(annexures.photos) ? annexures.photos : [];
      const photoEntries = photos.map(normalizeMediaItem).filter(entry => entry && entry.src);
      if (photoEntries.length) {
        const article = createAnnexureArticle();
        if (article) {
          addSection('Annexure A: Photographs', '<div class="annexure-grid" data-grid="annexures.photos"></div>', { target: article });
          setGrid('#annexures [data-grid="annexures.photos"]', photoEntries);
        }
      }

      const brochure = Array.isArray(annexures.brochure_pages) ? annexures.brochure_pages : [];
      const brochureEntries = brochure.map(normalizeMediaItem).filter(entry => entry && entry.src);
      if (brochureEntries.length) {
        const article = createAnnexureArticle();
        if (article) {
          addSection('Annexure B: Brochure', '<div class="annexure-grid" data-grid="annexures.brochure_pages"></div>', { target: article });
          setGrid('#annexures [data-grid="annexures.brochure_pages"]', brochureEntries);
        }
      }

      const communication = annexures.communication || {};
      const volunteers = Array.isArray(communication.volunteers) ? communication.volunteers : [];
      if (!isBlank(communication.subject) || !isBlank(communication.date) || volunteers.length) {
        const article = createAnnexureArticle();
        if (article) {
          const html = '<table class="grid-table two-col"><colgroup><col class="col-label"><col class="col-value"></colgroup><tbody>' +
            '<tr><th>Subject</th><td data-field="annexures.communication.subject">—</td></tr>' +
            '<tr><th>Date</th><td data-field="annexures.communication.date">—</td></tr>' +
          '</tbody></table>' +
          '<table class="volunteer-table" style="margin-top:4mm;"><colgroup><col style="width:10%"><col style="width:20%"><col style="width:30%"><col style="width:20%"><col style="width:20%"></colgroup><thead><tr><th>Sl No</th><th>Reg No</th><th>Name</th><th>Class</th><th>Role</th></tr></thead><tbody data-rows="annexures.communication.volunteers" data-row-type="volunteers"></tbody></table>';
          addSection('Annexure C: Communication with Institution', html, { target: article });
          setText('#annexures [data-field="annexures.communication.subject"]', communication.subject);
          setText('#annexures [data-field="annexures.communication.date"]', communication.date);
          setRows('#annexures [data-rows="annexures.communication.volunteers"]', volunteers);
        }
      }

      const worksheets = Array.isArray(annexures.worksheets) ? annexures.worksheets : [];
      const worksheetEntries = worksheets.map(normalizeMediaItem).filter(entry => entry && entry.src);
      if (worksheetEntries.length) {
        const article = createAnnexureArticle();
        if (article) {
          addSection('Annexure D: Worksheets / Activities', '<div class="annexure-grid" data-grid="annexures.worksheets"></div>', { target: article });
          setGrid('#annexures [data-grid="annexures.worksheets"]', worksheetEntries);
        }
      }

      const evaluationSheet = normalizeMediaItem(annexures.evaluation_sheet);
      if (evaluationSheet && evaluationSheet.src) {
        const article = createAnnexureArticle();
        if (article) {
          addSection('Annexure E: Evaluation Sheet', '<figure class="annexure-card" data-single="annexures.evaluation_sheet"><div class="media-frame"></div><figcaption>—</figcaption></figure>', { target: article });
          setSingle('#annexures [data-single="annexures.evaluation_sheet"]', evaluationSheet);
        }
      }

      const feedbackForm = normalizeMediaItem(annexures.feedback_form);
      if (feedbackForm && feedbackForm.src) {
        const article = createAnnexureArticle();
        if (article) {
          addSection('Annexure F: Feedback Form', '<figure class="annexure-card" data-single="annexures.feedback_form"><div class="media-frame"></div><figcaption>—</figcaption></figure>', { target: article });
          setSingle('#annexures [data-single="annexures.feedback_form"]', feedbackForm);
        }
      }
    }

    function populateStaticFields(data) {
      const fieldMap = [
        { selector: '[data-field="event.title"]', path: 'event.title' },
        { selector: '[data-field="event.department"]', path: 'event.department' },
        { selector: '[data-field="event.location"]', path: 'event.location' },
        { selector: '[data-field="event.no_of_activities"]', path: 'event.no_of_activities' },
        { selector: '[data-field="event.date"]', path: 'event.date' },
        { selector: '[data-field="event.time_window"]', path: 'event.time_window' },
        { selector: '[data-field="event.venue"]', path: 'event.venue' },
        { selector: '[data-field="event.academic_year"]', path: 'event.academic_year' },
        { selector: '[data-field="event.event_type_focus"]', path: 'event.event_type_focus' },
        { selector: '[data-field="event.blog_link"]', path: 'event.blog_link' },
        { selector: '[data-field="participants.target_audience"]', path: 'participants.target_audience' },
        { selector: '[data-field="participants.external_agencies_speakers"]', path: 'participants.external_agencies_speakers' },
        { selector: '[data-field="participants.external_contacts"]', path: 'participants.external_contacts' },
        { selector: '[data-field="participants.organising_committee.student_volunteers_count"]', path: 'participants.organising_committee.student_volunteers_count' },
        { selector: '[data-field="participants.attendees_count"]', path: 'participants.attendees_count' },
        { selector: '[data-field="narrative.summary_overall_event"]', path: 'narrative.summary_overall_event' },
        { selector: '[data-field="iqac.sign_head_coordinator"]', path: 'iqac.sign_head_coordinator' },
        { selector: '[data-field="iqac.sign_faculty_coordinator"]', path: 'iqac.sign_faculty_coordinator' },
        { selector: '[data-field="iqac.sign_iqac"]', path: 'iqac.sign_iqac' }
      ];
      fieldMap.forEach(item => setText(item.selector, getValue(data, item.path)));
      setList('[data-list="participants.organising_committee.event_coordinators"]', getValue(data, 'participants.organising_committee.event_coordinators'));
    }

    function renderReport() {
      populateStaticFields(state.data);
      generateDynamicSections(state.data);
      const status = document.getElementById('status-pill');
      if (status) status.classList.add('hidden');
    }

    function enterEdit() {
      if (state.mode === 'edit') return;
      editState.fields = [];
      editState.lists = [];
      document.querySelectorAll('[data-field]').forEach(node => {
        const path = node.getAttribute('data-field');
        if (!path) return;
        if (node.dataset.editing === 'true') return;
        const multiline = node.dataset.edit === 'textarea';
        const input = multiline ? document.createElement('textarea') : document.createElement('input');
        input.className = multiline ? 'edit-textarea' : 'edit-input';
        if (!multiline) input.type = 'text';
        const currentValue = getValue(state.data, path);
        if (!isBlank(currentValue)) {
          input.value = Array.isArray(currentValue) ? currentValue.join(', ') : String(currentValue);
        } else {
          input.value = '';
        }
        node.dataset.editing = 'true';
        node.innerHTML = '';
        node.appendChild(input);
        editState.fields.push({ node, path, input, multiline });
      });
      document.querySelectorAll('[data-list]').forEach(node => {
        const path = node.getAttribute('data-list');
        if (!path) return;
        if (node.dataset.editing === 'true') return;
        const textarea = document.createElement('textarea');
        textarea.className = 'edit-textarea';
        textarea.value = toArray(getValue(state.data, path)).join('\n');
        node.dataset.editing = 'true';
        node.innerHTML = '';
        node.appendChild(textarea);
        editState.lists.push({ node, path, textarea });
      });
      state.mode = 'edit';
    }

    function exitEdit() {
      editState.fields.forEach(entry => {
        const value = entry.input.value.trim();
        setValue(state.data, entry.path, value);
        entry.node.removeAttribute('data-editing');
        entry.node.innerHTML = '';
      });
      editState.lists.forEach(entry => {
        const raw = entry.textarea.value.replace(/\r/g, '\n');
        const items = toArray(raw);
        setValue(state.data, entry.path, items);
        entry.node.removeAttribute('data-editing');
        entry.node.innerHTML = '';
      });
      editState.fields = [];
      editState.lists = [];
      state.mode = 'preview';
      renderReport();
    }

    function attachEvents() {
      const toggle = document.getElementById('edit-toggle');
      const printBtn = document.getElementById('print-btn');
      if (toggle) {
        toggle.addEventListener('click', function () {
          if (state.mode === 'preview') {
            enterEdit();
            toggle.textContent = 'Preview';
          } else {
            exitEdit();
            toggle.textContent = 'Edit';
          }
        });
      }
      if (printBtn) {
        printBtn.addEventListener('click', function () {
          if (state.mode === 'edit') {
            exitEdit();
            const toggleBtn = document.getElementById('edit-toggle');
            if (toggleBtn) toggleBtn.textContent = 'Edit';
          }
          window.print();
        });
      }
    }

    function init() {
      const raw = document.getElementById('initial-report-data');
      let data = {};
      if (raw && raw.textContent.trim()) {
        try {
          data = JSON.parse(raw.textContent);
        } catch (err) {
          console.warn('Unable to parse initial report data', err);
        }
      }
      if (!data || typeof data !== 'object') {
        data = {};
      }
      state.data = data;
      renderReport();
      attachEvents();
    }

    document.addEventListener('DOMContentLoaded', function () {
      document.body.classList.add('iqac-report-preview');
      init();
    });
  })();
</script>
{% endblock %}
