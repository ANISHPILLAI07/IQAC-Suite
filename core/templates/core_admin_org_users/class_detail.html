{% extends "base.html" %}
{% load static %}

{% block title %}{{ cls.name }}: {{ org.name }}{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="{% static 'core/css/admin_user_management.css' %}?v=2.0">
  <style>
    /* Class detail specific styles */
    .class-detail-container {
      padding: 1rem;
      max-width: 100%;
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      min-height: calc(100vh - 60px);
      width: 100%;
    }
    
    .class-header-card {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      padding: 1.5rem;
      border-radius: var(--border-radius);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .class-info {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .class-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0;
    }
    
    .class-meta {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
      opacity: 0.9;
    }
    
    .meta-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }
    
    .class-actions {
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }
    
    .action-btn {
      background: rgba(255, 255, 255, 0.15);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 0.5rem 1rem;
      border-radius: var(--border-radius);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .action-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      color: white;
      text-decoration: none;
    }
    
    .action-btn.btn-archive {
      background: rgba(255, 193, 7, 0.2);
      border-color: rgba(255, 193, 7, 0.5);
    }
    
    .action-btn.btn-activate {
      background: rgba(40, 167, 69, 0.2);
      border-color: rgba(40, 167, 69, 0.5);
    }
    
    .students-section {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: calc(100vh - 200px);
    }
    
    .section-header {
      background: var(--light-grey);
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--medium-grey);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .section-title {
      font-weight: 600;
      color: var(--text-color);
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .student-count {
      background: var(--primary-color);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .section-content {
      flex: 1;
      overflow-y: auto;
      padding: 0;
    }
    
    .students-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }
    
    .students-table th,
    .students-table td {
      text-align: left;
      padding: 1rem;
      border-bottom: 1px solid var(--light-grey);
    }
    
    .students-table th {
      background: var(--light-grey);
      font-weight: 600;
      color: var(--dark-grey);
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .students-table tbody tr {
      transition: background-color 0.2s;
    }
    
    .students-table tbody tr:hover {
      background: var(--light-grey);
    }
    
    .student-actions {
      display: flex;
      gap: 0.375rem;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .student-actions .btn {
      padding: 0.375rem 0.75rem;
      font-size: 0.75rem;
      border-radius: 4px;
    }
    
    .empty-students {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--dark-grey);
    }
    
    .empty-students .empty-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.3;
    }
    
    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      color: white;
      display: inline-block;
    }
    
    .status-active { 
      background-color: var(--success-color); 
    }
    
    .status-inactive { 
      background-color: var(--danger-color); 
    }
    
    @media (max-width: 768px) {
      .class-detail-container {
        padding: 0.75rem;
      }
      
      .class-header-card {
        padding: 1rem;
        flex-direction: column;
        align-items: flex-start;
      }
      
      .class-actions {
        width: 100%;
        justify-content: flex-start;
      }
      
      .students-section {
        height: calc(100vh - 180px);
      }
      
      .students-table th,
      .students-table td {
        padding: 0.75rem 0.5rem;
      }
      
      .student-actions {
        flex-direction: column;
        gap: 0.25rem;
        align-items: flex-start;
      }
      
      .student-actions .btn {
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
      }
    }
  </style>
{% endblock %}

{% block content %}
<div class="class-detail-container">

  <!-- Class Header Card -->
  <div class="class-header-card">
    <div class="class-info">
      <h1 class="class-title">{{ cls.name }}: {{ org.name }}</h1>
      <div class="class-meta">
        <div class="meta-item">
          <i class="fas fa-calendar-alt"></i>
          <span>Academic Year: {{ cls.academic_year }}</span>
        </div>
        <div class="meta-item">
          <i class="fas fa-info-circle"></i>
          <span>Status: {% if cls.is_active %}Active{% else %}Archived{% endif %}</span>
        </div>
        <div class="meta-item">
          <i class="fas fa-users"></i>
          <span>{{ students|length }} Student{{ students|length|pluralize }}</span>
        </div>
      </div>
    </div>
    
    <div class="class-actions">
      <a href="{% url 'admin_org_users_select_role' org.id %}" class="action-btn">
        <i class="fas fa-arrow-left"></i>
        Back to Management
      </a>
      
      <form method="post" action="{% url 'admin_org_users_class_toggle' org.id cls.id %}" style="display: inline;">
        {% csrf_token %}
        <button type="submit" class="action-btn {% if cls.is_active %}btn-archive{% else %}btn-activate{% endif %}">
          <i class="fas fa-{% if cls.is_active %}archive{% else %}check{% endif %}"></i>
          {% if cls.is_active %}Archive Class{% else %}Activate Class{% endif %}
        </button>
      </form>
    </div>
  </div>

  <!-- Students Section -->
  <div class="students-section">
    <div class="section-header">
      <h3 class="section-title">
        <i class="fas fa-graduation-cap"></i>
        Students
        {% if students %}
          <span class="student-count">{{ students|length }}</span>
        {% endif %}
      </h3>
    </div>
    
    <div class="section-content">
      {% if students %}
        <table class="students-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for student in students %}
            <tr>
              <td>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <i class="fas fa-user-circle" style="color: var(--primary-color);"></i>
                  <strong>{{ student.user.get_full_name|default:student.user.username }}</strong>
                </div>
              </td>
              <td>
                <a href="mailto:{{ student.user.email }}" style="color: var(--primary-color); text-decoration: none;">
                  {{ student.user.email }}
                </a>
              </td>
              <td>
                <span class="status-badge status-{% if student.user.is_active %}active{% else %}inactive{% endif %}">
                  {% if student.user.is_active %}Active{% else %}Inactive{% endif %}
                </span>
              </td>
              <td>
                <div class="student-actions">
                  {% if student.user.is_active %}
                  <form method="post" action="{% url 'admin_user_deactivate' student.user.id %}" style="display:inline;">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{% url 'admin_org_users_class_detail' org.id cls.id %}">
                    <button class="btn btn-warning btn-sm" type="submit" title="Deactivate User">
                      <i class="fas fa-user-slash"></i>
                      Deactivate
                    </button>
                  </form>
                  {% else %}
                  <form method="post" action="{% url 'admin_user_activate' student.user.id %}" style="display:inline;">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{% url 'admin_org_users_class_detail' org.id cls.id %}">
                    <button class="btn btn-success btn-sm" type="submit" title="Activate User">
                      <i class="fas fa-user-check"></i>
                      Activate
                    </button>
                  </form>
                  {% endif %}
                  
                  <a class="btn btn-secondary btn-sm" 
                     href="{% url 'admin_user_edit' student.user.id %}?next={% url 'admin_org_users_class_detail' org.id cls.id %}"
                     title="Edit User">
                    <i class="fas fa-edit"></i>
                    Edit
                  </a>
                  
                  <form method="post" action="{% url 'admin_org_users_class_remove_student' org.id cls.id student.id %}" 
                        style="display:inline;"
                        onsubmit="return confirm('Are you sure you want to remove this student from the class?');">
                    {% csrf_token %}
                    <button class="btn btn-danger btn-sm" type="submit" title="Remove from Class">
                      <i class="fas fa-trash"></i>
                      Remove
                    </button>
                  </form>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="empty-students">
          <div class="empty-icon">
            <i class="fas fa-user-graduate"></i>
          </div>
          <h4>No Students Assigned</h4>
          <p>This class doesn't have any students yet. Students will appear here after uploading via CSV.</p>
        </div>
      {% endif %}
    </div>
  </div>

</div>

<!-- Toast Notification Container -->
<div id="toast-notification" class="toast"></div>
{% endblock %}

{% block scripts %}
<script>
  // Add loading states and interactions
  document.addEventListener('DOMContentLoaded', function() {
    // Add loading states to buttons
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
      form.addEventListener('submit', function() {
        const btn = this.querySelector('button[type="submit"]');
        if (btn && !btn.disabled) {
          const originalText = btn.innerHTML;
          btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
          btn.disabled = true;
          
          // Re-enable after a delay if form doesn't redirect
          setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
          }, 5000);
        }
      });
    });
    
    // Show success message if redirected after operation
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success')) {
      showToast('Operation completed successfully!', 'success');
    }
  });
  
  function showToast(message, type = 'info') {
    const toast = document.getElementById('toast-notification') || createToastElement();
    
    toast.textContent = message;
    toast.className = `toast toast-${type} show`;
    
    setTimeout(() => {
      toast.classList.remove('show');
    }, 4000);
  }
  
  function createToastElement() {
    const toast = document.createElement('div');
    toast.id = 'toast-notification';
    toast.className = 'toast';
    document.body.appendChild(toast);
    return toast;
  }
</script>
{% endblock %}
